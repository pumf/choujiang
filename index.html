<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ</title>
    <style>
        /* 
         * å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ - æ ·å¼è¡¨
         * 
         * åŠŸèƒ½ç‰¹ç‚¹ï¼š
         * - 3Dçƒä½“æŠ½å¥–åŠ¨ç”»
         * - æ–¹å—æ»‘åŠ¨æŠ½å¥–æ¨¡å¼
         * - å†å²è®°å½•æŸ¥çœ‹ä¸æ’¤é”€
         * - æŠ½å¥–æš‚åœ/ç»§ç»­åŠŸèƒ½
         * - Toastæç¤ºç³»ç»Ÿ
         * - æ•°æ®å¤‡ä»½æé†’
         * - æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹
         * 
         * æŠ€æœ¯æ ˆï¼šçº¯HTML + CSS + JavaScript (æ— å¤–éƒ¨ä¾èµ–)
         * æ•°æ®å­˜å‚¨ï¼šLocalStorage
         * æµè§ˆå™¨å…¼å®¹ï¼šç°ä»£æµè§ˆå™¨ï¼ˆChrome 60+, Firefox 60+, Safari 12+ï¼‰
         */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            overflow: hidden;
        }

        .toggle-prize-btn {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 80px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border: none;
            border-radius: 0 10px 10px 0;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            z-index: 100;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 3px;
            box-shadow: 5px 0 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        .toggle-prize-btn:hover {
            width: 35px;
            box-shadow: 8px 0 30px rgba(255, 107, 107, 0.6);
        }

        .prize-panel {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(30px);
            padding: 20px;
            z-index: 99;
            transform: translateX(-100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .prize-panel.active {
            transform: translateX(0);
        }

        .prize-panel h2 {
            font-size: 1.3em;
            color: #feca57;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(254, 202, 87, 0.3);
        }

        .prize-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ff6b6b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prize-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .prize-item.active {
            border-left-color: #feca57;
            background: rgba(254, 202, 87, 0.15);
        }

        .prize-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .prize-item.unselectable {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(50%);
        }

        .prize-item .name {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .prize-item .desc {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 6px;
        }

        .prize-item .info {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.6);
        }

        .prize-item .status {
            padding: 2px 8px;
            border-radius: 10px;
            background: linear-gradient(45deg, #1dd1a1, #10ac84);
            font-size: 0.7em;
        }

        .prize-item .status.awarded {
            background: linear-gradient(45deg, #ff6b6b, #ee5a5a);
        }

        .main-content {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 30px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        .people-area {
            flex: 1;
            width: 100%;
            max-width: 1400px;
            padding: 10px 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .people-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(1px, 1fr));
            gap: 0;
            padding: 0;
            overflow: hidden;
            align-content: stretch;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        .title {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #ff6b6b);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientMove 4s ease infinite;
            text-shadow: 0 0 40px rgba(255, 107, 107, 0.3);
            margin-bottom: 10px;
        }

        @keyframes gradientMove {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .people-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            align-content: start;
        }

        .people-grid::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .people-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .people-grid::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .people-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .red-packet { 
            aspect-ratio: 1;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
            position: relative;
            border: none;
        }

        /* 3D flip faces: front/back */
        .red-packet { transform-style: preserve-3d; }
        .red-packet .front { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .front-prize { font-size: 0.8em; color: #fff; margin-bottom: 2px; }
        .front-name { font-size: 0.7em; color: #fff; }
        .front-prize { font-size: 0.8em; color: #fff; }
        .red-packet .face {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            border-radius: inherit;
        }
        .red-packet .front { }
        .red-packet .back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #1e1e1e, #111);
            color: #fff;
            font-size: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .red-packet { transition: transform 0.9s ease; }
        .red-packet.is-flipped { transform: rotateY(180deg); }

        .red-packet::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 45%;
            height: 45%;
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            border-radius: 50%;
        }

        .red-packet::after {
            content: 'ç¦';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            font-weight: bold;
            color: #c0392b;
            z-index: 1;
        }

        .red-packet .name {
            position: absolute;
            bottom: 8%;
            left: 5%;
            right: 5%;
            text-align: center;
            font-size: 0.65em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            z-index: 2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .red-packet:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.6);
        }

        .red-packet.slide-highlight {
            background: linear-gradient(145deg, #f1c40f, #f39c12) !important;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
            transform: scale(1.1);
        }

        .red-packet.won {
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            box-shadow: 0 4px 15px rgba(241, 196, 15, 0.4);
        }

        .red-packet.won::before {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
        }

        .red-packet.won::after {
            content: 'ä¸­';
            color: #fff;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            font-weight: bold;
            z-index: 1;
        }

        .red-packet.won .front {
            position: relative;
        }

        .red-packet.won .won-prize {
            position: absolute;
            top: 8%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.4em;
            color: #c0392b;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
            text-align: center;
            z-index: 2;
        }

        .red-packet.won .won-name {
            position: absolute;
            top: 72%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.45em;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
            text-align: center;
            z-index: 2;
        }

        .lottery-btn {
            padding: 12px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: #fff;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            margin-top: 10px;
        }

        .lottery-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.5);
        }

        .lottery-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .lottery-btn.running {
            background: linear-gradient(45deg, #1dd1a1, #10ac84);
            animation: pulse 0.8s ease infinite alternate;
        }

        @keyframes pulse {
            from { box-shadow: 0 10px 40px rgba(29, 209, 161, 0.4); }
            to { box-shadow: 0 15px 70px rgba(29, 209, 161, 0.7); }
        }

        .settings-btn {
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg) scale(1.1);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .settings-panel.active {
            display: flex;
        }

        .settings-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .settings-content h2 {
            color: #feca57;
            margin-bottom: 25px;
            text-align: center;
        }

        .winner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .winner-modal.active {
            display: flex;
            opacity: 1;
        }

        .winner-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: white;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: bounceIn 0.5s ease;
            position: relative;
        }

        .winner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .winner-header h2 {
            margin: 0;
            flex: 1;
        }

        .winner-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .winner-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .winner-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            animation: modalPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalPop {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .winner-content h2 {
            color: #feca57;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .winner-content .prize-name {
            color: #48dbfb;
            font-size: 1.3em;
            margin-bottom: 25px;
        }

        .winner-content .winner-names {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .winner-content .winner-name {
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            color: #c0392b;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1.4em;
            font-weight: bold;
            animation: nameSlide 0.5s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes nameSlide {
            to { opacity: 1; transform: translateY(0); }
        }

        .winner-content .close-hint {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            color: #48dbfb;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .lottery-mode-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mode-option {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .mode-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .mode-option input[type="radio"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .mode-option input[type="radio"]:checked + .mode-label {
            color: #feca57;
        }

        .mode-option:has(input:checked) {
            border-color: #feca57;
            background: rgba(254, 202, 87, 0.1);
        }

        .mode-label {
            font-size: 1.1em;
            font-weight: bold;
            margin-right: 10px;
        }

        .mode-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
        }

        .settings-section input, .settings-section textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .settings-section input:focus, .settings-section textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s ease;
        }

        .btn-primary { background: linear-gradient(45deg, #ff6b6b, #feca57); }
        .btn-secondary { background: linear-gradient(45deg, #48dbfb, #0abde3); }
        .btn-danger { background: linear-gradient(45deg, #ff6b6b, #ee5a5a); }
        .btn-success { background: linear-gradient(45deg, #1dd1a1, #10ac84); }

        .btn:hover { transform: translateY(-2px); }

        .close-settings {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-settings:hover { transform: rotate(90deg); }

        .bg-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .bg-option {
            height: 45px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .bg-option.active {
            border-color: #feca57;
        }

        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px 0;
        }

        .file-upload:hover {
            border-color: #feca57;
            background: rgba(254, 202, 87, 0.1);
        }

        .file-upload input {
            display: none;
        }

        .ball-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            perspective: 1200px;
        }

        .ball-container.active {
            display: flex;
        }

        #lottery-ball {
            width: 850px;
            height: 850px;
            position: relative;
            transform-style: preserve-3d;
        }

        @keyframes rotateY {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        .ball-item {
            position: absolute;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ball-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 28px;
            height: 28px;
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            border-radius: 50%;
        }

        .ball-item::after {
            content: 'ç¦';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            font-weight: bold;
            color: #c0392b;
            z-index: 1;
        }

        .ball-item .name {
            position: absolute;
            bottom: 4px;
            left: 2px;
            right: 2px;
            text-align: center;
            font-size: 9px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
        }

        .ball-item.gather {
            position: absolute;
            top: 50%;
            left: 50%;
        }

        .ball-item.highlight {
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            box-shadow: 0 0 35px rgba(254, 202, 87, 0.9);
            z-index: 1000;
        }

        .fullscreen-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .stop-btn, .cancel-btn {
            position: absolute;
            bottom: 60px;
            padding: 18px 45px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .ball-container.active .stop-btn,
        .ball-container.active .cancel-btn {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease 1s;
        }

        .ball-btn-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            opacity: 0;
            transition: all 0.5s ease 1s;
        }

        .ball-container.active .ball-btn-container {
            opacity: 1;
        }

        .ball-btn-container .stop-btn,
        .ball-btn-container .cancel-btn {
            position: static;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ball-btn-container .stop-btn {
            background: linear-gradient(45deg, #1dd1a1, #10ac84);
            box-shadow: 0 5px 30px rgba(29, 209, 161, 0.4);
        }

        .ball-btn-container .cancel-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a5a);
            box-shadow: 0 5px 30px rgba(255, 107, 107, 0.4);
        }

        .ball-btn-container .stop-btn:hover,
        .ball-btn-container .cancel-btn:hover {
            transform: scale(1.05);
        }

        .ball-btn-container .stop-btn:active,
        .ball-btn-container .cancel-btn:active {
            transform: scale(0.95);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        /* å†å²è®°å½•æŒ‰é’® */
        .history-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .history-btn:active {
            transform: translateY(0);
        }

        /* æš‚åœæŒ‰é’® */
        .pause-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #feca57, #ff9ff3);
            color: #333;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(254, 202, 87, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .pause-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 202, 87, 0.6);
        }

        .pause-btn:active {
            transform: translateX(-50%) translateY(0);
        }

        .pause-btn.paused {
            background: linear-gradient(135deg, #1dd1a1, #10ac84);
            color: white;
        }

        .pause-btn.paused:hover {
            box-shadow: 0 6px 20px rgba(29, 209, 161, 0.6);
        }

        /* å†å²è®°å½•é¢æ¿ */
        .history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            border-left: 2px solid rgba(255, 255, 255, 0.1);
            z-index: 2000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .history-panel.active {
            right: 0;
        }

        .history-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-header h2 {
            margin: 0;
            color: #fff;
            font-size: 1.3em;
        }

        .close-history-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-history-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .history-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .history-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #feca57;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-5px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-prize {
            font-weight: bold;
            color: #feca57;
            font-size: 1.1em;
        }

        .history-item-time {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
        }

        .history-item-winners {
            color: #fff;
            font-size: 0.95em;
            margin-top: 5px;
        }

        .history-item-winners strong {
            color: #1dd1a1;
        }

        .history-item-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .history-item-actions button {
            padding: 5px 12px;
            font-size: 0.85em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item-actions .revoke-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }

        .history-item-actions .revoke-btn:hover {
            transform: scale(1.05);
        }

        .history-item-actions .revoke-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(30, 30, 40, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 500;
            z-index: 3000;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 80%;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #1dd1a1;
        }

        .toast.error {
            border-left: 4px solid #ff6b6b;
        }

        .toast.warning {
            border-left: 4px solid #feca57;
        }

        .toast.info {
            border-left: 4px solid #48dbfb;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #feca57;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 1.2em;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æµè§ˆå™¨å…¼å®¹æ€§æç¤º */
        .compatibility-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 500;
            z-index: 5000;
            display: none;
        }

        .compatibility-warning.show {
            display: block;
        }

        /* æ•°æ®å¤‡ä»½æé†’ */
        .backup-reminder {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(30, 30, 40, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #feca57;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1500;
            display: none;
            max-width: 300px;
        }

        .backup-reminder.show {
            display: block;
            animation: slideInRight 0.3s ease;
        }

        .backup-reminder h4 {
            margin: 0 0 8px 0;
            color: #feca57;
        }

        .backup-reminder p {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .backup-reminder button {
            padding: 6px 15px;
            font-size: 0.85em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .backup-reminder .export-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .backup-reminder .close-btn {
            background: #555;
            color: white;
        }

        .backup-reminder button:hover {
            transform: scale(1.05);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹ */
        .compatibility-check {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 500;
            z-index: 5000;
            display: none;
        }

        .compatibility-check.show {
            display: block;
        }

        @media (max-width: 768px) {
            .title { font-size: 1.8em; }
            .lottery-btn { padding: 10px 30px; font-size: 1.1em; }
            .people-grid { grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); grid-auto-rows: minmax(50px, 1fr); }
            .prize-panel { width: 260px; }
            .history-panel { width: 100%; right: -100%; }
            .history-btn { bottom: 15px; right: 15px; padding: 10px 15px; font-size: 14px; }
            .settings-btn { bottom: 15px; right: 100px; }
            .fullscreen-btn { bottom: 15px; right: 170px; }
        }
    </style>
</head>
<body>
    <div class="bg-overlay" id="bg-overlay"></div>
    <button class="toggle-prize-btn" id="toggle-prize-btn">å¥–é¡¹åˆ—è¡¨</button>

    <div class="prize-panel" id="prize-panel">
        <h2>ğŸ† å¥–é¡¹åˆ—è¡¨</h2>
        <div class="prize-list" id="prize-list">
            <div class="empty-state">
                <div class="icon">ğŸ†</div>
                <p>æš‚æ— å¥–é¡¹</p>
            </div>
        </div>
    </div>

    <div class="main-content">
        <h1 class="title" id="lottery-title">ğŸ‰ å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ ğŸŠ</h1>

        <div class="people-area">
            <div class="people-grid" id="people-grid">
                <div class="empty-state">
                    <div class="icon">ğŸ‘¥</div>
                    <p>æš‚æ— äººå‘˜ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ·»åŠ </p>
                </div>
            </div>
        </div>

        <button class="lottery-btn" id="lottery-btn" onclick="startLottery()">ğŸ° å¼€å§‹æŠ½å¥–</button>
        <button class="pause-btn" id="pause-btn" onclick="togglePause()" style="display:none;">â¸ æš‚åœ</button>
    </div>

    <button class="settings-btn" id="settings-btn" onclick="showSettings()">âš™ï¸</button>
    <button class="fullscreen-btn" id="fullscreen-btn" onclick="toggleFullscreen()">â›¶</button>
    <button class="history-btn" id="history-btn" onclick="toggleHistoryPanel()">ğŸ“œ å†å²è®°å½•</button>

    <div class="ball-container" id="ball-container">
        <div id="lottery-ball"></div>
        <div class="ball-btn-container">
            <button class="stop-btn" id="stop-btn">â¹ åœæ­¢å¹¶æ­æ™“</button>
            <button class="cancel-btn" id="cancel-btn">âŒ å–æ¶ˆ</button>
        </div>
    </div>

    <div class="winner-modal" id="winner-modal">
        <div class="winner-content">
            <div class="winner-header">
                <h2 id="winner-title">ğŸ‰ æ­å–œä¸­å¥– ğŸ‰</h2>
                <button class="winner-close-btn" onclick="closeWinnerModal()">âœ•</button>
            </div>
            <div class="prize-name" id="winner-prize"></div>
            <div class="winner-names" id="winner-names"></div>
            <div class="close-hint">ç‚¹å‡»ä»»æ„ä½ç½®æˆ–å…³é—­æŒ‰é’®å…³é—­</div>
        </div>
    </div>

    <div id="fireworks-container"></div>

    <!-- å†å²è®°å½•é¢æ¿ -->
    <div class="history-panel" id="history-panel">
        <div class="history-header">
            <h2>ğŸ“œ æŠ½å¥–å†å²è®°å½•</h2>
            <button class="close-history-btn" onclick="toggleHistoryPanel()">âœ•</button>
        </div>
        <div class="history-list" id="history-list">
            <div class="empty-state">
                <div class="icon">ğŸ“œ</div>
                <p>æš‚æ— å†å²è®°å½•</p>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div class="toast" id="toast"></div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹ -->
    <div class="compatibility-check" id="compatibility-check">
        âš ï¸ æ£€æµ‹åˆ°æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨
    </div>

    <!-- æ•°æ®å¤‡ä»½æé†’ -->
    <div class="backup-reminder" id="backup-reminder">
        <h4>ğŸ’¡ æ•°æ®å¤‡ä»½æé†’</h4>
        <p>æ‚¨æœ‰æœªå¤‡ä»½çš„æ•°æ®ï¼Œå»ºè®®ç«‹å³å¯¼å‡ºå¤‡ä»½ï¼</p>
        <button class="export-btn" onclick="exportData()">ç«‹å³å¯¼å‡º</button>
        <button class="close-btn" onclick="closeBackupReminder()">ç¨å</button>
    </div>

    <script>
        // ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
        
        /**
         * åº”ç”¨çŠ¶æ€å¯¹è±¡ - å°è£…æ‰€æœ‰å…¨å±€å˜é‡
         * 
         * ä½¿ç”¨å¯¹è±¡å°è£…è€Œéå¤šä¸ªå…¨å±€å˜é‡çš„å¥½å¤„ï¼š
         * 1. é¿å…å…¨å±€å‘½åç©ºé—´æ±¡æŸ“
         * 2. ä¾¿äºçŠ¶æ€ç®¡ç†å’Œè°ƒè¯•
         * 3. æ”¯æŒæœªæ¥æ‰©å±•ï¼ˆå¦‚çŠ¶æ€å¿«ç…§ã€æ—¶é—´æ—…è¡Œè°ƒè¯•ï¼‰
         * 4. æ›´å¥½çš„ä»£ç ç»„ç»‡å’Œå¯ç»´æŠ¤æ€§
         */
        const appState = {
            // ==================== æ•°æ®å±‚ ====================
            
            // äººå‘˜åˆ—è¡¨
            // æ ¼å¼ï¼š[{ id: number, name: string, prize: string|null }]
            // id: å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆä½¿ç”¨ Date.now() + Math.random() ç”Ÿæˆï¼‰
            // name: äººå‘˜å§“å
            // prize: å·²ä¸­å¥–é¡¹åç§°ï¼Œnullè¡¨ç¤ºæœªä¸­å¥–
            people: [],
            
            // å¥–é¡¹åˆ—è¡¨
            // æ ¼å¼ï¼š[{ id: number, name: string, desc: string, count: number, color: string, awarded: boolean }]
            // id: å”¯ä¸€æ ‡è¯†ç¬¦
            // name: å¥–é¡¹åç§°
            // desc: å¥–é¡¹æè¿°
            // count: å¥–é¡¹æ•°é‡ï¼ˆå¯ä¸­å¥–äººæ•°ï¼‰
            // color: å¥–é¡¹é¢œè‰²ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
            // awarded: æ˜¯å¦å·²æŠ½å–
            prizes: [],
            
            // å†å²è®°å½•
            // æ ¼å¼ï¼š[{ prizeName: string, prizeDesc: string, winners: string[], time: string, revoked: boolean }]
            // prizeName: å¥–é¡¹åç§°
            // prizeDesc: å¥–é¡¹æè¿°
            // winners: ä¸­å¥–è€…å§“åæ•°ç»„
            // time: æŠ½å¥–æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
            // revoked: æ˜¯å¦å·²æ’¤é”€
            history: [],
            
            // è®¾ç½®
            // æ ¼å¼ï¼š{ title: string, background: string, lotteryMode: string }
            // title: é¡µé¢æ ‡é¢˜
            // background: èƒŒæ™¯ä¸»é¢˜ï¼ˆgradient1-4 æˆ– customï¼‰
            // lotteryMode: æŠ½å¥–æ¨¡å¼ï¼ˆsphere æˆ– slideï¼‰
            settings: { title: 'ğŸ‰ å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ ğŸŠ', background: 'gradient1', lotteryMode: 'sphere' },
            
            // ==================== çŠ¶æ€å±‚ ====================
            
            // å½“å‰é€‰ä¸­çš„å¥–é¡¹ç´¢å¼•
            // null: æœªé€‰æ‹©ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨å¥–é¡¹
            // number: æŒ‡å®šç´¢å¼•çš„å¥–é¡¹
            currentPrizeIndex: null,
            
            // æŠ½å¥–è¿è¡ŒçŠ¶æ€
            // true: æŠ½å¥–è¿›è¡Œä¸­
            // false: æŠ½å¥–æœªå¼€å§‹æˆ–å·²ç»“æŸ
            isLotteryRunning: false,
            
            // æš‚åœçŠ¶æ€
            // true: æŠ½å¥–å·²æš‚åœ
            // false: æŠ½å¥–æ­£å¸¸è¿›è¡Œ
            isPaused: false,
            
            // ==================== åŠ¨ç”»å±‚ ====================
            
            // åŠ¨ç”»IDï¼ˆç”¨äº cancelAnimationFrameï¼‰
            // å­˜å‚¨ requestAnimationFrame è¿”å›çš„ID
            animationId: null,
            
            // å½“å‰åŠ¨ç”»æ•°æ®
            // ç”¨äºæš‚åœ/æ¢å¤åŠŸèƒ½
            // æ ¼å¼ï¼š{ availablePeople: array, prize: object, ... }
            currentAnimationData: null,
            
            // ç¿»åŠ¨åŠ¨ç”»å®šæ—¶å™¨ID
            // ç”¨äºæ¸…ç†å®šæ—¶å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼
            flipIntervalId: null,
            
            // æš‚åœåŠ¨ç”»å®šæ—¶å™¨ID
            // ç”¨äºæ¸…ç†æš‚åœæ—¶çš„å®šæ—¶å™¨
            pauseIntervalId: null
        };

        // ==================== å‘åå…¼å®¹ ====================
        // 
        // ä¸ºäº†ä¿æŒä¸ç°æœ‰ä»£ç çš„å…¼å®¹æ€§ï¼Œå°† appState çš„å±æ€§æ˜ å°„åˆ°å…¨å±€å˜é‡
        // è¿™æ ·å¯ä»¥é€æ­¥è¿ç§»ï¼Œé¿å…ä¸€æ¬¡æ€§ä¿®æ”¹æ‰€æœ‰ä»£ç 
        // 
        // æ³¨æ„ï¼šè¿™äº›å˜é‡æ˜¯å¼•ç”¨ç±»å‹ï¼Œä¿®æ”¹å®ƒä»¬ä¼šç›´æ¥å½±å“ appState
        // 
        let people = appState.people;
        let prizes = appState.prizes;
        let history = appState.history;
        let settings = appState.settings;
        let currentPrizeIndex = appState.currentPrizeIndex;
        let isLotteryRunning = appState.isLotteryRunning;
        let isPaused = appState.isPaused;
        let animationId = appState.animationId;
        let currentAnimationData = appState.currentAnimationData;
        let flipIntervalId = appState.flipIntervalId;
        let pauseIntervalId = appState.pauseIntervalId;

        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
            checkCompatibility();

            loadData();
            renderAll();
            initBgOptions();
            initLotteryMode();
            document.getElementById('toggle-prize-btn').addEventListener('click', togglePrizePanel);
            document.getElementById('settings-btn').addEventListener('click', showSettings);
            document.getElementById('stop-btn').addEventListener('click', stopLottery);
            document.getElementById('cancel-btn').addEventListener('click', cancelLottery);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);

            // ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­å¥–é¡¹åˆ—è¡¨
            document.addEventListener('click', (e) => {
                const prizePanel = document.getElementById('prize-panel');
                const toggleBtn = document.getElementById('toggle-prize-btn');

                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å¥–é¡¹é¢æ¿å†…éƒ¨ï¼Œä¹Ÿä¸æ˜¯åˆ‡æ¢æŒ‰é’®ï¼Œåˆ™éšè—å¥–é¡¹é¢æ¿
                if (!prizePanel.contains(e.target) && e.target !== toggleBtn) {
                    prizePanel.classList.remove('active');
                }
            });

            // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶å¤„ç†
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMove, { passive: true });
            document.addEventListener('touchend', handleTouchEnd, { passive: true });

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', handleKeyDown);

            // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½
            setTimeout(() => checkBackupNeeded(), 3000);

            // ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶ï¼Œæé†’ä¿å­˜æ•°æ®
            window.addEventListener('beforeunload', (e) => {
                if (isLotteryRunning) {
                    e.preventDefault();
                    e.returnValue = 'æŠ½å¥–æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                }
            });
        });
        });

        /**
         * ä» LocalStorage åŠ è½½æ•°æ®
         * 
         * åŠŸèƒ½ï¼š
         * 1. è¯»å– localStorage ä¸­çš„æŠ½å¥–æ•°æ®
         * 2. è§£æ JSON æ•°æ®
         * 3. æ›´æ–°åº”ç”¨çŠ¶æ€
         * 4. å¤„ç†è§£æé”™è¯¯å’Œæ•°æ®æŸå
         * 
         * æ•°æ®æ ¼å¼ï¼š
         * {
         *   people: [...],
         *   prizes: [...],
         *   history: [...],
         *   settings: {...}
         * }
         * 
         * é”™è¯¯å¤„ç†ï¼š
         * - JSON è§£æå¤±è´¥ï¼šæ¸…ç©ºæŸåçš„æ•°æ®
         * - æ•°æ®æ ¼å¼é”™è¯¯ï¼šä½¿ç”¨é»˜è®¤å€¼
         * - localStorage ä¸å¯ç”¨ï¼šé™é»˜å¤±è´¥
         * 
         * @returns {void}
         */
        function loadData() {
            try {
                // æ¸…ç†è™šæ‹Ÿæ»šåŠ¨
                cleanupVirtualScroll();
                
                const data = localStorage.getItem('lotteryData');
                if (data) {
                    const parsed = JSON.parse(data);
                    appState.people = parsed.people || [];
                    appState.prizes = parsed.prizes || [];
                    appState.history = parsed.history || [];
                    appState.settings = parsed.settings || { title: 'ğŸ‰ å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ ğŸŠ', background: 'gradient1' };
                    appState.currentPrizeIndex = parsed.currentPrizeIndex || null;
                    
                    // æ›´æ–°å…¼å®¹æ€§å˜é‡
                    people = appState.people;
                    prizes = appState.prizes;
                    history = appState.history;
                    settings = appState.settings;
                    currentPrizeIndex = appState.currentPrizeIndex;
                    
                    // åº”ç”¨è®¾ç½®
                    document.body.className = settings.background;
                    document.title = settings.title;
                }
            } catch (e) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', e);
                showToast('æ•°æ®åŠ è½½å¤±è´¥ï¼š' + e.message, 'error');
            }
        }
            } catch (e) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                showToast('æ•°æ®åŠ è½½å¤±è´¥ï¼š' + e.message, 'error', 5000);
                // æ¸…ç©ºæŸåçš„æ•°æ®
                localStorage.removeItem('lotteryData');
            }
        }

        /**
         * ä¿å­˜æ•°æ®åˆ° LocalStorage
         * 
         * åŠŸèƒ½ï¼š
         * 1. å°†åº”ç”¨çŠ¶æ€åºåˆ—åŒ–ä¸º JSON
         * 2. æ£€æŸ¥æ•°æ®å¤§å°ï¼ˆé¿å…è¶…å‡º localStorage é™åˆ¶ï¼‰
         * 3. ä¿å­˜åˆ° localStorage
         * 4. å¤„ç†å­˜å‚¨ç©ºé—´ä¸è¶³çš„æƒ…å†µ
         * 
         * æ•°æ®å¤§å°é™åˆ¶ï¼š
         * - å¤§å¤šæ•°æµè§ˆå™¨ï¼š5MB per origin
         * - å®‰å…¨é™åˆ¶ï¼š4.5MBï¼ˆç•™0.5MBç¼“å†²ï¼‰
         * - è¶…å‡ºé™åˆ¶ï¼šæç¤ºç”¨æˆ·åˆ é™¤æ•°æ®
         * 
         * é”™è¯¯å¤„ç†ï¼š
         * - QuotaExceededError: å­˜å‚¨ç©ºé—´ä¸è¶³
         * - å…¶ä»–é”™è¯¯ï¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
         * 
         * @returns {void}
         */
        function saveData() {
            try {
                const dataToSave = {
                    people: appState.people,
                    prizes: appState.prizes,
                    history: appState.history,
                    settings: appState.settings
                };
                const dataString = JSON.stringify(dataToSave);
                
                // æ£€æŸ¥æ•°æ®å¤§å°
                const dataSize = new Blob([dataString]).size;
                const maxSize = 4.5 * 1024 * 1024; // 4.5MB (ç•™0.5MBç¼“å†²)
                
                if (dataSize > maxSize) {
                    showToast('æ•°æ®è¿‡å¤§ï¼Œæ— æ³•ä¿å­˜åˆ°æµè§ˆå™¨ï¼è¯·åˆ é™¤ä¸€äº›æ•°æ®', 'error', 8000);
                    return;
                }
                
                localStorage.setItem('lotteryData', dataString);
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
                
                if (e.name === 'QuotaExceededError') {
                    showToast('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼è¯·åˆ é™¤ä¸€äº›å†å²è®°å½•æˆ–æ•°æ®', 'error', 8000);
                } else {
                    showToast('ä¿å­˜æ•°æ®å¤±è´¥ï¼š' + e.message, 'error');
                }
            }
        }

        /**
         * æ˜¾ç¤º Toast æç¤º
         * 
         * åŠŸèƒ½ï¼š
         * 1. æ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯æç¤º
         * 2. æ”¯æŒå¤šç§ç±»å‹ï¼ˆsuccess, error, warning, infoï¼‰
         * 3. è‡ªåŠ¨æ¶ˆå¤±
         * 4. é˜²æ­¢é‡å¤æ˜¾ç¤º
         * 
         * æ¶ˆæ¯ç±»å‹ï¼š
         * - success: æˆåŠŸæ¶ˆæ¯ï¼ˆç»¿è‰²è¾¹æ¡†ï¼‰
         * - error: é”™è¯¯æ¶ˆæ¯ï¼ˆçº¢è‰²è¾¹æ¡†ï¼‰
         * - warning: è­¦å‘Šæ¶ˆæ¯ï¼ˆé»„è‰²è¾¹æ¡†ï¼‰
         * - info: ä¿¡æ¯æ¶ˆæ¯ï¼ˆè“è‰²è¾¹æ¡†ï¼‰
         * 
         * æ˜¾ç¤ºä½ç½®ï¼š
         * - é¡µé¢é¡¶éƒ¨å±…ä¸­
         * - å›ºå®šå®šä½ï¼Œä¸éšæ»šåŠ¨ç§»åŠ¨
         * 
         * @param {string} message - æç¤ºæ¶ˆæ¯å†…å®¹
         * @param {string} type - æ¶ˆæ¯ç±»å‹ï¼ˆsuccess/error/warning/infoï¼‰
         * @param {number} duration - æ˜¾ç¤ºæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
         * @returns {void}
         */
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        /**
         * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
         * 
         * åŠŸèƒ½ï¼š
         * 1. æ˜¾ç¤ºå…¨å±é®ç½©å±‚
         * 2. æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆæ—‹è½¬åœ†åœˆï¼‰
         * 3. æ˜¾ç¤ºåŠ è½½æ–‡æœ¬
         * 4. é˜²æ­¢ç”¨æˆ·äº¤äº’
         * 
         * ä½¿ç”¨åœºæ™¯ï¼š
         * - æ–‡ä»¶å¯¼å…¥
         * - æ•°æ®å¯¼å‡º
         * - å¤§é‡æ•°æ®å¤„ç†
         * - ç½‘ç»œè¯·æ±‚ï¼ˆæœªæ¥æ‰©å±•ï¼‰
         * 
         * @param {string} text - åŠ è½½æ–‡æœ¬ï¼ˆé»˜è®¤ï¼š"åŠ è½½ä¸­..."ï¼‰
         * @returns {void}
         */
        function showLoading(text = 'åŠ è½½ä¸­...') {
            const loading = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = text;
            loading.classList.add('active');
        }

        /**
         * éšè—åŠ è½½çŠ¶æ€
         * 
         * åŠŸèƒ½ï¼š
         * 1. éšè—å…¨å±é®ç½©å±‚
         * 2. æ¢å¤ç”¨æˆ·äº¤äº’
         * 
         * @returns {void}
         */
        function hideLoading() {
            const loading = document.getElementById('loading-overlay');
            loading.classList.remove('active');
        }

        // æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹
        function checkCompatibility() {
            const warnings = [];

            // æ£€æŸ¥ localStorage
            if (!window.localStorage) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ LocalStorage');
            }

            // æ£€æŸ¥ CSS3 æ”¯æŒ
            const testDiv = document.createElement('div');
            if (!('transform' in testDiv.style)) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ CSS3 Transform');
            }

            if (!('backfaceVisibility' in testDiv.style)) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ backface-visibility');
            }

            // æ£€æŸ¥ ES6 æ”¯æŒ
            try {
                new Function('const test = () => {}');
            } catch (e) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ ES6 è¯­æ³•');
            }

            if (warnings.length > 0) {
                const check = document.getElementById('compatibility-check');
                check.textContent = 'âš ï¸ æ£€æµ‹åˆ°æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼š' + warnings.join('ã€');
                check.classList.add('show');
                setTimeout(() => check.classList.remove('show'), 5000);
            }
        }

        // æ˜¾ç¤ºæ•°æ®å¤‡ä»½æé†’
        function showBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.add('show');
        }

        // å…³é—­æ•°æ®å¤‡ä»½æé†’
        function closeBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.remove('show');
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½
        function checkBackupNeeded() {
            // å¦‚æœæœ‰æ•°æ®ä¸”è¶…è¿‡7å¤©æœªå¤‡ä»½ï¼Œæ˜¾ç¤ºæé†’
            const lastBackup = localStorage.getItem('lastBackupTime');
            const now = Date.now();
            
            if (people.length > 0 || prizes.length > 0) {
                if (!lastBackup || (now - parseInt(lastBackup)) > 7 * 24 * 60 * 60 * 1000) {
                    setTimeout(() => showBackupReminder(), 2000);
                }
            }
        }
            };
            localStorage.setItem('lotteryData', JSON.stringify(dataToSave));
        }

        function renderAll() {
            renderPrizes();
            renderPeople();
            updateLotteryButton();
            updateStopButton();
            updateCancelButton();
            
            // å¦‚æœæ˜¯è™šæ‹Ÿæ»šåŠ¨ï¼Œé‡æ–°è®¡ç®—å¯è§é¡¹ç›®
            if (virtualScrollConfig.enabled && people.length >= 200) {
                setTimeout(() => updateVirtualVisibleItems(), 100);
            }
            if (historyVirtualScrollConfig.enabled && appState.history.length >= 50) {
                setTimeout(() => updateHistoryVirtualVisibleItems(), 100);
            }
        }

        function renderTitle() {
            document.getElementById('lottery-title').textContent = settings.title;
            document.getElementById('setting-title').value = settings.title.replace(/ğŸ‰|ğŸŠ/g, '').trim();
        }

        function renderBg() {
            document.body.style.background = getBgStyle(settings.background);
            document.querySelectorAll('.bg-option').forEach(el => {
                el.classList.toggle('active', el.dataset.bg === settings.background);
            });
        }

        function uploadBgImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.querySelector('.main-content').style.backgroundImage = `url(${e.target.result})`;
                document.getElementById('bg-overlay').style.background = 'rgba(0, 0, 0, 0.3)';
                alert('èƒŒæ™¯å›¾ç‰‡å·²è®¾ç½®ï¼ˆä»…å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰');
            };
            reader.readAsDataURL(file);
        }

        function clearBgImage() {
            document.querySelector('.main-content').style.backgroundImage = 'none';
            document.getElementById('bg-overlay').style.background = 'rgba(0, 0, 0, 0.5)';
            alert('èƒŒæ™¯å›¾ç‰‡å·²æ¸…é™¤');
        }

        function getBgStyle(bg) {
            const styles = {
                gradient1: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)',
                gradient2: 'linear-gradient(135deg, #0f4037 0%, #195047 50%, #0f4037 100%)',
                gradient3: 'linear-gradient(135deg, #4a1a1a 0%, #3d1a1a 50%, #2a0f0f 100%)',
                gradient4: 'linear-gradient(135deg, #1a2a4a 0%, #1a2040 50%, #0f1a2a 100%)'
            };
            return styles[bg] || styles.gradient1;
        }

        function initBgOptions() {
            document.querySelectorAll('.bg-option').forEach(option => {
                option.addEventListener('click', () => {
                    settings.background = option.dataset.bg;
                    saveData();
                    renderBg();
                });
            });
        }

        function initLotteryMode() {
            const mode = settings.lotteryMode || 'sphere';
            const radio = document.querySelector(`input[name="lotteryMode"][value="${mode}"]`);
            if (radio) radio.checked = true;
        }

        function saveLotteryMode(mode) {
            settings.lotteryMode = mode;
            saveData();
        }

        /**
         * æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
         * 
         * åŠŸèƒ½ï¼š
         * 1. æ˜¾ç¤ºæ€»äººæ•°
         * 2. æ˜¾ç¤ºå·²ä¸­å¥–äººæ•°
         * 3. æ˜¾ç¤ºå‰©ä½™æœªä¸­å¥–äººæ•°
         * 
         * @returns {void}
         */
        function renderStats() {
            const total = appState.people.length;
            const won = appState.people.filter(p => p.prize).length;
            
            // ä½¿ç”¨ textContent é¿å… XSS æ”»å‡»
            document.getElementById('total-count').textContent = total;
            document.getElementById('won-count').textContent = won;
            document.getElementById('remain-count').textContent = total - won;
        }

        /**
         * æ¸²æŸ“å¥–é¡¹åˆ—è¡¨
         * 
         * åŠŸèƒ½ï¼š
         * 1. æ˜¾ç¤ºæ‰€æœ‰å¥–é¡¹
         * 2. æ˜¾ç¤ºå¥–é¡¹çŠ¶æ€ï¼ˆå·²æŠ½å–/å¾…æŠ½å–ï¼‰
         * 3. æ˜¾ç¤ºä¸­å¥–è€…åå•
         * 4. æ”¯æŒé€‰æ‹©å¥–é¡¹è¿›è¡ŒæŠ½å¥–
         * 
         * é€‰æ‹©é€»è¾‘ï¼š
         * - åªèƒ½é€‰æ‹©ç¬¬ä¸€ä¸ªæœªæŠ½å–çš„å¥–é¡¹
         * - å·²æŠ½å–çš„å¥–é¡¹ä¸å¯ç‚¹å‡»
         * - å½“å‰é€‰ä¸­çš„å¥–é¡¹é«˜äº®æ˜¾ç¤º
         * 
         * æ€§èƒ½ä¼˜åŒ–ï¼š
         * - ä½¿ç”¨ DocumentFragment å‡å°‘ DOM æ“ä½œ
         * - ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ›¿ä»£æ¯ä¸ªå…ƒç´ ç»‘å®šäº‹ä»¶
         * 
         * @returns {void}
         */
        function renderPrizes() {
            const container = document.getElementById('prize-list');
            
            // æ¸…ç©ºå®¹å™¨
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            if (prizes.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="icon">ğŸ†</div>
                    <p>æš‚æ— å¥–é¡¹</p>
                `;
                container.appendChild(emptyState);
                return;
            }

            const firstUnawardedIndex = prizes.findIndex(p => !p.awarded);
            const fragment = document.createDocumentFragment();

            prizes.forEach((prize, index) => {
                const winners = people.filter(p => p.prize === prize.name);
                const isClickable = !prize.awarded && (index === firstUnawardedIndex || currentPrizeIndex === index);
                
                const prizeItem = document.createElement('div');
                prizeItem.className = `prize-item ${prize.awarded ? 'disabled' : ''} ${!isClickable && !prize.awarded ? 'unselectable' : ''} ${currentPrizeIndex === index ? 'active' : ''}`;
                prizeItem.style.borderLeftColor = prize.color;
                
                if (isClickable) {
                    prizeItem.onclick = () => selectPrize(index);
                }

                prizeItem.innerHTML = `
                    <div class="name" style="color: ${prize.color}">${prize.name}</div>
                    <div class="desc">${prize.desc}</div>
                    <div class="info">
                        <span>ğŸ‘¤ ${prize.count}äºº</span>
                        <span class="status ${prize.awarded ? 'awarded' : ''}">${prize.awarded ? 'å·²æŠ½å–' : 'å¾…æŠ½å–'}</span>
                    </div>
                    ${winners.length > 0 ? `<div class="desc" style="margin-top:8px;color:#feca57;">ä¸­å¥–: ${winners.map(w => w.name).join('ã€')}</div>` : ''}
                `;

                fragment.appendChild(prizeItem);
            });

            container.appendChild(fragment);
        }

        function selectPrize(index) {
            if (prizes[index].awarded) return;
            if (currentPrizeIndex === index) {
                currentPrizeIndex = null;
            } else {
                currentPrizeIndex = index;
            }
            renderPrizes();
        }

        /**
         * æ¸²æŸ“äººå‘˜åˆ—è¡¨
         * 
         * åŠŸèƒ½ï¼š
         * 1. æ˜¾ç¤ºæ‰€æœ‰äººå‘˜çš„çº¢åŒ…å¡ç‰‡
         * 2. æ˜¾ç¤ºä¸­å¥–çŠ¶æ€
         * 3. æ”¯æŒç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
         * 
         * æ€§èƒ½ä¼˜åŒ–ï¼š
         * - ä½¿ç”¨ DocumentFragment å‡å°‘ DOM æ“ä½œ
         * - ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ›¿ä»£æ¯ä¸ªå…ƒç´ ç»‘å®šäº‹ä»¶
         * - ä½¿ç”¨ DocumentFragment æ‰¹é‡æ’å…¥
         * 
         * @returns {void}
         */
        function renderPeople() {
            const container = document.getElementById('people-grid');
            
            // åˆå§‹åŒ–è™šæ‹Ÿæ»šåŠ¨é…ç½®
            if (!virtualScrollConfig.container) {
                virtualScrollConfig.container = container;
                virtualScrollConfig.items = people;
            } else {
                virtualScrollConfig.items = people;
            }
            
            // æ¸…ç©ºå®¹å™¨
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            if (people.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="icon">ğŸ‘¥</div>
                    <p>æš‚æ— äººå‘˜ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ·»åŠ </p>
                `;
                container.appendChild(emptyState);
                return;
            }

            // å¦‚æœæ•°æ®é‡å°äºé˜ˆå€¼ï¼Œä½¿ç”¨æ™®é€šæ¸²æŸ“
            if (people.length < 200) {
                renderPeopleNormal(container);
                return;
            }

            // ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨æ¸²æŸ“
            renderPeopleVirtual(container);
        }

        // æ™®é€šæ¸²æŸ“ï¼ˆå°æ•°æ®é‡ï¼‰
        function renderPeopleNormal(container) {
            const fragment = document.createDocumentFragment();

            people.forEach((person, index) => {
                const won = !!person.prize;
                const packet = document.createElement('div');
                packet.className = `red-packet ${won ? 'won' : ''}`;
                packet.title = person.name;
                packet.dataset.index = index;

                if (won) {
                    packet.innerHTML = `
                        <div class="face front">
                            <span class="won-prize">${person.prize}</span>
                            <span class="won-name">${person.name}</span>
                        </div>
                        <div class="face back"><span class="name">${person.name}</span></div>
                    `;
                } else {
                    packet.innerHTML = `
                        <div class="face front">
                            <span class="front-name" style="visibility:hidden"></span>
                        </div>
                        <div class="face back"><span class="name">${person.name}</span></div>
                    `;
                }

                fragment.appendChild(packet);
            });

            container.appendChild(fragment);

            // é‡æ–°è®¡ç®—å°ºå¯¸/å¸ƒå±€
            setTimeout(() => adjustPacketSize(), 0);

            // å¦‚æœæ˜¯è™šæ‹Ÿæ»šåŠ¨ï¼Œéœ€è¦é‡æ–°è®¡ç®—å¯è§é¡¹ç›®
            if (virtualScrollConfig.enabled && people.length >= 200) {
                updateVirtualVisibleItems();
            }
        }

        function adjustPacketSize() {
            // ç›®æ ‡ï¼šæ ¹æ®æ€»æ•°é‡åŠ¨æ€åˆ†é…çº¢åŒ…å¤§å°ï¼Œç¡®ä¿é“ºæ»¡å¢™é¢ä¸”ç›¸é‚»ä¸é‡å 
            const container = document.getElementById('people-grid');
            if (!container || people.length === 0) return;

            const W = container.clientWidth;
            const H = people.length < 200 ? container.clientHeight : container.clientHeight * 2;
            const N = people.length;
            const gap = 15; // çº¢åŒ…ä¹‹é—´çš„é—´è·

            // ç©·ä¸¾æ‰€æœ‰å¯èƒ½çš„åˆ—æ•°ï¼Œé€‰æ‹©èƒ½è®©å•ä¸ªçº¢åŒ…æœ€å¤§ä¸”èƒ½æ”¾ä¸‹æ‰€æœ‰çº¢åŒ…çš„ç»„åˆ
            let best = { cols: 1, size: 40 };
            for (let c = 1; c <= Math.min(N, 100); c++) {
                const r = Math.ceil(N / c);
                const sX = (W - (c + 1) * gap) / c;
                const sY = (H - (r + 1) * gap) / r;
                const s = Math.min(sX, sY);
                if (s > best.size) best = { cols: c, size: s };
            }
            const cols = best.cols;
            const cellSize = Math.max(20, best.size); // é˜²æ­¢è¿‡å°

            container.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;
            container.style.gridColumnGap = `${gap}px`;
            container.style.gridRowGap = `${gap}px`;

            const packets = container.querySelectorAll('.red-packet');
            packets.forEach(p => {
                p.style.width = cellSize + 'px';
                p.style.height = cellSize + 'px';
                p.style.borderRadius = Math.max(4, cellSize * 0.12) + 'px';
                p.style.margin = '0';
            });

            // è°ƒæ•´å†…éƒ¨æ–‡å­—å’Œå›¾å½¢å°ºå¯¸
            const nameSize = Math.max(8, cellSize * 0.18);
            const circleSize = cellSize * 0.42;
            const fontSize = Math.max(10, cellSize * 0.32);
            const wonPrizeSize = Math.max(6, cellSize * 0.14);
            const wonNameSize = Math.max(7, cellSize * 0.16);

            const existing = document.getElementById('packet-dynamic-styles');
            if (existing) existing.remove();
            const styleEl = document.createElement('style');
            styleEl.id = 'packet-dynamic-styles';
            styleEl.textContent = `
                .red-packet::before { width: ${circleSize}px !important; height: ${circleSize}px !important; }
                .red-packet::after { font-size: ${fontSize}px !important; }
                .red-packet .name { font-size: ${nameSize}px !important; bottom: ${cellSize * 0.06}px !important; }
                .red-packet.won .won-prize { font-size: ${wonPrizeSize}px !important; }
                .red-packet.won .won-name { font-size: ${wonNameSize}px !important; }
            `;
            document.head.appendChild(styleEl);
        }

        window.addEventListener('resize', () => {
            if (people.length > 0) {
                setTimeout(adjustPacketSize, 100);
            }
        });

        // éšæœºç»™æœªä¸­å¥–çš„çº¢åŒ…åŠ ä¸€ä¸ªç¿»åŠ¨æ•ˆæœï¼Œå¢åŠ äº’åŠ¨æ„Ÿ
        function randomFlipNonWon() {
            if (isLotteryRunning) return;
            const candidates = Array.from(document.querySelectorAll('.red-packet:not(.won):not(.is-flipped)'));
            if (candidates.length === 0) return;
            const flipCount = 3 + Math.floor(Math.random() * 2); // 3 æˆ– 4
            for (let i = 0; i < flipCount; i++) {
                const el = candidates[Math.floor(Math.random() * candidates.length)];
                if (el && !el.classList.contains('is-flipped')) {
                    el.classList.add('is-flipped');
                    setTimeout(() => {
                        if (el && el.classList) {
                            el.classList.remove('is-flipped');
                        }
                    }, 1500);
                }
            }
        }
        // è°ƒæ•´ç¿»åŠ¨èŠ‚å¥ï¼šç¨æ…¢ä¸€äº›ï¼Œæ•°é‡ä¹Ÿå¢å¤š
        // æ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé¿å…é‡å¤
        if (flipIntervalId) {
            clearInterval(flipIntervalId);
            flipIntervalId = null;
        }
        flipIntervalId = setInterval(randomFlipNonWon, 1800);

        function showPersonInfo(index) {
            const person = people[index];
            if (!person) return;
            alert(person.prize ? `${person.name}\nå·²ä¸­å¥–: ${person.prize}` : `${person.name}\nçŠ¶æ€: å¾…æŠ½å¥–`);
        }

        function togglePrizePanel() {
            const panel = document.getElementById('prize-panel');
            panel.classList.toggle('active');
            
            // å¦‚æœæ˜¯è™šæ‹Ÿæ»šåŠ¨ï¼Œé‡æ–°è®¡ç®—å¯è§é¡¹ç›®
            if (virtualScrollConfig.enabled && people.length >= 200) {
                setTimeout(() => updateVirtualVisibleItems(), 100);
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function addPrize() {
            const name = document.getElementById('prize-name').value.trim();
            const desc = document.getElementById('prize-desc').value.trim();
            const count = parseInt(document.getElementById('prize-count').value);
            const color = document.getElementById('prize-color').value;

            if (!name) { alert('è¯·è¾“å…¥å¥–é¡¹åç§°'); return; }

            prizes.push({ id: Date.now(), name, desc, count, color, awarded: false });
            saveData();
            renderPrizes();
            updateLotteryButton();

            document.getElementById('setting-prize-name').value = '';
            document.getElementById('setting-prize-desc').value = '';
            document.getElementById('setting-prize-count').value = '1';
            showToast('å¥–é¡¹æ·»åŠ æˆåŠŸ', 'success');
        }

        function addPrizeFromSettings() {
            const name = document.getElementById('setting-prize-name').value.trim();
            const desc = document.getElementById('setting-prize-desc').value.trim();
            const count = parseInt(document.getElementById('setting-prize-count').value);
            const color = document.getElementById('setting-prize-color').value;

            if (!name) { alert('è¯·è¾“å…¥å¥–é¡¹åç§°'); return; }

            const duplicatePrize = prizes.find(p => p.name.toLowerCase() === name.toLowerCase());
            if (duplicatePrize) {
                alert('å¥–é¡¹åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                return;
            }

            prizes.push({ id: Date.now(), name, desc, count, color, awarded: false });
            saveData();
            renderPrizes();

            document.getElementById('setting-prize-name').value = '';
            document.getElementById('setting-prize-desc').value = '';
            document.getElementById('setting-prize-count').value = '1';
            alert('å¥–é¡¹æ·»åŠ æˆåŠŸ');
        }

        function clearPrizes() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¥–é¡¹å—ï¼Ÿä¸­å¥–è®°å½•å°†ä¸€å¹¶æ¸…é™¤')) {
                appState.prizes = [];
                appState.people.forEach(p => p.prize = null);
                appState.currentPrizeIndex = null;
                
                // æ›´æ–°å…¼å®¹æ€§å˜é‡
                prizes = appState.prizes;
                currentPrizeIndex = appState.currentPrizeIndex;
                
                saveData();
                renderAll();
                showToast('å¥–é¡¹å·²æ¸…ç©º', 'success');
            }
        }

        function startLottery() {
            console.log('å¼€å§‹æŠ½å¥–æŒ‰é’®è¢«ç‚¹å‡»');
            let prize;
            let prizeIndex;
            if (currentPrizeIndex !== null) {
                prize = prizes[currentPrizeIndex];
                prizeIndex = currentPrizeIndex;
            } else {
                const availablePrizes = prizes.filter(p => !p.awarded);
                console.log('å¯ç”¨å¥–é¡¹æ•°é‡:', availablePrizes.length);
                if (availablePrizes.length === 0) { 
                    showToast('æ‰€æœ‰å¥–é¡¹éƒ½å·²æŠ½å–å®Œæ¯•ï¼', 'warning');
                    return; 
                }
                prizeIndex = prizes.findIndex(p => !p.awarded);
                prize = prizes[prizeIndex];
            }

            const availablePeople = people.filter(p => !p.prize);
            console.log('å¯ç”¨äººå‘˜æ•°é‡:', availablePeople.length);
            if (availablePeople.length === 0) { 
                showToast('æ²¡æœ‰å¯æŠ½å¥–çš„äººå‘˜äº†ï¼', 'warning');
                return; 
            }

            // éšè—ä¸»æŠ½å¥–æŒ‰é’®ï¼Œæ˜¾ç¤ºæš‚åœæŒ‰é’®
            const btn = document.getElementById('lottery-btn');
            btn.style.visibility = 'hidden';
            
            const pauseBtn = document.getElementById('pause-btn');
            pauseBtn.style.display = 'block';
            pauseBtn.textContent = 'â¸ æš‚åœ';
            pauseBtn.classList.remove('paused');

            isLotteryRunning = true;
            isPaused = false;

            console.log('æŠ½å¥–æ¨¡å¼åˆ‡æ¢:', settings.lotteryMode);
            if (settings.lotteryMode === 'slide') {
                showSlideAnimation(availablePeople, prize);
            } else {
                showGatherAnimation(availablePeople, prize);
            }
        }

        function showSlideAnimation(availablePeople, prize) {
            // æ–¹å—æ»‘åŠ¨æŠ½å¥–æ¨¡å¼
            const wall = document.getElementById('people-grid');
            const wallRect = wall.getBoundingClientRect();
            const cols = Math.max(3, Math.floor(wallRect.width / 60));
            
            // è·å–æ‰€æœ‰çº¢åŒ…ä½ç½®
            const packets = wall.querySelectorAll('.red-packet:not(.won)');
            const packetRects = [];
            packets.forEach(p => {
                const rect = p.getBoundingClientRect();
                packetRects.push({
                    element: p,
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2,
                    id: p.querySelector('.name')?.textContent
                });
            });
            
            if (packetRects.length === 0) {
                alert('æ²¡æœ‰å¯æŠ½å¥–çš„äººå‘˜äº†ï¼');
                return;
            }
            
            // åˆ›å»ºæ»‘åŠ¨å±‚
            let slideLayer = document.getElementById('slide-layer');
            if (!slideLayer) {
                slideLayer = document.createElement('div');
                slideLayer.id = 'slide-layer';
                slideLayer.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1000;';
                document.body.appendChild(slideLayer);
            }
            slideLayer.innerHTML = '';
            slideLayer.style.pointerEvents = 'auto';
            
            // åˆ›å»ºæŒ‰é’®å®¹å™¨ï¼ˆå±…ä¸­ï¼‰
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:20px;z-index:1001;';
            slideLayer.appendChild(btnContainer);
            
            // åˆ›å»ºåœæ­¢æŒ‰é’®
            const stopBtn = document.createElement('button');
            stopBtn.id = 'slide-stop-btn';
            stopBtn.textContent = 'â¹ åœæ­¢å¹¶æ­æ™“';
            stopBtn.style.cssText = 'padding:15px 35px;font-size:18px;font-weight:bold;background:linear-gradient(135deg, #1dd1a1, #10ac84);color:#fff;border:none;border-radius:50px;cursor:pointer;box-shadow:0 4px 15px rgba(29,209,161,0.4);transition:all 0.3s ease;';
            stopBtn.onmouseover = () => stopBtn.style.transform = 'scale(1.05)';
            stopBtn.onmouseout = () => stopBtn.style.transform = 'scale(1)';
            btnContainer.appendChild(stopBtn);
            
            // åˆ›å»ºå–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.id = 'slide-cancel-btn';
            cancelBtn.textContent = 'âŒ å–æ¶ˆ';
            cancelBtn.style.cssText = 'padding:15px 35px;font-size:18px;font-weight:bold;background:linear-gradient(135deg, #ff6b6b, #ee5a5a);color:#fff;border:none;border-radius:50px;cursor:pointer;box-shadow:0 4px 15px rgba(255,107,107,0.4);transition:all 0.3s ease;';
            cancelBtn.onmouseover = () => cancelBtn.style.transform = 'scale(1.05)';
            cancelBtn.onmouseout = () => cancelBtn.style.transform = 'scale(1)';
            btnContainer.appendChild(cancelBtn);
            
            // å–æ¶ˆæŠ½å¥–åŠŸèƒ½
            window.cancelSlide = () => {
                if (!sliding) return;
                sliding = false;
                clearInterval(slideInterval);
                
                // æ¸…é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
                if (lastHighlightedPacket && lastHighlightedPacket.element) {
                    lastHighlightedPacket.element.classList.remove('slide-highlight');
                }
                packetRects.forEach(packet => {
                    if (packet.element) {
                        packet.element.classList.remove('slide-highlight');
                    }
                });
                
            // æ¸…ç†æ»‘åŠ¨å±‚
            slideLayer.style.pointerEvents = 'none';
            slideLayer.innerHTML = '';
            
            // æ¸…ç†å®šæ—¶å™¨
            if (pauseIntervalId) {
                clearInterval(pauseIntervalId);
                pauseIntervalId = null;
            }
            
            // æ˜¾ç¤ºä¸»æŠ½å¥–æŒ‰é’®
            const lotteryBtn = document.getElementById('lottery-btn');
            lotteryBtn.style.visibility = 'visible';
            isLotteryRunning = false;
            isPaused = false;
            
            // éšè—æš‚åœæŒ‰é’®
            const pauseBtn = document.getElementById('pause-btn');
            pauseBtn.style.display = 'none';
            
            showToast('å·²å–æ¶ˆæŠ½å¥–', 'info');
        };
            
            cancelBtn.onclick = window.cancelSlide;
            
            // åˆ›å»ºæ»‘åŠ¨æ–¹å—
            const tileCount = Math.min(prize.count, availablePeople.length);
            const tiles = [];
            for (let i = 0; i < tileCount; i++) {
                const tile = document.createElement('div');
                tile.className = 'slide-tile';
                tile.style.cssText = 'position:fixed;width:50px;height:50px;background:linear-gradient(145deg, #ffd700, #ff8c00);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#c0392b;font-size:14px;box-shadow:0 4px 15px rgba(255,215,0,0.5);z-index:1000;transform:translate3d(-100px,-100px,0);transition:transform 0.1s ease;';
                tile.innerHTML = 'ğŸ¯';
                slideLayer.appendChild(tile);
                tiles.push({ element: tile, currentTarget: null });
            }
            
            // æ»‘åŠ¨åŠ¨ç”»
            let sliding = true;
            let lastHighlightedPacket = null;

            // ä¿å­˜åŠ¨ç”»æ•°æ®ç”¨äºæš‚åœ/æ¢å¤
            currentAnimationData = {
                availablePeople,
                prize,
                tiles,
                packetRects,
                slideInterval: null
            };

            const slideInterval = setInterval(() => {
                if (!sliding) return;

                tiles.forEach(tileObj => {
                    // éšæœºé€‰æ‹©ç›®æ ‡çº¢åŒ…ä½ç½®
                    const randomPacket = packetRects[Math.floor(Math.random() * packetRects.length)];
                    tileObj.currentTarget = randomPacket;

                    // ç§»é™¤ä¸Šä¸€ä¸ªé«˜äº®
                    if (lastHighlightedPacket && lastHighlightedPacket.element) {
                        lastHighlightedPacket.element.classList.remove('slide-highlight');
                    }

                    // é«˜äº®å½“å‰çº¢åŒ…
                    if (randomPacket.element) {
                        randomPacket.element.classList.add('slide-highlight');
                    }
                    lastHighlightedPacket = randomPacket;

                    tileObj.element.style.transform = `translate3d(${randomPacket.x - 25}px, ${randomPacket.y - 25}px, 0)`;
                });
            }, 80);
            
            currentAnimationData.slideInterval = slideInterval;
            
            // åœæ­¢å¹¶æ­æ™“
            window.stopSlide = () => {
                if (!sliding) return;
                sliding = false;
                clearInterval(slideInterval);
                currentAnimationData.slideInterval = null;
                
                stopBtn.disabled = true;
                stopBtn.textContent = 'â³ æ­æ™“ä¸­...';

                // æ¸…é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
                if (lastHighlightedPacket && lastHighlightedPacket.element) {
                    lastHighlightedPacket.element.classList.remove('slide-highlight');
                }
                packetRects.forEach(packet => {
                    if (packet.element) {
                        packet.element.classList.remove('slide-highlight');
                    }
                });

                // é‡æ–°è·å–æ‰€æœ‰çº¢åŒ…çš„å½“å‰ä½ç½®ï¼ˆé˜²æ­¢é¡µé¢æ»šåŠ¨ç­‰å½±å“ï¼‰
                const currentPackets = wall.querySelectorAll('.red-packet:not(.won)');
                const currentPacketRects = [];
                currentPackets.forEach(p => {
                    const rect = p.getBoundingClientRect();
                    currentPacketRects.push({
                        element: p,
                        x: rect.left + rect.width / 2,
                        y: rect.top + rect.height / 2,
                        id: p.querySelector('.name')?.textContent
                    });
                });

                // ç®€å•é€»è¾‘ï¼šæ»‘å—æœ€ååœæ­¢åœ¨å“ªä¸ªçº¢åŒ…ä¸Šï¼Œå“ªä¸ªçº¢åŒ…é‡Œçš„äººå°±ä¸­å¥–
                const winners = [];
                const winnerPackets = []; // è®°å½•æ¯ä¸ªæ»‘å—å¯¹åº”çš„çº¢åŒ…

                // ä¸ºæ¯ä¸ªæ»‘å—æ‰¾åˆ°æœ€è¿‘çš„çº¢åŒ…
                tiles.forEach((tileObj, tileIndex) => {
                    // è·å–æ»‘å—çš„å®é™…ä½ç½®
                    const tileRect = tileObj.element.getBoundingClientRect();
                    const tileCenterX = tileRect.left + tileRect.width / 2;
                    const tileCenterY = tileRect.top + tileRect.height / 2;

                    // æ‰¾åˆ°è·ç¦»æœ€è¿‘çš„çº¢åŒ…
                    let closestPacket = null;
                    let minDistance = Infinity;

                    currentPacketRects.forEach((packet, packetIndex) => {
                        const distance = Math.sqrt(
                            Math.pow(tileCenterX - packet.x, 2) +
                            Math.pow(tileCenterY - packet.y, 2)
                        );
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestPacket = packet;
                        }
                    });

                    // è®°å½•è¿™ä¸ªæ»‘å—å¯¹åº”çš„çº¢åŒ…
                    winnerPackets.push(closestPacket);

                    // è¿™ä¸ªçº¢åŒ…é‡Œçš„äººå°±æ˜¯ä¸­å¥–è€…
                    if (closestPacket && closestPacket.id) {
                        const winner = availablePeople.find(p => p.name === closestPacket.id);
                        if (winner) {
                            winners.push(winner);
                        }
                    }
                });
                
                // å»¶è¿Ÿåæ­æ™“ç»“æœ
                setTimeout(() => {
                    // é‡æ–°è·å–æ‰€æœ‰çº¢åŒ…çš„å½“å‰ä½ç½®
                    const currentPackets = wall.querySelectorAll('.red-packet:not(.won)');
                    const currentPacketRects = [];
                    currentPackets.forEach(p => {
                        const rect = p.getBoundingClientRect();
                        currentPacketRects.push({
                            element: p,
                            x: rect.left + rect.width / 2,
                            y: rect.top + rect.height / 2,
                            id: p.querySelector('.name')?.textContent
                        });
                    });

                    // ä¸ºæ¯ä¸ªä¸­å¥–è€…ä½¿ç”¨ä¹‹å‰è®°å½•çš„çº¢åŒ…æ˜¾ç¤ºç»“æœ
                    winners.forEach((winner, index) => {
                        const stoppedPacket = winnerPackets[index];

                        // é«˜äº®åœæ­¢ä½ç½®çš„çº¢åŒ…ä¸ºä¸­å¥–çº¢åŒ…
                        if (stoppedPacket && stoppedPacket.element) {
                            stoppedPacket.element.classList.add('won');
                            // æ›´æ–°æ­£é¢æ˜¾ç¤ºå§“åå’Œå¥–é¡¹
                            const frontFace = stoppedPacket.element.querySelector('.front');
                            if (frontFace) {
                                frontFace.innerHTML = `<span class="won-prize">${prize.name}</span><span class="won-name">${winner.name}</span>`;
                            }
                        }

                        // æ›´æ–°æ–¹å—æ˜¾ç¤º
                        const tileObj = tiles[index];
                        if (tileObj && tileObj.element) {
                            tileObj.element.innerHTML = `âœ…`;
                            tileObj.element.style.background = 'linear-gradient(145deg, #2ecc71, #27ae60)';
                        }

                        // æ›´æ–°äººå‘˜æ•°æ®
                        const personIndex = people.findIndex(p => p.id === winner.id);
                        if (personIndex !== -1) {
                            people[personIndex].prize = prize.name;
                        }
                    });
                    
                    // æ ‡è®°å¥–é¡¹å·²å‘æ”¾
                    prize.awarded = true;
                    currentPrizeIndex = null;
                    
                    // ä¿å­˜æ•°æ®
                    saveData();
                    
                    // æ˜¾ç¤ºä¸­å¥–å¼¹çª—
                    setTimeout(() => {
                        renderAll();
                        showWinners(prize, winners);
                        
                        // æ¸…ç†æ»‘åŠ¨å±‚
                        setTimeout(() => {
                            slideLayer.style.pointerEvents = 'none';
                            slideLayer.innerHTML = '';
                        }, 500);
                        
                        // é‡ç½®æŒ‰é’®çŠ¶æ€
                        const btn = document.getElementById('lottery-btn');
                        btn.disabled = false;
                        btn.textContent = 'ğŸ° å¼€å§‹æŠ½å¥–';
                        btn.classList.remove('running');
                        btn.style.visibility = 'visible';
                        isLotteryRunning = false;
                        isPaused = false;
                        
                        // éšè—æš‚åœæŒ‰é’®
                        const pauseBtn = document.getElementById('pause-btn');
                        pauseBtn.style.display = 'none';
                        
                         // æ¸…ç†å®šæ—¶å™¨
                         if (pauseIntervalId) {
                             clearInterval(pauseIntervalId);
                             pauseIntervalId = null;
                         }
                         
                         // æ¸…ç†æ»‘åŠ¨åŠ¨ç”»å®šæ—¶å™¨
                         if (currentAnimationData.slideInterval) {
                             clearInterval(currentAnimationData.slideInterval);
                             currentAnimationData.slideInterval = null;
                         }
                        
                        showToast('æŠ½å¥–å®Œæˆï¼', 'success');
                    }, 300);
                }, 500);
            };
        }

        // æ˜¾ç¤ºä¸­å¥–å¼¹çª—
        function showWinners(prize, winners) {
            const modal = document.getElementById('winner-modal');
            document.getElementById('winner-prize').textContent = `ã€${prize.name}ã€‘${prize.desc}`;
            document.getElementById('winner-names').innerHTML = winners.map(w =>
                `<div class="winner-name">${w.name}</div>`
            ).join('');
            modal.classList.add('active');
        }

        // å…³é—­ä¸­å¥–å¼¹çª—
        function closeWinnerModal() {
            const modal = document.getElementById('winner-modal');
            modal.classList.remove('active');
            
            // å¦‚æœæ˜¯è™šæ‹Ÿæ»šåŠ¨ï¼Œé‡æ–°è®¡ç®—å¯è§é¡¹ç›®
            if (virtualScrollConfig.enabled && people.length >= 200) {
                setTimeout(() => updateVirtualVisibleItems(), 100);
            }
        }

        /**
         * åˆ‡æ¢å†å²è®°å½•é¢æ¿
         * 
         * åŠŸèƒ½ï¼š
         * 1. æ‰“å¼€/å…³é—­å†å²è®°å½•é¢æ¿
         * 2. é¢æ¿æ‰“å¼€æ—¶è‡ªåŠ¨æ¸²æŸ“å†å²è®°å½•
         * 3. é¢æ¿å…³é—­æ—¶æ¸…ç†å†…å®¹
         * 
         * @returns {void}
         */
        function toggleHistoryPanel() {
            const panel = document.getElementById('history-panel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                renderHistory();
                
                // å¦‚æœæ˜¯è™šæ‹Ÿæ»šåŠ¨ï¼Œé‡æ–°è®¡ç®—å¯è§é¡¹ç›®
                if (historyVirtualScrollConfig.enabled && appState.history.length >= 50) {
                    setTimeout(() => updateHistoryVirtualVisibleItems(), 100);
                }
            } else {
                // å…³é—­æ—¶æ¸…ç†è™šæ‹Ÿæ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨
                if (historyVirtualScrollConfig.container) {
                    historyVirtualScrollConfig.container.removeEventListener('scroll', handleHistoryVirtualScroll);
                    historyVirtualScrollConfig.container = null;
                }
            }
        }

        // å…³é—­å†å²è®°å½•é¢æ¿
        function closeHistoryPanel() {
            const panel = document.getElementById('history-panel');
            panel.classList.remove('active');
            
            // æ¸…ç†è™šæ‹Ÿæ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨
            if (historyVirtualScrollConfig.container) {
                historyVirtualScrollConfig.container.removeEventListener('scroll', handleHistoryVirtualScroll);
                historyVirtualScrollConfig.container = null;
            }
        }

        // è™šæ‹Ÿæ»šåŠ¨é…ç½®
        const virtualScrollConfig = {
            enabled: true, // æ˜¯å¦å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
            itemHeight: 68, // æ¯ä¸ªé¡¹ç›®çš„é«˜åº¦ï¼ˆåŒ…å«é—´è·ï¼‰
            buffer: 10, // ä¸Šä¸‹ç¼“å†²åŒºæ•°é‡
            container: null, // å®¹å™¨å…ƒç´ 
            items: [], // æ‰€æœ‰é¡¹ç›®æ•°æ®
            visibleItems: [], // å½“å‰å¯è§é¡¹ç›®
            scrollTop: 0, // æ»šåŠ¨ä½ç½®
            isScrolling: false, // æ˜¯å¦æ­£åœ¨æ»šåŠ¨
            scrollTimeout: null // æ»šåŠ¨å»¶è¿Ÿ
        };

        // è™šæ‹Ÿæ»šåŠ¨é…ç½®ï¼ˆå†å²è®°å½•ï¼‰
        const historyVirtualScrollConfig = {
            enabled: true,
            itemHeight: 120,
            buffer: 5,
            container: null,
            items: [],
            visibleItems: [],
            scrollTop: 0,
            isScrolling: false,
            scrollTimeout: null
        };

        /**
         * æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
         * 
         * åŠŸèƒ½ï¼š
         * 1. æ˜¾ç¤ºæ‰€æœ‰æŠ½å¥–å†å²è®°å½•
         * 2. æ˜¾ç¤ºä¸­å¥–è€…å§“å
         * 3. æ˜¾ç¤ºæŠ½å¥–æ—¶é—´
         * 4. æ˜¾ç¤ºæ’¤é”€çŠ¶æ€
         * 5. æä¾›æ’¤é”€æŒ‰é’®ï¼ˆæœªæ’¤é”€çš„è®°å½•ï¼‰
         * 
         * æ•°æ®æ ¼å¼ï¼š
         * {
         *   prizeName: string,      // å¥–é¡¹åç§°
         *   prizeDesc: string,      // å¥–é¡¹æè¿°
         *   winners: string[],      // ä¸­å¥–è€…å§“åæ•°ç»„
         *   time: string,           // æŠ½å¥–æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
         *   revoked: boolean        // æ˜¯å¦å·²æ’¤é”€
         * }
         * 
         * æ€§èƒ½ä¼˜åŒ–ï¼š
         * - ä½¿ç”¨ DocumentFragment å‡å°‘ DOM æ“ä½œ
         * - ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ›¿ä»£æ¯ä¸ªæŒ‰é’®ç»‘å®šäº‹ä»¶
         * 
         * @returns {void}
         */
        // è™šæ‹Ÿæ»šåŠ¨é…ç½®ï¼ˆå†å²è®°å½•ï¼‰
        const historyVirtualScrollConfig = {
            enabled: true,
            itemHeight: 120,
            buffer: 5,
            container: null,
            items: [],
            visibleItems: [],
            scrollTop: 0,
            isScrolling: false,
            scrollTimeout: null
        };

        function renderHistory() {
            const container = document.getElementById('history-list');
            
            // åˆå§‹åŒ–è™šæ‹Ÿæ»šåŠ¨é…ç½®
            if (!historyVirtualScrollConfig.container) {
                historyVirtualScrollConfig.container = container;
                historyVirtualScrollConfig.items = appState.history;
            } else {
                historyVirtualScrollConfig.items = appState.history;
            }
            
            // æ¸…ç©ºå®¹å™¨
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            if (appState.history.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="icon">ğŸ“œ</div>
                    <p>æš‚æ— å†å²è®°å½•</p>
                `;
                container.appendChild(emptyState);
                return;
            }

            // å¦‚æœæ•°æ®é‡å°äºé˜ˆå€¼ï¼Œä½¿ç”¨æ™®é€šæ¸²æŸ“
            if (appState.history.length < 50) {
                renderHistoryNormal(container);
                return;
            }

            // ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨æ¸²æŸ“
            renderHistoryVirtual(container);
        }

        // æ™®é€šæ¸²æŸ“ï¼ˆå°æ•°æ®é‡ï¼‰
        function renderHistoryNormal(container) {
            const fragment = document.createDocumentFragment();

            appState.history.forEach((item, index) => {
                const time = new Date(item.time).toLocaleString('zh-CN');
                const isRevoked = item.revoked;

                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${isRevoked ? 'revoked' : ''}`;

                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <span class="history-item-prize">${item.prizeName}</span>
                        <span class="history-item-time">${time}</span>
                    </div>
                    <div class="history-item-winners">
                        <strong>ä¸­å¥–è€…ï¼š</strong>${item.winners.join('ã€')}
                        ${isRevoked ? ' <span style="color:#ff6b6b;">(å·²æ’¤é”€)</span>' : ''}
                    </div>
                    ${!isRevoked ? `
                        <div class="history-item-actions">
                            <button class="revoke-btn" data-index="${index}">æ’¤é”€ä¸­å¥–</button>
                        </div>
                    ` : ''}
                `;

                fragment.appendChild(historyItem);
            });

            container.appendChild(fragment);

            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ’¤é”€æŒ‰é’®ç‚¹å‡»
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('revoke-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    revokeWinner(index);
                }
            });

            // å¦‚æœæ˜¯è™šæ‹Ÿæ»šåŠ¨ï¼Œéœ€è¦é‡æ–°è®¡ç®—å¯è§é¡¹ç›®
            if (historyVirtualScrollConfig.enabled && appState.history.length >= 50) {
                updateHistoryVirtualVisibleItems();
            }
        }

        // è™šæ‹Ÿæ»šåŠ¨æ¸²æŸ“ï¼ˆå¤§æ•°æ®é‡ï¼‰
        function renderHistoryVirtual(container) {
            // è®¾ç½®å®¹å™¨é«˜åº¦ä»¥æ”¯æŒæ»šåŠ¨
            const totalHeight = appState.history.length * historyVirtualScrollConfig.itemHeight;
            container.style.height = totalHeight + 'px';
            container.style.position = 'relative';
            container.style.overflowY = 'auto';

            // åˆ›å»ºå¯è§åŒºåŸŸå®¹å™¨
            const visibleContainer = document.createElement('div');
            visibleContainer.className = 'virtual-visible-container';
            visibleContainer.style.position = 'absolute';
            visibleContainer.style.top = '0';
            visibleContainer.style.left = '0';
            visibleContainer.style.width = '100%';
            visibleContainer.style.height = '100%';
            container.appendChild(visibleContainer);

            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            container.addEventListener('scroll', handleHistoryVirtualScroll);
            
            // åˆå§‹æ¸²æŸ“
            updateHistoryVirtualVisibleItems();
        }

        // å¤„ç†å†å²è®°å½•è™šæ‹Ÿæ»šåŠ¨
        function handleHistoryVirtualScroll() {
            historyVirtualScrollConfig.isScrolling = true;
            historyVirtualScrollConfig.scrollTop = historyVirtualScrollConfig.container.scrollTop;

            // ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æ€§èƒ½
            if (historyVirtualScrollConfig.scrollTimeout) {
                clearTimeout(historyVirtualScrollConfig.scrollTimeout);
            }

            historyVirtualScrollConfig.scrollTimeout = setTimeout(() => {
                updateHistoryVirtualVisibleItems();
                historyVirtualScrollConfig.isScrolling = false;
            }, 50);
        }

        // æ›´æ–°å†å²è®°å½•å¯è§é¡¹ç›®
        function updateHistoryVirtualVisibleItems() {
            const container = historyVirtualScrollConfig.container;
            const visibleContainer = container.querySelector('.virtual-visible-container');
            if (!visibleContainer) return;

            const scrollTop = container.scrollTop;
            const containerHeight = container.clientHeight;
            
            // è®¡ç®—å¯è§èŒƒå›´
            const startIndex = Math.max(0, Math.floor(scrollTop / historyVirtualScrollConfig.itemHeight) - historyVirtualScrollConfig.buffer);
            const endIndex = Math.min(
                historyVirtualScrollConfig.items.length - 1,
                Math.ceil((scrollTop + containerHeight) / historyVirtualScrollConfig.itemHeight) + historyVirtualScrollConfig.buffer
            );

            // æ¸…ç©ºå¯è§å®¹å™¨
            while (visibleContainer.firstChild) {
                visibleContainer.removeChild(visibleContainer.firstChild);
            }

            // åˆ›å»ºå¯è§é¡¹ç›®
            const fragment = document.createDocumentFragment();
            
            for (let i = startIndex; i <= endIndex; i++) {
                const item = historyVirtualScrollConfig.items[i];
                const time = new Date(item.time).toLocaleString('zh-CN');
                const isRevoked = item.revoked;

                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${isRevoked ? 'revoked' : ''}`;
                
                // è®¾ç½®ä½ç½®
                historyItem.style.position = 'absolute';
                historyItem.style.top = (i * historyVirtualScrollConfig.itemHeight) + 'px';
                historyItem.style.left = '0';
                historyItem.style.width = '100%';
                historyItem.style.height = (historyVirtualScrollConfig.itemHeight - 10) + 'px';

                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <span class="history-item-prize">${item.prizeName}</span>
                        <span class="history-item-time">${time}</span>
                    </div>
                    <div class="history-item-winners">
                        <strong>ä¸­å¥–è€…ï¼š</strong>${item.winners.join('ã€')}
                        ${isRevoked ? ' <span style="color:#ff6b6b;">(å·²æ’¤é”€)</span>' : ''}
                    </div>
                    ${!isRevoked ? `
                        <div class="history-item-actions">
                            <button class="revoke-btn" data-index="${i}">æ’¤é”€ä¸­å¥–</button>
                        </div>
                    ` : ''}
                `;

                fragment.appendChild(historyItem);
            }

            visibleContainer.appendChild(fragment);

            // é‡æ–°è®¡ç®—å°ºå¯¸/å¸ƒå±€
            setTimeout(() => adjustPacketSize(), 0);
        }

        // æ¸…ç†è™šæ‹Ÿæ»šåŠ¨
        function cleanupVirtualScroll() {
            if (virtualScrollConfig.container) {
                virtualScrollConfig.container.removeEventListener('scroll', handleVirtualScroll);
                virtualScrollConfig.container = null;
            }
            if (virtualScrollConfig.scrollTimeout) {
                clearTimeout(virtualScrollConfig.scrollTimeout);
                virtualScrollConfig.scrollTimeout = null;
            }
            
            if (historyVirtualScrollConfig.container) {
                historyVirtualScrollConfig.container.removeEventListener('scroll', handleHistoryVirtualScroll);
                historyVirtualScrollConfig.container = null;
            }
            if (historyVirtualScrollConfig.scrollTimeout) {
                clearTimeout(historyVirtualScrollConfig.scrollTimeout);
                historyVirtualScrollConfig.scrollTimeout = null;
            }
        }

        // è™šæ‹Ÿæ»šåŠ¨é…ç½®
        const virtualScrollConfig = {
            enabled: true, // æ˜¯å¦å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
            itemHeight: 68, // æ¯ä¸ªé¡¹ç›®çš„é«˜åº¦ï¼ˆåŒ…å«é—´è·ï¼‰
            buffer: 10, // ä¸Šä¸‹ç¼“å†²åŒºæ•°é‡
            container: null, // å®¹å™¨å…ƒç´ 
            items: [], // æ‰€æœ‰é¡¹ç›®æ•°æ®
            visibleItems: [], // å½“å‰å¯è§é¡¹ç›®
            scrollTop: 0, // æ»šåŠ¨ä½ç½®
            isScrolling: false, // æ˜¯å¦æ­£åœ¨æ»šåŠ¨
            scrollTimeout: null // æ»šåŠ¨å»¶è¿Ÿ
        };

        // è™šæ‹Ÿæ»šåŠ¨é…ç½®ï¼ˆå†å²è®°å½•ï¼‰
        const historyVirtualScrollConfig = {
            enabled: true,
            itemHeight: 120,
            buffer: 5,
            container: null,
            items: [],
            visibleItems: [],
            scrollTop: 0,
            isScrolling: false,
            scrollTimeout: null
        };
            });
        }

        /**
         * æ’¤é”€ä¸­å¥–è®°å½•
         * 
         * åŠŸèƒ½ï¼š
         * 1. æ’¤é”€æŒ‡å®šçš„ä¸­å¥–è®°å½•
         * 2. æ¢å¤ä¸­å¥–äººå‘˜çš„æŠ½å¥–èµ„æ ¼
         * 3. æ¢å¤å¥–é¡¹çš„æŠ½å¥–èµ„æ ¼
         * 4. æ ‡è®°è®°å½•ä¸ºå·²æ’¤é”€
         * 5. ä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
         * 
         * æ’¤é”€é€»è¾‘ï¼š
         * 1. æ‰¾åˆ°å†å²è®°å½•
         * 2. æ£€æŸ¥æ˜¯å¦å·²æ’¤é”€
         * 3. éå†ä¸­å¥–è€…ï¼Œæ¢å¤æŠ½å¥–èµ„æ ¼
         * 4. æ¢å¤å¥–é¡¹çŠ¶æ€
         * 5. æ ‡è®°è®°å½•ä¸ºå·²æ’¤é”€
         * 6. ä¿å­˜æ•°æ®
         * 7. é‡æ–°æ¸²æŸ“æ‰€æœ‰å†…å®¹
         * 
         * @param {number} historyIndex - å†å²è®°å½•ç´¢å¼•
         * @returns {void}
         */
        function revokeWinner(historyIndex) {
            if (!confirm('ç¡®å®šè¦æ’¤é”€è¿™ä¸ªä¸­å¥–è®°å½•å—ï¼Ÿ')) {
                return;
            }

            const record = history[historyIndex];
            if (record.revoked) {
                showToast('è¯¥è®°å½•å·²æ’¤é”€', 'warning');
                return;
            }

            // æ¢å¤ä¸­å¥–äººå‘˜çš„æŠ½å¥–èµ„æ ¼
            record.winners.forEach(winnerName => {
                const personIndex = people.findIndex(p => p.name === winnerName);
                if (personIndex !== -1) {
                    people[personIndex].prize = null;
                }
            });

            // æ¢å¤å¥–é¡¹çš„æŠ½å¥–èµ„æ ¼
            const prizeIndex = prizes.findIndex(p => p.name === record.prizeName);
            if (prizeIndex !== -1) {
                prizes[prizeIndex].awarded = false;
            }

            // æ ‡è®°è®°å½•ä¸ºå·²æ’¤é”€
            record.revoked = true;

            // ä¿å­˜æ•°æ®
            saveData();

            // é‡æ–°æ¸²æŸ“
            renderAll();
            renderHistory();

            showToast('ä¸­å¥–è®°å½•å·²æ’¤é”€', 'success');
        }
        }

        // åˆ‡æ¢æš‚åœçŠ¶æ€
        function togglePause() {
            const pauseBtn = document.getElementById('pause-btn');
            
            if (!isPaused) {
                // æš‚åœ
                isPaused = true;
                pauseBtn.textContent = 'â–¶ï¸ ç»§ç»­';
                pauseBtn.classList.add('paused');
                
                // æ¸…é™¤åŠ¨ç”»
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (pauseIntervalId) {
                    clearInterval(pauseIntervalId);
                    pauseIntervalId = null;
                }
                
                 showToast('å·²æš‚åœ', 'info');
             } else {
                 // ç»§ç»­
                 isPaused = false;
                 pauseBtn.textContent = 'â¸ æš‚åœ';
                 pauseBtn.classList.remove('paused');
                 
                 // æ¢å¤åŠ¨ç”»
                 if (currentAnimationData) {
                     if (settings.lotteryMode === 'slide') {
                         resumeSlideAnimation();
                     } else {
                         resumeGatherAnimation();
                     }
                 }
                 
                 showToast('å·²ç»§ç»­', 'success');
             }
         }
 
         // æ¢å¤æ»‘å—åŠ¨ç”»
         function resumeSlideAnimation() {
             if (!currentAnimationData) return;
             
             const { availablePeople, prize, tiles, packetRects, slideInterval } = currentAnimationData;
             
             // æ¸…ç†æ—§çš„å®šæ—¶å™¨
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // é‡æ–°å¼€å§‹æ»‘åŠ¨åŠ¨ç”»
             pauseIntervalId = setInterval(() => {
                 if (isPaused) return;
                 
                 tiles.forEach(tileObj => {
                     // éšæœºé€‰æ‹©ç›®æ ‡çº¢åŒ…ä½ç½®
                     const randomPacket = packetRects[Math.floor(Math.random() * packetRects.length)];
                     tileObj.currentTarget = randomPacket;
                    
                    tileObj.element.style.transform = `translate3d(${randomPacket.x - 25}px, ${randomPacket.y - 25}px, 0)`;
                });
            }, 80);
        }

        // æ¢å¤çƒä½“åŠ¨ç”»
        function resumeGatherAnimation() {
            if (!currentAnimationData) return;
            
            const { availablePeople, prize } = currentAnimationData;
            
            // é‡æ–°å¼€å§‹çƒä½“åŠ¨ç”»
            showGatherAnimation(availablePeople, prize);
        }

         // æ¢å¤æ»‘å—åŠ¨ç”»
         function resumeSlideAnimation() {
             if (!currentAnimationData) return;
             
             const { availablePeople, prize, tiles, packetRects, slideInterval } = currentAnimationData;
             
             // æ¸…ç†æ—§çš„å®šæ—¶å™¨
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // é‡æ–°å¼€å§‹æ»‘åŠ¨åŠ¨ç”»
             pauseIntervalId = setInterval(() => {
                 if (isPaused) return;
                 
                 tiles.forEach(tileObj => {
                     // éšæœºé€‰æ‹©ç›®æ ‡çº¢åŒ…ä½ç½®
                     const randomPacket = packetRects[Math.floor(Math.random() * packetRects.length)];
                     tileObj.currentTarget = randomPacket;
                     
                     tileObj.element.style.transform = `translate3d(${randomPacket.x - 25}px, ${randomPacket.y - 25}px, 0)`;
                 });
             }, 80);
         }
 
         // æ¢å¤çƒä½“åŠ¨ç”»
         function resumeGatherAnimation() {
             if (!currentAnimationData) return;
             
             const { availablePeople, prize } = currentAnimationData;
             
             // æ¸…ç†æ—§çš„å®šæ—¶å™¨
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // é‡æ–°å¼€å§‹çƒä½“åŠ¨ç”»
             showGatherAnimation(availablePeople, prize);
         }

        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        function checkCompatibility() {
            const warnings = [];

            // æ£€æŸ¥ localStorage
            if (!window.localStorage) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ LocalStorage');
            }

            // æ£€æŸ¥ CSS3 æ”¯æŒ
            const testDiv = document.createElement('div');
            if (!('transform' in testDiv.style)) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ CSS3 Transform');
            }

            if (!('backfaceVisibility' in testDiv.style)) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ backface-visibility');
            }

            // æ£€æŸ¥ ES6 æ”¯æŒ
            try {
                new Function('const test = () => {}');
            } catch (e) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ ES6 è¯­æ³•');
            }

            if (warnings.length > 0) {
                const check = document.getElementById('compatibility-check');
                check.textContent = 'âš ï¸ æ£€æµ‹åˆ°æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼š' + warnings.join('ã€');
                check.classList.add('show');
                setTimeout(() => check.classList.remove('show'), 5000);
            }
        }

        // æ˜¾ç¤ºæ•°æ®å¤‡ä»½æé†’
        function showBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.add('show');
        }

        // å…³é—­æ•°æ®å¤‡ä»½æé†’
        function closeBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.remove('show');
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½
        function checkBackupNeeded() {
            // å¦‚æœæœ‰æ•°æ®ä¸”è¶…è¿‡7å¤©æœªå¤‡ä»½ï¼Œæ˜¾ç¤ºæé†’
            const lastBackup = localStorage.getItem('lastBackupTime');
            const now = Date.now();
            
            if (people.length > 0 || prizes.length > 0) {
                if (!lastBackup || (now - parseInt(lastBackup)) > 7 * 24 * 60 * 60 * 1000) {
                    setTimeout(() => showBackupReminder(), 2000);
                }
            }
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            const container = document.getElementById('history-list');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“œ</div>
                        <p>æš‚æ— å†å²è®°å½•</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.map((item, index) => {
                const time = new Date(item.time).toLocaleString('zh-CN');
                const isRevoked = item.revoked;
                
                return `
                    <div class="history-item ${isRevoked ? 'revoked' : ''}">
                        <div class="history-item-header">
                            <span class="history-item-prize">${item.prizeName}</span>
                            <span class="history-item-time">${time}</span>
                        </div>
                        <div class="history-item-winners">
                            <strong>ä¸­å¥–è€…ï¼š</strong>${item.winners.join('ã€')}
                            ${isRevoked ? ' <span style="color:#ff6b6b;">(å·²æ’¤é”€)</span>' : ''}
                        </div>
                        ${!isRevoked ? `
                            <div class="history-item-actions">
                                <button class="revoke-btn" onclick="revokeWinner(${index})">æ’¤é”€ä¸­å¥–</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ’¤é”€ä¸­å¥–
        function revokeWinner(historyIndex) {
            if (!confirm('ç¡®å®šè¦æ’¤é”€è¿™ä¸ªä¸­å¥–è®°å½•å—ï¼Ÿ')) {
                return;
            }

            const record = history[historyIndex];
            if (record.revoked) {
                showToast('è¯¥è®°å½•å·²æ’¤é”€', 'warning');
                return;
            }

            // æ¢å¤ä¸­å¥–äººå‘˜çš„æŠ½å¥–èµ„æ ¼
            record.winners.forEach(winnerName => {
                const personIndex = people.findIndex(p => p.name === winnerName);
                if (personIndex !== -1) {
                    people[personIndex].prize = null;
                }
            });

            // æ¢å¤å¥–é¡¹çš„æŠ½å¥–èµ„æ ¼
            const prizeIndex = prizes.findIndex(p => p.name === record.prizeName);
            if (prizeIndex !== -1) {
                prizes[prizeIndex].awarded = false;
            }

            // æ ‡è®°è®°å½•ä¸ºå·²æ’¤é”€
            record.revoked = true;

            // ä¿å­˜æ•°æ®
            saveData();

            // é‡æ–°æ¸²æŸ“
            renderAll();
            renderHistory();

            showToast('ä¸­å¥–è®°å½•å·²æ’¤é”€', 'success');
        }

        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        function checkCompatibility() {
            const warnings = [];

            // æ£€æŸ¥ localStorage
            if (!window.localStorage) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ LocalStorage');
            }

            // æ£€æŸ¥ CSS3 æ”¯æŒ
            const testDiv = document.createElement('div');
            if (!('transform' in testDiv.style)) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ CSS3 Transform');
            }

            if (!('backfaceVisibility' in testDiv.style)) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ backface-visibility');
            }

            // æ£€æŸ¥ ES6 æ”¯æŒ
            try {
                new Function('const test = () => {}');
            } catch (e) {
                warnings.push('æµè§ˆå™¨ä¸æ”¯æŒ ES6 è¯­æ³•');
            }

            if (warnings.length > 0) {
                const check = document.getElementById('compatibility-check');
                check.textContent = 'âš ï¸ æ£€æµ‹åˆ°æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼š' + warnings.join('ã€');
                check.classList.add('show');
                setTimeout(() => check.classList.remove('show'), 5000);
            }
        }

        // æ˜¾ç¤ºæ•°æ®å¤‡ä»½æé†’
        function showBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.add('show');
        }

        // å…³é—­æ•°æ®å¤‡ä»½æé†’
        function closeBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.remove('show');
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½
        function checkBackupNeeded() {
            // å¦‚æœæœ‰æ•°æ®ä¸”è¶…è¿‡7å¤©æœªå¤‡ä»½ï¼Œæ˜¾ç¤ºæé†’
            const lastBackup = localStorage.getItem('lastBackupTime');
            const now = Date.now();
            
            if (appState.people.length > 0 || appState.prizes.length > 0) {
                if (!lastBackup || (now - parseInt(lastBackup)) > 7 * 24 * 60 * 60 * 1000) {
                    setTimeout(() => showBackupReminder(), 2000);
                }
            }
        }

        function showGatherAnimation(availablePeople, prize) {
            const container = document.getElementById('ball-container');
            const ball = document.getElementById('lottery-ball');
            container.classList.add('active');
            ball.innerHTML = '';
            ball.style.animation = 'none';
            ball.style.transform = 'rotateY(0deg)';

            // æ¸…ç†ä¹‹å‰çš„åŠ¨ç”»
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            currentAnimationData = { availablePeople, prize };

            const count = availablePeople.length;
            if (count === 0) {
                alert('æ²¡æœ‰å¯æŠ½å¥–çš„äººå‘˜äº†ï¼');
                container.classList.remove('active');
                document.getElementById('lottery-btn').style.visibility = 'visible';
                return;
            }

            const radius = 380;
            const phi = Math.PI * (3 - Math.sqrt(5));

            for (let i = 0; i < count; i++) {
                const y = 1 - (i / (count - 1)) * 2;
                const radiusAtY = Math.sqrt(1 - y * y);
                const theta = phi * i;

                const x = Math.cos(theta) * radiusAtY * radius;
                const z = Math.sin(theta) * radiusAtY * radius;

                const item = document.createElement('div');
                item.className = 'ball-item gather';
                item.innerHTML = `<span class="name">${availablePeople[i].name}</span>`;
                item.dataset.theta = theta;
                item.dataset.yPos = y * radius;
                ball.appendChild(item);
            }

            setTimeout(() => {
                const items = ball.querySelectorAll('.ball-item');
                items.forEach((item, idx) => {
                    const x = parseFloat(Math.cos(item.dataset.theta) * Math.sqrt(1 - Math.pow(item.dataset.yPos / radius, 2)) * radius);
                    const y = parseFloat(item.dataset.yPos);
                    const z = parseFloat(Math.sin(item.dataset.theta) * Math.sqrt(1 - Math.pow(item.dataset.yPos / radius, 2)) * radius);
                    const theta = parseFloat(item.dataset.theta);

                    const angleX = 90;
                    const angleY = theta * (180 / Math.PI);

                    item.style.transform = `translate3d(${x}px, ${y}px, ${z}px) rotateX(${angleX}deg) rotateY(${angleY}deg)`;
                });
            }, 50);

            setTimeout(() => {
                ball.style.animation = 'rotateY 2s linear infinite';
            }, 1000);
        }

        function stopLottery() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            const ball = document.getElementById('lottery-ball');
            ball.style.animation = 'none';

            const { availablePeople, prize } = currentAnimationData;
            const winnerCount = Math.min(prize.count, availablePeople.length);
            const shuffled = [...availablePeople].sort(() => Math.random() - 0.5);
            const winners = shuffled.slice(0, winnerCount);

            winners.forEach(winner => {
                const index = people.findIndex(p => p.id === winner.id);
                if (index !== -1) people[index].prize = prize.name;
            });

            prize.awarded = true;
            history.unshift({
                prizeName: prize.name,
                prizeDesc: prize.desc,
                winners: winners.map(w => w.name),
                time: new Date().toISOString()
            });

            saveData();
            currentPrizeIndex = null;
            renderAll();

            document.getElementById('ball-container').classList.remove('active');

            setTimeout(() => {
                showWinners(prize, winners);
                launchFireworks();
            }, 300);

            const btn = document.getElementById('lottery-btn');
            btn.disabled = false;
            btn.textContent = 'ğŸ° å¼€å§‹æŠ½å¥–';
            btn.classList.remove('running');
            btn.style.visibility = 'visible';
            isLotteryRunning = false;
            isPaused = false;
            
             // éšè—æš‚åœæŒ‰é’®
             const pauseBtn = document.getElementById('pause-btn');
             pauseBtn.style.display = 'none';
             
             // æ¸…ç†å®šæ—¶å™¨
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // æ¸…ç†æ»‘åŠ¨åŠ¨ç”»å®šæ—¶å™¨
             if (currentAnimationData && currentAnimationData.slideInterval) {
                 clearInterval(currentAnimationData.slideInterval);
                 currentAnimationData.slideInterval = null;
             }
             
             showToast('æŠ½å¥–å®Œæˆï¼', 'success');
        }

        function cancelLottery() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            const ball = document.getElementById('lottery-ball');
            ball.style.animation = 'none';

            document.getElementById('ball-container').classList.remove('active');

            const btn = document.getElementById('lottery-btn');
            btn.disabled = false;
            btn.textContent = 'ğŸ° å¼€å§‹æŠ½å¥–';
            btn.classList.remove('running');
            btn.style.visibility = 'visible';
            isLotteryRunning = false;
            isPaused = false;
            
             // éšè—æš‚åœæŒ‰é’®
             const pauseBtn = document.getElementById('pause-btn');
             pauseBtn.style.display = 'none';
             
             // æ¸…ç†å®šæ—¶å™¨
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // æ¸…ç†æ»‘åŠ¨åŠ¨ç”»å®šæ—¶å™¨
             if (currentAnimationData && currentAnimationData.slideInterval) {
                 clearInterval(currentAnimationData.slideInterval);
                 currentAnimationData.slideInterval = null;
             }
             
             showToast('å·²å–æ¶ˆæŠ½å¥–', 'info');
        }

        function showWinners(prize, winners) {
            const modal = document.getElementById('winner-modal');
            document.getElementById('winner-prize').textContent = `ã€${prize.name}ã€‘${prize.desc}`;
            document.getElementById('winner-names').innerHTML = winners.map(w =>
                `<div class="winner-name">${w.name}</div>`
            ).join('');
            modal.classList.add('active');
        }

        document.getElementById('winner-modal').addEventListener('click', (e) => {
            // åªæœ‰ç‚¹å‡»å¼¹çª—èƒŒæ™¯ï¼ˆéå†…å®¹åŒºåŸŸï¼‰æ‰å…³é—­
            if (e.target.id === 'winner-modal') {
                closeWinnerModal();
            }
        });

        function launchFireworks() {
            const container = document.getElementById('fireworks-container');
            const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#1dd1a1', '#ff6ff3'];

            for (let i = 0; i < 50; i++) {
                setTimeout(() => createFirework(container, colors), i * 100);
            }
        }

        function createFirework(container, colors) {
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight * 0.6;
            const color = colors[Math.floor(Math.random() * colors.length)];

            const center = document.createElement('div');
            center.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:8px;height:8px;background:${color};border-radius:50%;`;
            container.appendChild(center);

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                const angle = (Math.PI * 2 / 30) * i;
                const velocity = 80 + Math.random() * 120;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                particle.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:6px;height:6px;background:${color};border-radius:50%;animation:fireworkParticle 1s ease-out forwards;--tx:${tx}px;--ty:${ty}px;`;
                container.appendChild(particle);
            }

            setTimeout(() => {
                center.remove();
                container.querySelectorAll('[style*="fireworkParticle"]').forEach(p => p.remove());
            }, 1000);
        }

        const style = document.createElement('style');
        style.textContent = '@keyframes fireworkParticle {0%{transform:translate(0,0);opacity:1}100%{transform:translate(var(--tx),var(--ty));opacity:0}}';
        document.head.appendChild(style);

        function showSettings() { document.getElementById('settings-panel').classList.add('active'); }
        function closeSettings() { 
            document.getElementById('settings-panel').classList.remove('active');
            
            // å¦‚æœæ˜¯è™šæ‹Ÿæ»šåŠ¨ï¼Œé‡æ–°è®¡ç®—å¯è§é¡¹ç›®
            if (virtualScrollConfig.enabled && people.length >= 200) {
                setTimeout(() => updateVirtualVisibleItems(), 100);
            }
        }

        function saveTitle() {
            const title = document.getElementById('setting-title').value.trim();
            settings.title = `ğŸ‰ ${title} ğŸŠ`;
            saveData();
            renderTitle();
            alert('æ ‡é¢˜å·²ä¿å­˜');
        }

        function addPeople() {
            const text = document.getElementById('add-people-text').value.trim();
            if (!text) { alert('è¯·è¾“å…¥å§“å'); return; }
            const names = text.split('\n').map(n => n.trim()).filter(n => n);
            
            const existingNames = new Set(people.map(p => p.name.toLowerCase()));
            const uniqueNames = names.filter(n => !existingNames.has(n.toLowerCase()));
            const duplicateNames = names.filter(n => existingNames.has(n.toLowerCase()));
            
            if (uniqueNames.length === 0) {
                alert('æ‰€æœ‰å§“åéƒ½å·²å­˜åœ¨');
                return;
            }
            
            const newPeople = uniqueNames.map(name => ({ id: Date.now() + Math.random(), name, prize: null }));
            people = [...people, ...newPeople];
            saveData();
            renderAll();
            document.getElementById('add-people-text').value = '';
            
            let msg = `æˆåŠŸæ·»åŠ  ${newPeople.length} åäººå‘˜`;
            if (duplicateNames.length > 0) {
                msg += `\nè·³è¿‡é‡å¤å§“å: ${duplicateNames.join('ã€')}`;
            }
            showToast(msg, 'success');
        }

        function clearPeople() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰äººå‘˜å—ï¼Ÿ')) {
                appState.people = [];
                people = appState.people;
                saveData();
                renderAll();
                showToast('äººå‘˜å·²æ¸…ç©º', 'success');
            }
        }

        function exportPeople() {
            downloadFile(people.map(p => p.name).join('\n'), 'äººå‘˜åå•.txt', 'text/plain');
        }

        function showImportModal() { document.getElementById('import-modal').classList.add('active'); }
        function closeImportModal() { document.getElementById('import-modal').classList.remove('active'); }
        function showImportAllModal() { document.getElementById('import-all-modal').classList.add('active'); }
        function closeImportAllModal() { document.getElementById('import-all-modal').classList.remove('active'); }

        document.getElementById('import-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const content = ev.target.result;
                    let names = [];
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(content);
                        names = Array.isArray(data) ? data.map(item => typeof item === 'string' ? item : item.name) : [];
                    } else {
                        names = content.split('\n').map(l => l.trim()).filter(l => l);
                    }
                    const newPeople = names.map(name => ({ id: Date.now() + Math.random(), name, prize: null }));
                    people = [...people, ...newPeople];
                    saveData();
                    renderAll();
                    showToast(`æˆåŠŸå¯¼å…¥ ${newPeople.length} åäººå‘˜`, 'success');
                } catch (err) {
                    showToast('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + err.message, 'error', 5000);
                }
                closeImportModal();
            };
            reader.readAsText(file);
        });

        document.getElementById('import-all-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    people = data.people || [];
                    prizes = data.prizes || [];
                    history = data.history || [];
                    settings = data.settings || settings;
                    saveData();
                    renderAll();
                    showToast('é…ç½®å¯¼å…¥æˆåŠŸ', 'success');
                } catch (err) {
                    showToast('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + err.message, 'error', 5000);
                }
                closeImportAllModal();
            };
            reader.readAsText(file);
        });

        function exportData() {
            exportAll();
        }

        function exportAll() {
            try {
                const data = {
                    people,
                    prizes,
                    history,
                    settings: {
                        title: settings.title,
                        background: settings.background,
                        lotteryMode: settings.lotteryMode
                    },
                    exportTime: new Date().toISOString()
                };
                downloadFile(JSON.stringify(data, null, 2), 'æŠ½å¥–ç³»ç»Ÿé…ç½®.json', 'application/json');
                
                // æ›´æ–°å¤‡ä»½æ—¶é—´
                localStorage.setItem('lastBackupTime', Date.now().toString());
                closeBackupReminder();
                showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + e.message, 'error');
            }
        }

        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // æ¸…ç†è™šæ‹Ÿæ»šåŠ¨
                cleanupVirtualScroll();
                
                appState.people = [];
                appState.prizes = [];
                appState.history = [];
                appState.settings = { title: 'ğŸ‰ å¹´ä¼šæŠ½å¥–ç³»ç»Ÿ ğŸŠ', background: 'gradient1' };
                appState.currentPrizeIndex = null;
                
                // æ›´æ–°å…¼å®¹æ€§å˜é‡
                people = appState.people;
                prizes = appState.prizes;
                history = appState.history;
                settings = appState.settings;
                currentPrizeIndex = appState.currentPrizeIndex;
                
                saveData();
                renderAll();
                closeSettings();
                showToast('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // è§¦æ‘¸äº‹ä»¶å¤„ç†
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;

        function handleTouchStart(e) {
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            touchStartTime = Date.now();
        }

        function handleTouchMove(e) {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ»‘åŠ¨é€»è¾‘
        }

        function handleTouchEnd(e) {
            const touch = e.changedTouches[0];
            const touchEndX = touch.clientX;
            const touchEndY = touch.clientY;
            const touchEndTime = Date.now();
            const touchDuration = touchEndTime - touchStartTime;

            // è®¡ç®—æ»‘åŠ¨è·ç¦»
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

            // å¦‚æœæ»‘åŠ¨è·ç¦»å°äº10pxï¼Œè§†ä¸ºç‚¹å‡»
            if (distance < 10) {
                return;
            }

            // æ°´å¹³æ»‘åŠ¨ - æ‰“å¼€/å…³é—­å¥–é¡¹é¢æ¿
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                const prizePanel = document.getElementById('prize-panel');
                if (deltaX > 0) {
                    // å‘å³æ»‘åŠ¨ - æ‰“å¼€é¢æ¿
                    prizePanel.classList.add('active');
                } else {
                    // å‘å·¦æ»‘åŠ¨ - å…³é—­é¢æ¿
                    prizePanel.classList.remove('active');
                }
            }

            // å‚ç›´æ»‘åŠ¨ - åˆ‡æ¢èƒŒæ™¯
            if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 50) {
                if (deltaY < 0) {
                    // å‘ä¸Šæ»‘åŠ¨ - ä¸‹ä¸€ä¸ªèƒŒæ™¯
                    cycleBackground(1);
                } else {
                    // å‘ä¸‹æ»‘åŠ¨ - ä¸Šä¸€ä¸ªèƒŒæ™¯
                    cycleBackground(-1);
                }
            }
        }

        function cycleBackground(direction) {
            const backgrounds = ['gradient1', 'gradient2', 'gradient3', 'gradient4', 'gradient5'];
            const currentIndex = backgrounds.indexOf(settings.background);
            let newIndex = currentIndex + direction;
            
            if (newIndex < 0) newIndex = backgrounds.length - 1;
            if (newIndex >= backgrounds.length) newIndex = 0;
            
            settings.background = backgrounds[newIndex];
            document.body.className = settings.background;
            saveData();
            showToast(`å·²åˆ‡æ¢èƒŒæ™¯: ${newIndex + 1}/${backgrounds.length}`, 'info');
        }

        // é”®ç›˜å¿«æ·é”®å¤„ç†
        function handleKeyDown(e) {
            // å¦‚æœåœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸å¤„ç†å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            // é˜»æ­¢é»˜è®¤è¡Œä¸º
            e.preventDefault();

            switch (e.key) {
                case ' ':
                case 'Enter':
                    // ç©ºæ ¼æˆ–å›è½¦ - å¼€å§‹/åœæ­¢æŠ½å¥–
                    if (isLotteryRunning) {
                        stopLottery();
                    } else {
                        startLottery();
                    }
                    break;

                case 'Escape':
                    // ESC - å–æ¶ˆæŠ½å¥– / å…³é—­å¼¹çª— / å…³é—­é¢æ¿
                    if (isLotteryRunning) {
                        cancelLottery();
                    } else {
                        // å…³é—­æ‰€æœ‰é¢æ¿å’Œå¼¹çª—
                        closeWinnerModal();
                        closeSettings();
                        closeHistoryPanel();
                        closeBackupReminder();
                        document.getElementById('prize-panel').classList.remove('active');
                    }
                    break;

                case 'p':
                case 'P':
                    // P - æš‚åœ/ç»§ç»­
                    if (isLotteryRunning) {
                        togglePause();
                    }
                    break;

                case 'h':
                case 'H':
                    // H - æ‰“å¼€/å…³é—­å†å²è®°å½•
                    toggleHistoryPanel();
                    break;

                case 'r':
                case 'R':
                    // R - åˆ·æ–°é¡µé¢
                    if (confirm('ç¡®å®šè¦åˆ·æ–°é¡µé¢å—ï¼Ÿæœªä¿å­˜çš„æ•°æ®å¯èƒ½ä¼šä¸¢å¤±ã€‚')) {
                        location.reload();
                    }
                    break;

                case 's':
                case 'S':
                    // S - æ‰“å¼€è®¾ç½®é¢æ¿
                    showSettings();
                    break;

                case 'f':
                case 'F':
                    // F - åˆ‡æ¢å…¨å±
                    toggleFullscreen();
                    break;

                case 'ArrowUp':
                    // ä¸Šç®­å¤´ - åˆ‡æ¢ä¸Šä¸€ä¸ªèƒŒæ™¯
                    cycleBackground(-1);
                    break;

                case 'ArrowDown':
                    // ä¸‹ç®­å¤´ - åˆ‡æ¢ä¸‹ä¸€ä¸ªèƒŒæ™¯
                    cycleBackground(1);
                    break;

                case 'ArrowLeft':
                    // å·¦ç®­å¤´ - å…³é—­å¥–é¡¹é¢æ¿
                    document.getElementById('prize-panel').classList.remove('active');
                    break;

                case 'ArrowRight':
                    // å³ç®­å¤´ - æ‰“å¼€å¥–é¡¹é¢æ¿
                    document.getElementById('prize-panel').classList.add('active');
                    break;

                case '1':
                case '2':
                case '3':
                case '4':
                case '5':
                case '6':
                case '7':
                case '8':
                case '9':
                    // æ•°å­—é”® 1-9 - å¿«é€Ÿé€‰æ‹©å¥–é¡¹
                    const index = parseInt(e.key) - 1;
                    if (prizes[index] && !prizes[index].awarded) {
                        currentPrizeIndex = index;
                        appState.currentPrizeIndex = index;
                        saveData();
                        renderPrizes();
                        showToast(`å·²é€‰æ‹©: ${prizes[index].name}`, 'info');
                    }
                    break;

                case 'd':
                case 'D':
                    // D - å¯¼å‡ºæ•°æ®
                    exportData();
                    break;

                case 'i':
                case 'I':
                    // I - å¯¼å…¥æ•°æ®
                    document.getElementById('import-file').click();
                    break;

                case 'e':
                case 'E':
                    // E - å¯¼å‡ºå…¨éƒ¨æ•°æ®
                    exportAllData();
                    break;

                case 'c':
                case 'C':
                    // C - æ¸…ç©ºæ•°æ®
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                        clearAll();
                    }
                    break;

                case 'm':
                case 'M':
                    // M - åˆ‡æ¢æŠ½å¥–æ¨¡å¼
                    if (!isLotteryRunning) {
                        settings.lotteryMode = settings.lotteryMode === 'slide' ? 'ball' : 'slide';
                        appState.settings.lotteryMode = settings.lotteryMode;
                        saveData();
                        showToast(`å·²åˆ‡æ¢åˆ°${settings.lotteryMode === 'slide' ? 'æ–¹å—æ»‘åŠ¨' : '3Dçƒä½“'}æ¨¡å¼`, 'info');
                    }
                    break;

                case '?':
                    // ? - æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©
                    showKeyboardShortcuts();
                    break;
            }
        }

        // æ˜¾ç¤ºé”®ç›˜å¿«æ·é”®å¸®åŠ©
        function showKeyboardShortcuts() {
            const shortcuts = `
é”®ç›˜å¿«æ·é”®å¸®åŠ©ï¼š

æŠ½å¥–æ“ä½œï¼š
  ç©ºæ ¼/Enter - å¼€å§‹/åœæ­¢æŠ½å¥–
  P - æš‚åœ/ç»§ç»­æŠ½å¥–
  ESC - å–æ¶ˆæŠ½å¥– / å…³é—­å¼¹çª—
  M - åˆ‡æ¢æŠ½å¥–æ¨¡å¼ï¼ˆçƒä½“/æ»‘åŠ¨ï¼‰

ç•Œé¢æ“ä½œï¼š
  H - æ‰“å¼€/å…³é—­å†å²è®°å½•
  S - æ‰“å¼€è®¾ç½®é¢æ¿
  F - åˆ‡æ¢å…¨å±æ¨¡å¼
  R - åˆ·æ–°é¡µé¢
  ? - æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©

å¯¼èˆªæ“ä½œï¼š
  â†‘ - åˆ‡æ¢ä¸Šä¸€ä¸ªèƒŒæ™¯
  â†“ - åˆ‡æ¢ä¸‹ä¸€ä¸ªèƒŒæ™¯
  â† - å…³é—­å¥–é¡¹é¢æ¿
  â†’ - æ‰“å¼€å¥–é¡¹é¢æ¿

æ•°æ®æ“ä½œï¼š
  1-9 - å¿«é€Ÿé€‰æ‹©å¥–é¡¹
  D - å¯¼å‡ºé…ç½®æ•°æ®
  E - å¯¼å‡ºå…¨éƒ¨æ•°æ®
  I - å¯¼å…¥æ•°æ®
  C - æ¸…ç©ºæ•°æ®
            `;
            showToast(shortcuts, 'info', 8000);
        }

        document.querySelectorAll('.settings-panel').forEach(panel => {
            panel.addEventListener('click', (e) => {
                if (e.target === panel) panel.classList.remove('active');
            });
        });
    // showWinnersModal moved inside script
    function showWinnersModal(prize, winners) {
        const modal = document.getElementById('winner-modal');
        if (!modal) {
            alert('ä¸­å¥–: ' + winners.map(w => w.name).join(', '));
            return;
        }
        modal.classList.add('active');
        const content = modal.querySelector('.winner-content');
        if (content) {
            const prizeNameEl = content.querySelector('.prize-name');
            if (prizeNameEl) prizeNameEl.textContent = prize.name;
            const namesEl = content.querySelector('.winner-names');
            if (namesEl) namesEl.innerHTML = winners.map(w => `<div class="winner-name">${w.name}</div>`).join('');
        }
    }
    </script>
    </body>
    </html>
