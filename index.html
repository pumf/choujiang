<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âπ¥‰ºöÊäΩÂ•ñÁ≥ªÁªü</title>
    <style>
        /* 
         * Âπ¥‰ºöÊäΩÂ•ñÁ≥ªÁªü - Ê†∑ÂºèË°®
         * 
         * ÂäüËÉΩÁâπÁÇπÔºö
         * - 3DÁêÉ‰ΩìÊäΩÂ•ñÂä®Áîª
         * - ÊñπÂùóÊªëÂä®ÊäΩÂ•ñÊ®°Âºè
         * - ÂéÜÂè≤ËÆ∞ÂΩïÊü•Áúã‰∏éÊí§ÈîÄ
         * - ÊäΩÂ•ñÊöÇÂÅú/ÁªßÁª≠ÂäüËÉΩ
         * - ToastÊèêÁ§∫Á≥ªÁªü
         * - Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí
         * - ÊµèËßàÂô®ÂÖºÂÆπÊÄßÊ£ÄÊµã
         * 
         * ÊäÄÊúØÊ†àÔºöÁ∫ØHTML + CSS + JavaScript (Êó†Â§ñÈÉ®‰æùËµñ)
         * Êï∞ÊçÆÂ≠òÂÇ®ÔºöLocalStorage
         * ÊµèËßàÂô®ÂÖºÂÆπÔºöÁé∞‰ª£ÊµèËßàÂô®ÔºàChrome 60+, Firefox 60+, Safari 12+Ôºâ
         */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            overflow: hidden;
        }

        .toggle-prize-btn {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 80px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border: none;
            border-radius: 0 10px 10px 0;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            z-index: 100;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 3px;
            box-shadow: 5px 0 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        .toggle-prize-btn:hover {
            width: 35px;
            box-shadow: 8px 0 30px rgba(255, 107, 107, 0.6);
        }

        .prize-panel {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(30px);
            padding: 20px;
            z-index: 99;
            transform: translateX(-100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .prize-panel.active {
            transform: translateX(0);
        }

        .prize-panel h2 {
            font-size: 1.3em;
            color: #feca57;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(254, 202, 87, 0.3);
        }

        .prize-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .prize-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ff6b6b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prize-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .prize-item.active {
            border-left-color: #feca57;
            background: rgba(254, 202, 87, 0.15);
        }

        .prize-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .prize-item.unselectable {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(50%);
        }

        .prize-item .name {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .prize-item .desc {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 6px;
        }

        .prize-item .info {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.6);
        }

        .prize-item .status {
            padding: 2px 8px;
            border-radius: 10px;
            background: linear-gradient(45deg, #1dd1a1, #10ac84);
            font-size: 0.7em;
        }

        .prize-item .status.awarded {
            background: linear-gradient(45deg, #ff6b6b, #ee5a5a);
        }

        .main-content {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 30px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        .people-area {
            flex: 1;
            width: 100%;
            max-width: 1400px;
            padding: 10px 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .people-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(1px, 1fr));
            gap: 0;
            padding: 0;
            overflow: hidden;
            align-content: stretch;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        .title {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #ff6b6b);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientMove 4s ease infinite;
            text-shadow: 0 0 40px rgba(255, 107, 107, 0.3);
            margin-bottom: 10px;
        }

        @keyframes gradientMove {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .people-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            padding: 10px;
            overflow: hidden;
            align-content: center;
        }

        .people-grid::-webkit-scrollbar {
            display: none;
        }

        .red-packet { 
            aspect-ratio: 1;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
            position: relative;
            border: none;
        }

        /* 3D flip faces: front/back */
        .red-packet { transform-style: preserve-3d; }
        .red-packet .front { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .front-prize { font-size: 0.8em; color: #fff; margin-bottom: 2px; }
        .front-name { font-size: 0.7em; color: #fff; }
        .front-prize { font-size: 0.8em; color: #fff; }
        .red-packet .face {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            border-radius: inherit;
        }
        .red-packet .front { }
        .red-packet .back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #1e1e1e, #111);
            color: #fff;
            font-size: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .red-packet { transition: transform 0.9s ease; }
        .red-packet.is-flipped { transform: rotateY(180deg); }

        .red-packet::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 45%;
            height: 45%;
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            border-radius: 50%;
        }

        .red-packet::after {
            content: 'Á¶è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            font-weight: bold;
            color: #c0392b;
            z-index: 1;
        }

        .red-packet .name {
            position: absolute;
            bottom: 8%;
            left: 5%;
            right: 5%;
            text-align: center;
            font-size: 0.65em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            z-index: 2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .red-packet:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.6);
        }

        .red-packet.slide-highlight {
            background: linear-gradient(145deg, #f1c40f, #f39c12) !important;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
            transform: scale(1.1);
        }

        .red-packet.won {
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            box-shadow: 0 4px 15px rgba(241, 196, 15, 0.4);
        }

        .red-packet.won::before {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
        }

        .red-packet.won::after {
            content: '‰∏≠';
            color: #fff;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            font-weight: bold;
            z-index: 1;
        }

        .red-packet.won .front {
            position: relative;
        }

        .red-packet.won .won-prize {
            position: absolute;
            top: 8%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.4em;
            color: #c0392b;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
            text-align: center;
            z-index: 2;
        }

        .red-packet.won .won-name {
            position: absolute;
            top: 72%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.45em;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
            text-align: center;
            z-index: 2;
        }

        .lottery-btn {
            padding: 12px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: #fff;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            margin-top: 10px;
        }

        .lottery-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.5);
        }

        .lottery-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .lottery-btn.running {
            background: linear-gradient(45deg, #1dd1a1, #10ac84);
            animation: pulse 0.8s ease infinite alternate;
        }

        @keyframes pulse {
            from { box-shadow: 0 10px 40px rgba(29, 209, 161, 0.4); }
            to { box-shadow: 0 15px 70px rgba(29, 209, 161, 0.7); }
        }

        .settings-btn {
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg) scale(1.1);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .settings-panel.active {
            display: flex;
        }

        .settings-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .settings-content h2 {
            color: #feca57;
            margin-bottom: 25px;
            text-align: center;
        }

        .winner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .winner-modal.active {
            display: flex;
            opacity: 1;
        }

        .winner-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: white;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: bounceIn 0.5s ease;
            position: relative;
        }

        .winner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .winner-header h2 {
            margin: 0;
            flex: 1;
        }

        .winner-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .winner-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .winner-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            animation: modalPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalPop {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .winner-content h2 {
            color: #feca57;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .winner-content .prize-name {
            color: #48dbfb;
            font-size: 1.3em;
            margin-bottom: 25px;
        }

        .winner-content .winner-names {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .winner-content .winner-name {
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            color: #c0392b;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1.4em;
            font-weight: bold;
            animation: nameSlide 0.5s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes nameSlide {
            to { opacity: 1; transform: translateY(0); }
        }

        .winner-content .close-hint {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            color: #48dbfb;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .lottery-mode-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mode-option {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .mode-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .mode-option input[type="radio"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .mode-option input[type="radio"]:checked + .mode-label {
            color: #feca57;
        }

        .mode-option:has(input:checked) {
            border-color: #feca57;
            background: rgba(254, 202, 87, 0.1);
        }

        .mode-label {
            font-size: 1.1em;
            font-weight: bold;
            margin-right: 10px;
        }

        .mode-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
        }

        .settings-section input, .settings-section textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .settings-section input:focus, .settings-section textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s ease;
        }

        .btn-primary { background: linear-gradient(45deg, #ff6b6b, #feca57); }
        .btn-secondary { background: linear-gradient(45deg, #48dbfb, #0abde3); }
        .btn-danger { background: linear-gradient(45deg, #ff6b6b, #ee5a5a); }
        .btn-success { background: linear-gradient(45deg, #1dd1a1, #10ac84); }

        .btn:hover { transform: translateY(-2px); }

        .close-settings {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-settings:hover { transform: rotate(90deg); }

        .bg-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .bg-option {
            height: 45px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .bg-option.active {
            border-color: #feca57;
        }

        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px 0;
        }

        .file-upload:hover {
            border-color: #feca57;
            background: rgba(254, 202, 87, 0.1);
        }

        .file-upload input {
            display: none;
        }

        .ball-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            perspective: 1200px;
        }

        .ball-container.active {
            display: flex;
        }

        #lottery-ball {
            width: 850px;
            height: 850px;
            position: relative;
            transform-style: preserve-3d;
        }

        @keyframes rotateY {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        .ball-item {
            position: absolute;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ball-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 28px;
            height: 28px;
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            border-radius: 50%;
        }

        .ball-item::after {
            content: 'Á¶è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            font-weight: bold;
            color: #c0392b;
            z-index: 1;
        }

        .ball-item .name {
            position: absolute;
            bottom: 4px;
            left: 2px;
            right: 2px;
            text-align: center;
            font-size: 9px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
        }

        .ball-item.gather {
            position: absolute;
            top: 50%;
            left: 50%;
        }

        .ball-item.highlight {
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            box-shadow: 0 0 35px rgba(254, 202, 87, 0.9);
            z-index: 1000;
        }

        .fullscreen-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .stop-btn, .cancel-btn {
            position: absolute;
            bottom: 60px;
            padding: 18px 45px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .ball-container.active .stop-btn,
        .ball-container.active .cancel-btn {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease 1s;
        }

        .ball-btn-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            opacity: 0;
            transition: all 0.5s ease 1s;
        }

        .ball-container.active .ball-btn-container {
            opacity: 1;
        }

        .ball-btn-container .stop-btn,
        .ball-btn-container .cancel-btn {
            position: static;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ball-btn-container .stop-btn {
            background: linear-gradient(45deg, #1dd1a1, #10ac84);
            box-shadow: 0 5px 30px rgba(29, 209, 161, 0.4);
        }

        .ball-btn-container .cancel-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a5a);
            box-shadow: 0 5px 30px rgba(255, 107, 107, 0.4);
        }

        .ball-btn-container .stop-btn:hover,
        .ball-btn-container .cancel-btn:hover {
            transform: scale(1.05);
        }

        .ball-btn-container .stop-btn:active,
        .ball-btn-container .cancel-btn:active {
            transform: scale(0.95);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        /* ÂéÜÂè≤ËÆ∞ÂΩïÊåâÈíÆ */
        .history-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .history-btn:active {
            transform: translateY(0);
        }

        /* ÊöÇÂÅúÊåâÈíÆ */
        .pause-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #feca57, #ff9ff3);
            color: #333;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(254, 202, 87, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .pause-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 202, 87, 0.6);
        }

        .pause-btn:active {
            transform: translateX(-50%) translateY(0);
        }

        .pause-btn.paused {
            background: linear-gradient(135deg, #1dd1a1, #10ac84);
            color: white;
        }

        .pause-btn.paused:hover {
            box-shadow: 0 6px 20px rgba(29, 209, 161, 0.6);
        }

        /* ÂéÜÂè≤ËÆ∞ÂΩïÈù¢Êùø */
        .history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            border-left: 2px solid rgba(255, 255, 255, 0.1);
            z-index: 2000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .history-panel.active {
            right: 0;
        }

        .history-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-header h2 {
            margin: 0;
            color: #fff;
            font-size: 1.3em;
        }

        .close-history-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-history-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #feca57;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-5px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-prize {
            font-weight: bold;
            color: #feca57;
            font-size: 1.1em;
        }

        .history-item-time {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
        }

        .history-item-winners {
            color: #fff;
            font-size: 0.95em;
            margin-top: 5px;
        }

        .history-item-winners strong {
            color: #1dd1a1;
        }

        .history-item-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .history-item-actions button {
            padding: 5px 12px;
            font-size: 0.85em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item-actions .revoke-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }

        .history-item-actions .revoke-btn:hover {
            transform: scale(1.05);
        }

        .history-item-actions .revoke-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Toast ÊèêÁ§∫ */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(30, 30, 40, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 500;
            z-index: 3000;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 80%;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #1dd1a1;
        }

        .toast.error {
            border-left: 4px solid #ff6b6b;
        }

        .toast.warning {
            border-left: 4px solid #feca57;
        }

        .toast.info {
            border-left: 4px solid #48dbfb;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #feca57;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 1.2em;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ÊµèËßàÂô®ÂÖºÂÆπÊÄßÊèêÁ§∫ */
        .compatibility-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 500;
            z-index: 5000;
            display: none;
        }

        .compatibility-warning.show {
            display: block;
        }

        /* Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí */
        .backup-reminder {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(30, 30, 40, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #feca57;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1500;
            display: none;
            max-width: 300px;
        }

        .backup-reminder.show {
            display: block;
            animation: slideInRight 0.3s ease;
        }

        .backup-reminder h4 {
            margin: 0 0 8px 0;
            color: #feca57;
        }

        .backup-reminder p {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .backup-reminder button {
            padding: 6px 15px;
            font-size: 0.85em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .backup-reminder .export-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .backup-reminder .close-btn {
            background: #555;
            color: white;
        }

        .backup-reminder button:hover {
            transform: scale(1.05);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ÊµèËßàÂô®ÂÖºÂÆπÊÄßÊ£ÄÊµã */
        .compatibility-check {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 500;
            z-index: 5000;
            display: none;
        }

        .compatibility-check.show {
            display: block;
        }

        @media (max-width: 768px) {
            .title { font-size: 1.8em; }
            .lottery-btn { padding: 10px 30px; font-size: 1.1em; }
            .people-grid { grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); grid-auto-rows: minmax(50px, 1fr); }
            .prize-panel { width: 260px; }
            .history-panel { width: 100%; right: -100%; }
            .history-btn { bottom: 15px; right: 15px; padding: 10px 15px; font-size: 14px; }
            .settings-btn { bottom: 15px; right: 100px; }
            .fullscreen-btn { bottom: 15px; right: 170px; }
        }
    </style>
</head>
<body>
    <div class="bg-overlay" id="bg-overlay"></div>
    <button class="toggle-prize-btn" id="toggle-prize-btn">Â•ñÈ°πÂàóË°®</button>

    <div class="prize-panel" id="prize-panel">
        <h2>üèÜ Â•ñÈ°πÂàóË°®</h2>
        <div class="prize-list" id="prize-list">
            <div class="empty-state">
                <div class="icon">üèÜ</div>
                <p>ÊöÇÊó†Â•ñÈ°π</p>
            </div>
        </div>
    </div>

    <div class="main-content">
        <h1 class="title" id="lottery-title">üéâ Âπ¥‰ºöÊäΩÂ•ñÁ≥ªÁªü üéä</h1>

        <div class="people-area">
            <div class="people-grid" id="people-grid">
                <div class="empty-state">
                    <div class="icon">üë•</div>
                    <p>ÊöÇÊó†‰∫∫ÂëòÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠Ê∑ªÂä†</p>
                </div>
            </div>
        </div>

        <button class="lottery-btn" id="lottery-btn" onclick="startLottery()">üé∞ ÂºÄÂßãÊäΩÂ•ñ</button>
        <button class="pause-btn" id="pause-btn" onclick="togglePause()" style="display:none;">‚è∏ ÊöÇÂÅú</button>
    </div>

    <button class="settings-btn" id="settings-btn" onclick="showSettings()">‚öôÔ∏è</button>
    <button class="fullscreen-btn" id="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂</button>
    <button class="history-btn" id="history-btn" onclick="toggleHistoryPanel()">üìú ÂéÜÂè≤ËÆ∞ÂΩï</button>

    <div class="ball-container" id="ball-container">
        <div id="lottery-ball"></div>
        <div class="ball-btn-container">
            <button class="stop-btn" id="stop-btn">‚èπ ÂÅúÊ≠¢Âπ∂Êè≠Êôì</button>
            <button class="cancel-btn" id="cancel-btn">‚ùå ÂèñÊ∂à</button>
        </div>
    </div>

    <div class="winner-modal" id="winner-modal">
        <div class="winner-content">
            <div class="winner-header">
                <h2 id="winner-title">üéâ ÊÅ≠Âñú‰∏≠Â•ñ üéâ</h2>
                <button class="winner-close-btn" onclick="closeWinnerModal()">‚úï</button>
            </div>
            <div class="prize-name" id="winner-prize"></div>
            <div class="winner-names" id="winner-names"></div>
            <div class="close-hint">ÁÇπÂáª‰ªªÊÑè‰ΩçÁΩÆÊàñÂÖ≥Èó≠ÊåâÈíÆÂÖ≥Èó≠</div>
        </div>
    </div>

    <div id="fireworks-container"></div>

    <!-- ÂéÜÂè≤ËÆ∞ÂΩïÈù¢Êùø -->
    <div class="history-panel" id="history-panel">
        <div class="history-header">
            <h2>üìú ÊäΩÂ•ñÂéÜÂè≤ËÆ∞ÂΩï</h2>
            <button class="close-history-btn" onclick="toggleHistoryPanel()">‚úï</button>
        </div>
        <div class="history-list" id="history-list">
            <div class="empty-state">
                <div class="icon">üìú</div>
                <p>ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</p>
            </div>
        </div>
    </div>

    <!-- Toast ÊèêÁ§∫ -->
    <div class="toast" id="toast"></div>

    <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Âä†ËΩΩ‰∏≠...</div>
        </div>
    </div>

    <!-- ÊµèËßàÂô®ÂÖºÂÆπÊÄßÊ£ÄÊµã -->
    <div class="compatibility-check" id="compatibility-check">
        ‚ö†Ô∏è Ê£ÄÊµãÂà∞ÊµèËßàÂô®ÂÖºÂÆπÊÄßÈóÆÈ¢òÔºåÈÉ®ÂàÜÂäüËÉΩÂèØËÉΩÊó†Ê≥ïÊ≠£Â∏∏‰ΩøÁî®
    </div>

    <!-- Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí -->
    <div class="backup-reminder" id="backup-reminder">
        <h4>üí° Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí</h4>
        <p>ÊÇ®ÊúâÊú™Â§á‰ªΩÁöÑÊï∞ÊçÆÔºåÂª∫ËÆÆÁ´ãÂç≥ÂØºÂá∫Â§á‰ªΩÔºÅ</p>
        <button class="export-btn" onclick="exportData()">Á´ãÂç≥ÂØºÂá∫</button>
        <button class="close-btn" onclick="closeBackupReminder()">Á®çÂêé</button>
    </div>

    <script>
        // ==================== ÂÖ®Â±ÄÁä∂ÊÄÅÁÆ°ÁêÜ ====================
        
        /**
         * Â∫îÁî®Áä∂ÊÄÅÂØπË±° - Â∞ÅË£ÖÊâÄÊúâÂÖ®Â±ÄÂèòÈáè
         * 
         * ‰ΩøÁî®ÂØπË±°Â∞ÅË£ÖËÄåÈùûÂ§ö‰∏™ÂÖ®Â±ÄÂèòÈáèÁöÑÂ•ΩÂ§ÑÔºö
         * 1. ÈÅøÂÖçÂÖ®Â±ÄÂëΩÂêçÁ©∫Èó¥Ê±°Êüì
         * 2. ‰æø‰∫éÁä∂ÊÄÅÁÆ°ÁêÜÂíåË∞ÉËØï
         * 3. ÊîØÊåÅÊú™Êù•Êâ©Â±ïÔºàÂ¶ÇÁä∂ÊÄÅÂø´ÁÖß„ÄÅÊó∂Èó¥ÊóÖË°åË∞ÉËØïÔºâ
         * 4. Êõ¥Â•ΩÁöÑ‰ª£Á†ÅÁªÑÁªáÂíåÂèØÁª¥Êä§ÊÄß
         */
        const appState = {
            // ==================== Êï∞ÊçÆÂ±Ç ====================
            
            // ‰∫∫ÂëòÂàóË°®
            // Ê†ºÂºèÔºö[{ id: number, name: string, prize: string|null }]
            // id: ÂîØ‰∏ÄÊ†áËØÜÁ¨¶Ôºà‰ΩøÁî® Date.now() + Math.random() ÁîüÊàêÔºâ
            // name: ‰∫∫ÂëòÂßìÂêç
            // prize: Â∑≤‰∏≠Â•ñÈ°πÂêçÁß∞ÔºånullË°®Á§∫Êú™‰∏≠Â•ñ
            people: [],
            
            // Â•ñÈ°πÂàóË°®
            // Ê†ºÂºèÔºö[{ id: number, name: string, desc: string, count: number, color: string, awarded: boolean }]
            // id: ÂîØ‰∏ÄÊ†áËØÜÁ¨¶
            // name: Â•ñÈ°πÂêçÁß∞
            // desc: Â•ñÈ°πÊèèËø∞
            // count: Â•ñÈ°πÊï∞ÈáèÔºàÂèØ‰∏≠Â•ñ‰∫∫Êï∞Ôºâ
            // color: Â•ñÈ°πÈ¢úËâ≤ÔºàÁî®‰∫éUIÊòæÁ§∫Ôºâ
            // awarded: ÊòØÂê¶Â∑≤ÊäΩÂèñ
            prizes: [],
            
            // ÂéÜÂè≤ËÆ∞ÂΩï
            // Ê†ºÂºèÔºö[{ prizeName: string, prizeDesc: string, winners: string[], time: string, revoked: boolean }]
            // prizeName: Â•ñÈ°πÂêçÁß∞
            // prizeDesc: Â•ñÈ°πÊèèËø∞
            // winners: ‰∏≠Â•ñËÄÖÂßìÂêçÊï∞ÁªÑ
            // time: ÊäΩÂ•ñÊó∂Èó¥ÔºàISOÊ†ºÂºèÔºâ
            // revoked: ÊòØÂê¶Â∑≤Êí§ÈîÄ
            history: [],
            
            // ËÆæÁΩÆ
            // Ê†ºÂºèÔºö{ title: string, background: string, lotteryMode: string }
            // title: È°µÈù¢Ê†áÈ¢ò
            // background: ËÉåÊôØ‰∏ªÈ¢òÔºàgradient1-4 Êàñ customÔºâ
            // lotteryMode: ÊäΩÂ•ñÊ®°ÂºèÔºàsphere Êàñ slideÔºâ
            settings: { title: 'üéâ Âπ¥‰ºöÊäΩÂ•ñÁ≥ªÁªü üéä', background: 'gradient1', lotteryMode: 'sphere' },
            
            // ==================== Áä∂ÊÄÅÂ±Ç ====================
            
            // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ•ñÈ°πÁ¥¢Âºï
            // null: Êú™ÈÄâÊã©ÔºåËá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÂèØÁî®Â•ñÈ°π
            // number: ÊåáÂÆöÁ¥¢ÂºïÁöÑÂ•ñÈ°π
            currentPrizeIndex: null,
            
            // ÊäΩÂ•ñËøêË°åÁä∂ÊÄÅ
            // true: ÊäΩÂ•ñËøõË°å‰∏≠
            // false: ÊäΩÂ•ñÊú™ÂºÄÂßãÊàñÂ∑≤ÁªìÊùü
            isLotteryRunning: false,
            
            // ÊöÇÂÅúÁä∂ÊÄÅ
            // true: ÊäΩÂ•ñÂ∑≤ÊöÇÂÅú
            // false: ÊäΩÂ•ñÊ≠£Â∏∏ËøõË°å
            isPaused: false,
            
            // ==================== Âä®ÁîªÂ±Ç ====================
            
            // Âä®ÁîªIDÔºàÁî®‰∫é cancelAnimationFrameÔºâ
            // Â≠òÂÇ® requestAnimationFrame ËøîÂõûÁöÑID
            animationId: null,
            
            // ÂΩìÂâçÂä®ÁîªÊï∞ÊçÆ
            // Áî®‰∫éÊöÇÂÅú/ÊÅ¢Â§çÂäüËÉΩ
            // Ê†ºÂºèÔºö{ availablePeople: array, prize: object, ... }
            currentAnimationData: null,
            
            // ÁøªÂä®Âä®ÁîªÂÆöÊó∂Âô®ID
            // Áî®‰∫éÊ∏ÖÁêÜÂÆöÊó∂Âô®ÔºåÈÅøÂÖçÂÜÖÂ≠òÊ≥ÑÊºè
            flipIntervalId: null,
            
            // ÊöÇÂÅúÂä®ÁîªÂÆöÊó∂Âô®ID
            // Áî®‰∫éÊ∏ÖÁêÜÊöÇÂÅúÊó∂ÁöÑÂÆöÊó∂Âô®
            pauseIntervalId: null
        };

        // ==================== ÂêëÂêéÂÖºÂÆπ ====================
        // 
        // ‰∏∫‰∫Ü‰øùÊåÅ‰∏éÁé∞Êúâ‰ª£Á†ÅÁöÑÂÖºÂÆπÊÄßÔºåÂ∞Ü appState ÁöÑÂ±ûÊÄßÊò†Â∞ÑÂà∞ÂÖ®Â±ÄÂèòÈáè
        // ËøôÊ†∑ÂèØ‰ª•ÈÄêÊ≠•ËøÅÁßªÔºåÈÅøÂÖç‰∏ÄÊ¨°ÊÄß‰øÆÊîπÊâÄÊúâ‰ª£Á†Å
        // 
        // Ê≥®ÊÑèÔºöËøô‰∫õÂèòÈáèÊòØÂºïÁî®Á±ªÂûãÔºå‰øÆÊîπÂÆÉ‰ª¨‰ºöÁõ¥Êé•ÂΩ±Âìç appState
        // 
        let people = appState.people;
        let prizes = appState.prizes;
        let history = appState.history;
        let settings = appState.settings;
        let currentPrizeIndex = appState.currentPrizeIndex;
        let isLotteryRunning = appState.isLotteryRunning;
        let isPaused = appState.isPaused;
        let animationId = appState.animationId;
        let currentAnimationData = appState.currentAnimationData;
        let flipIntervalId = appState.flipIntervalId;
        let pauseIntervalId = appState.pauseIntervalId;

        document.addEventListener('DOMContentLoaded', () => {
            // Ê£ÄÊü•ÊµèËßàÂô®ÂÖºÂÆπÊÄß
            checkCompatibility();

            loadData();
            renderAll();
            initBgOptions();
            initLotteryMode();
            document.getElementById('toggle-prize-btn').addEventListener('click', togglePrizePanel);
            document.getElementById('settings-btn').addEventListener('click', showSettings);
            document.getElementById('stop-btn').addEventListener('click', stopLottery);
            document.getElementById('cancel-btn').addEventListener('click', cancelLottery);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);

            // ÁÇπÂáªÁ©∫ÁôΩÂå∫ÂüüÂÖ≥Èó≠Â•ñÈ°πÂàóË°®
            document.addEventListener('click', (e) => {
                const prizePanel = document.getElementById('prize-panel');
                const toggleBtn = document.getElementById('toggle-prize-btn');

                // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÂ•ñÈ°πÈù¢ÊùøÂÜÖÈÉ®Ôºå‰πü‰∏çÊòØÂàáÊç¢ÊåâÈíÆÔºåÂàôÈöêËóèÂ•ñÈ°πÈù¢Êùø
                if (!prizePanel.contains(e.target) && e.target !== toggleBtn) {
                    prizePanel.classList.remove('active');
                }
            });

            // ÁßªÂä®Á´ØËß¶Êë∏‰∫ã‰ª∂Â§ÑÁêÜ
            document.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.addEventListener('touchmove', handleTouchMove, { passive: true });
            document.addEventListener('touchend', handleTouchEnd, { passive: true });

            // ÈîÆÁõòÂø´Êç∑ÈîÆ
            document.addEventListener('keydown', handleKeyDown);

            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂ§á‰ªΩ
            setTimeout(() => checkBackupNeeded(), 3000);

            // ÁõëÂê¨È°µÈù¢ÂÖ≥Èó≠‰∫ã‰ª∂ÔºåÊèêÈÜí‰øùÂ≠òÊï∞ÊçÆ
            window.addEventListener('beforeunload', (e) => {
                if (isLotteryRunning) {
                    e.preventDefault();
                    e.returnValue = 'ÊäΩÂ•ñÊ≠£Âú®ËøõË°å‰∏≠ÔºåÁ°ÆÂÆöË¶ÅÁ¶ªÂºÄÂêóÔºü';
                }
            });
        });
        });

        /**
         * ‰ªé LocalStorage Âä†ËΩΩÊï∞ÊçÆ
         * 
         * ÂäüËÉΩÔºö
         * 1. ËØªÂèñ localStorage ‰∏≠ÁöÑÊäΩÂ•ñÊï∞ÊçÆ
         * 2. Ëß£Êûê JSON Êï∞ÊçÆ
         * 3. Êõ¥Êñ∞Â∫îÁî®Áä∂ÊÄÅ
         * 4. Â§ÑÁêÜËß£ÊûêÈîôËØØÂíåÊï∞ÊçÆÊçüÂùè
         * 
         * Êï∞ÊçÆÊ†ºÂºèÔºö
         * {
         *   people: [...],
         *   prizes: [...],
         *   history: [...],
         *   settings: {...}
         * }
         * 
         * ÈîôËØØÂ§ÑÁêÜÔºö
         * - JSON Ëß£ÊûêÂ§±Ë¥•ÔºöÊ∏ÖÁ©∫ÊçüÂùèÁöÑÊï∞ÊçÆ
         * - Êï∞ÊçÆÊ†ºÂºèÈîôËØØÔºö‰ΩøÁî®ÈªòËÆ§ÂÄº
         * - localStorage ‰∏çÂèØÁî®ÔºöÈùôÈªòÂ§±Ë¥•
         * 
         * @returns {void}
         */
        function loadData() {
            try {
                const savedData = localStorage.getItem('lotteryData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    appState.people = data.people || [];
                    appState.prizes = data.prizes || [];
                    appState.history = data.history || [];
                    appState.settings = { ...appState.settings, ...data.settings };
                    
                    // Êõ¥Êñ∞ÂÖºÂÆπÊÄßÂèòÈáè
                    people = appState.people;
                    prizes = appState.prizes;
                    history = appState.history;
                    settings = appState.settings;
                    
                    showToast('Êï∞ÊçÆÂä†ËΩΩÊàêÂäü', 'success', 2000);
                }
            } catch (e) {
                console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', e);
                showToast('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•Ôºö' + e.message, 'error', 5000);
                // Ê∏ÖÁ©∫ÊçüÂùèÁöÑÊï∞ÊçÆ
                localStorage.removeItem('lotteryData');
            }
        }

        /**
         * ‰øùÂ≠òÊï∞ÊçÆÂà∞ LocalStorage
         * 
         * ÂäüËÉΩÔºö
         * 1. Â∞ÜÂ∫îÁî®Áä∂ÊÄÅÂ∫èÂàóÂåñ‰∏∫ JSON
         * 2. Ê£ÄÊü•Êï∞ÊçÆÂ§ßÂ∞èÔºàÈÅøÂÖçË∂ÖÂá∫ localStorage ÈôêÂà∂Ôºâ
         * 3. ‰øùÂ≠òÂà∞ localStorage
         * 4. Â§ÑÁêÜÂ≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÁöÑÊÉÖÂÜµ
         * 
         * Êï∞ÊçÆÂ§ßÂ∞èÈôêÂà∂Ôºö
         * - Â§ßÂ§öÊï∞ÊµèËßàÂô®Ôºö5MB per origin
         * - ÂÆâÂÖ®ÈôêÂà∂Ôºö4.5MBÔºàÁïô0.5MBÁºìÂÜ≤Ôºâ
         * - Ë∂ÖÂá∫ÈôêÂà∂ÔºöÊèêÁ§∫Áî®Êà∑Âà†Èô§Êï∞ÊçÆ
         * 
         * ÈîôËØØÂ§ÑÁêÜÔºö
         * - QuotaExceededError: Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥
         * - ÂÖ∂‰ªñÈîôËØØÔºöÊòæÁ§∫ÂÖ∑‰ΩìÈîôËØØ‰ø°ÊÅØ
         * 
         * @returns {void}
         */
        function saveData() {
            try {
                const dataToSave = {
                    people: appState.people,
                    prizes: appState.prizes,
                    history: appState.history,
                    settings: appState.settings
                };
                const dataString = JSON.stringify(dataToSave);
                
                // Ê£ÄÊü•Êï∞ÊçÆÂ§ßÂ∞è
                const dataSize = new Blob([dataString]).size;
                const maxSize = 4.5 * 1024 * 1024; // 4.5MB (Áïô0.5MBÁºìÂÜ≤)
                
                if (dataSize > maxSize) {
                    showToast('Êï∞ÊçÆËøáÂ§ßÔºåÊó†Ê≥ï‰øùÂ≠òÂà∞ÊµèËßàÂô®ÔºÅËØ∑Âà†Èô§‰∏Ä‰∫õÊï∞ÊçÆ', 'error', 8000);
                    return;
                }
                
                localStorage.setItem('lotteryData', dataString);
            } catch (e) {
                console.error('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', e);
                
                if (e.name === 'QuotaExceededError') {
                    showToast('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºÅËØ∑Âà†Èô§‰∏Ä‰∫õÂéÜÂè≤ËÆ∞ÂΩïÊàñÊï∞ÊçÆ', 'error', 8000);
                } else {
                    showToast('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•Ôºö' + e.message, 'error');
                }
            }
        }

        /**
         * ÊòæÁ§∫ Toast ÊèêÁ§∫
         * 
         * ÂäüËÉΩÔºö
         * 1. ÊòæÁ§∫‰∏¥Êó∂Ê∂àÊÅØÊèêÁ§∫
         * 2. ÊîØÊåÅÂ§öÁßçÁ±ªÂûãÔºàsuccess, error, warning, infoÔºâ
         * 3. Ëá™Âä®Ê∂àÂ§±
         * 4. Èò≤Ê≠¢ÈáçÂ§çÊòæÁ§∫
         * 
         * Ê∂àÊÅØÁ±ªÂûãÔºö
         * - success: ÊàêÂäüÊ∂àÊÅØÔºàÁªøËâ≤ËæπÊ°ÜÔºâ
         * - error: ÈîôËØØÊ∂àÊÅØÔºàÁ∫¢Ëâ≤ËæπÊ°ÜÔºâ
         * - warning: Ë≠¶ÂëäÊ∂àÊÅØÔºàÈªÑËâ≤ËæπÊ°ÜÔºâ
         * - info: ‰ø°ÊÅØÊ∂àÊÅØÔºàËìùËâ≤ËæπÊ°ÜÔºâ
         * 
         * ÊòæÁ§∫‰ΩçÁΩÆÔºö
         * - È°µÈù¢È°∂ÈÉ®Â±Ö‰∏≠
         * - Âõ∫ÂÆöÂÆö‰ΩçÔºå‰∏çÈöèÊªöÂä®ÁßªÂä®
         * 
         * @param {string} message - ÊèêÁ§∫Ê∂àÊÅØÂÜÖÂÆπ
         * @param {string} type - Ê∂àÊÅØÁ±ªÂûãÔºàsuccess/error/warning/infoÔºâ
         * @param {number} duration - ÊòæÁ§∫Êó∂ÈïøÔºàÊØ´ÁßíÔºâ
         * @returns {void}
         */
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        /**
         * ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
         * 
         * ÂäüËÉΩÔºö
         * 1. ÊòæÁ§∫ÂÖ®Â±èÈÅÆÁΩ©Â±Ç
         * 2. ÊòæÁ§∫Âä†ËΩΩÂä®ÁîªÔºàÊóãËΩ¨ÂúÜÂúàÔºâ
         * 3. ÊòæÁ§∫Âä†ËΩΩÊñáÊú¨
         * 4. Èò≤Ê≠¢Áî®Êà∑‰∫§‰∫í
         * 
         * ‰ΩøÁî®Âú∫ÊôØÔºö
         * - Êñá‰ª∂ÂØºÂÖ•
         * - Êï∞ÊçÆÂØºÂá∫
         * - Â§ßÈáèÊï∞ÊçÆÂ§ÑÁêÜ
         * - ÁΩëÁªúËØ∑Ê±ÇÔºàÊú™Êù•Êâ©Â±ïÔºâ
         * 
         * @param {string} text - Âä†ËΩΩÊñáÊú¨ÔºàÈªòËÆ§Ôºö"Âä†ËΩΩ‰∏≠..."Ôºâ
         * @returns {void}
         */
        function showLoading(text = 'Âä†ËΩΩ‰∏≠...') {
            const loading = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = text;
            loading.classList.add('active');
        }

        /**
         * ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
         * 
         * ÂäüËÉΩÔºö
         * 1. ÈöêËóèÂÖ®Â±èÈÅÆÁΩ©Â±Ç
         * 2. ÊÅ¢Â§çÁî®Êà∑‰∫§‰∫í
         * 
         * @returns {void}
         */
        function hideLoading() {
            const loading = document.getElementById('loading-overlay');
            loading.classList.remove('active');
        }

        // ÊµèËßàÂô®ÂÖºÂÆπÊÄßÊ£ÄÊµã
        function checkCompatibility() {
            const warnings = [];

            // Ê£ÄÊü• localStorage
            if (!window.localStorage) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ LocalStorage');
            }

            // Ê£ÄÊü• CSS3 ÊîØÊåÅ
            const testDiv = document.createElement('div');
            if (!('transform' in testDiv.style)) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ CSS3 Transform');
            }

            if (!('backfaceVisibility' in testDiv.style)) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ backface-visibility');
            }

            // Ê£ÄÊü• ES6 ÊîØÊåÅ
            try {
                new Function('const test = () => {}');
            } catch (e) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ ES6 ËØ≠Ê≥ï');
            }

            if (warnings.length > 0) {
                const check = document.getElementById('compatibility-check');
                check.textContent = '‚ö†Ô∏è Ê£ÄÊµãÂà∞ÊµèËßàÂô®ÂÖºÂÆπÊÄßÈóÆÈ¢òÔºö' + warnings.join('„ÄÅ');
                check.classList.add('show');
                setTimeout(() => check.classList.remove('show'), 5000);
            }
        }

        // ÊòæÁ§∫Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí
        function showBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.add('show');
        }

        // ÂÖ≥Èó≠Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí
        function closeBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.remove('show');
        }

        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂ§á‰ªΩ
        function checkBackupNeeded() {
            // Â¶ÇÊûúÊúâÊï∞ÊçÆ‰∏îË∂ÖËøá7Â§©Êú™Â§á‰ªΩÔºåÊòæÁ§∫ÊèêÈÜí
            const lastBackup = localStorage.getItem('lastBackupTime');
            const now = Date.now();
            
            if (people.length > 0 || prizes.length > 0) {
                if (!lastBackup || (now - parseInt(lastBackup)) > 7 * 24 * 60 * 60 * 1000) {
                    setTimeout(() => showBackupReminder(), 2000);
                }
            }
        }
            };
            localStorage.setItem('lotteryData', JSON.stringify(dataToSave));
        }

        function renderAll() {
            renderTitle();
            renderBg();
            renderPrizes();
            renderPeople();
            initLotteryMode();
        }

        function renderTitle() {
            document.getElementById('lottery-title').textContent = settings.title;
            document.getElementById('setting-title').value = settings.title.replace(/üéâ|üéä/g, '').trim();
        }

        function renderBg() {
            document.body.style.background = getBgStyle(settings.background);
            document.querySelectorAll('.bg-option').forEach(el => {
                el.classList.toggle('active', el.dataset.bg === settings.background);
            });
        }

        function uploadBgImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.querySelector('.main-content').style.backgroundImage = `url(${e.target.result})`;
                document.getElementById('bg-overlay').style.background = 'rgba(0, 0, 0, 0.3)';
                alert('ËÉåÊôØÂõæÁâáÂ∑≤ËÆæÁΩÆÔºà‰ªÖÂΩìÂâç‰ºöËØùÊúâÊïàÔºâ');
            };
            reader.readAsDataURL(file);
        }

        function clearBgImage() {
            document.querySelector('.main-content').style.backgroundImage = 'none';
            document.getElementById('bg-overlay').style.background = 'rgba(0, 0, 0, 0.5)';
            alert('ËÉåÊôØÂõæÁâáÂ∑≤Ê∏ÖÈô§');
        }

        function getBgStyle(bg) {
            const styles = {
                gradient1: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)',
                gradient2: 'linear-gradient(135deg, #0f4037 0%, #195047 50%, #0f4037 100%)',
                gradient3: 'linear-gradient(135deg, #4a1a1a 0%, #3d1a1a 50%, #2a0f0f 100%)',
                gradient4: 'linear-gradient(135deg, #1a2a4a 0%, #1a2040 50%, #0f1a2a 100%)'
            };
            return styles[bg] || styles.gradient1;
        }

        function initBgOptions() {
            document.querySelectorAll('.bg-option').forEach(option => {
                option.addEventListener('click', () => {
                    settings.background = option.dataset.bg;
                    saveData();
                    renderBg();
                });
            });
        }

        function initLotteryMode() {
            const mode = settings.lotteryMode || 'sphere';
            const radio = document.querySelector(`input[name="lotteryMode"][value="${mode}"]`);
            if (radio) radio.checked = true;
        }

        function saveLotteryMode(mode) {
            settings.lotteryMode = mode;
            saveData();
        }

        /**
         * Ê∏≤ÊüìÁªüËÆ°‰ø°ÊÅØ
         * 
         * ÂäüËÉΩÔºö
         * 1. ÊòæÁ§∫ÊÄª‰∫∫Êï∞
         * 2. ÊòæÁ§∫Â∑≤‰∏≠Â•ñ‰∫∫Êï∞
         * 3. ÊòæÁ§∫Ââ©‰ΩôÊú™‰∏≠Â•ñ‰∫∫Êï∞
         * 
         * @returns {void}
         */
        function renderStats() {
            const total = appState.people.length;
            const won = appState.people.filter(p => p.prize).length;
            
            // ‰ΩøÁî® textContent ÈÅøÂÖç XSS ÊîªÂáª
            document.getElementById('total-count').textContent = total;
            document.getElementById('won-count').textContent = won;
            document.getElementById('remain-count').textContent = total - won;
        }

        /**
         * Ê∏≤ÊüìÂ•ñÈ°πÂàóË°®
         * 
         * ÂäüËÉΩÔºö
         * 1. ÊòæÁ§∫ÊâÄÊúâÂ•ñÈ°π
         * 2. ÊòæÁ§∫Â•ñÈ°πÁä∂ÊÄÅÔºàÂ∑≤ÊäΩÂèñ/ÂæÖÊäΩÂèñÔºâ
         * 3. ÊòæÁ§∫‰∏≠Â•ñËÄÖÂêçÂçï
         * 4. ÊîØÊåÅÈÄâÊã©Â•ñÈ°πËøõË°åÊäΩÂ•ñ
         * 
         * ÈÄâÊã©ÈÄªËæëÔºö
         * - Âè™ËÉΩÈÄâÊã©Á¨¨‰∏Ä‰∏™Êú™ÊäΩÂèñÁöÑÂ•ñÈ°π
         * - Â∑≤ÊäΩÂèñÁöÑÂ•ñÈ°π‰∏çÂèØÁÇπÂáª
         * - ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ•ñÈ°πÈ´ò‰∫ÆÊòæÁ§∫
         * 
         * ÊÄßËÉΩ‰ºòÂåñÔºö
         * - ‰ΩøÁî® DocumentFragment ÂáèÂ∞ë DOM Êìç‰Ωú
         * - ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÊõø‰ª£ÊØè‰∏™ÂÖÉÁ¥†ÁªëÂÆö‰∫ã‰ª∂
         * 
         * @returns {void}
         */
        function renderPrizes() {
            const container = document.getElementById('prize-list');
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            if (prizes.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="icon">üèÜ</div>
                    <p>ÊöÇÊó†Â•ñÈ°π</p>
                `;
                container.appendChild(emptyState);
                return;
            }

            const firstUnawardedIndex = prizes.findIndex(p => !p.awarded);
            const fragment = document.createDocumentFragment();

            prizes.forEach((prize, index) => {
                const winners = people.filter(p => p.prize === prize.name);
                const isClickable = !prize.awarded && (index === firstUnawardedIndex || currentPrizeIndex === index);
                
                const prizeItem = document.createElement('div');
                prizeItem.className = `prize-item ${prize.awarded ? 'disabled' : ''} ${!isClickable && !prize.awarded ? 'unselectable' : ''} ${currentPrizeIndex === index ? 'active' : ''}`;
                prizeItem.style.borderLeftColor = prize.color;
                
                if (isClickable) {
                    prizeItem.onclick = () => selectPrize(index);
                }

                prizeItem.innerHTML = `
                    <div class="name" style="color: ${prize.color}">${prize.name}</div>
                    <div class="desc">${prize.desc}</div>
                    <div class="info">
                        <span>üë§ ${prize.count}‰∫∫</span>
                        <span class="status ${prize.awarded ? 'awarded' : ''}">${prize.awarded ? 'Â∑≤ÊäΩÂèñ' : 'ÂæÖÊäΩÂèñ'}</span>
                    </div>
                    ${winners.length > 0 ? `<div class="desc" style="margin-top:8px;color:#feca57;">‰∏≠Â•ñ: ${winners.map(w => w.name).join('„ÄÅ')}</div>` : ''}
                `;

                fragment.appendChild(prizeItem);
            });

            container.appendChild(fragment);
        }

        function selectPrize(index) {
            if (prizes[index].awarded) return;
            if (currentPrizeIndex === index) {
                currentPrizeIndex = null;
            } else {
                currentPrizeIndex = index;
            }
            renderPrizes();
        }

        /**
         * Ê∏≤Êüì‰∫∫ÂëòÂàóË°®
         * 
         * ÂäüËÉΩÔºö
         * 1. ÊòæÁ§∫ÊâÄÊúâ‰∫∫ÂëòÁöÑÁ∫¢ÂåÖÂç°Áâá
         * 2. ÊòæÁ§∫‰∏≠Â•ñÁä∂ÊÄÅ
         * 3. ÊîØÊåÅÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ
         * 
         * ÊÄßËÉΩ‰ºòÂåñÔºö
         * - ‰ΩøÁî® DocumentFragment ÂáèÂ∞ë DOM Êìç‰Ωú
         * - ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÊõø‰ª£ÊØè‰∏™ÂÖÉÁ¥†ÁªëÂÆö‰∫ã‰ª∂
         * - ‰ΩøÁî® DocumentFragment ÊâπÈáèÊèíÂÖ•
         * 
         * @returns {void}
         */
        function renderPeople() {
            const container = document.getElementById('people-grid');
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            if (people.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="icon">üë•</div>
                    <p>ÊöÇÊó†‰∫∫ÂëòÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠Ê∑ªÂä†</p>
                `;
                container.appendChild(emptyState);
                return;
            }

            // ‰ΩøÁî® DocumentFragment ÊâπÈáèÊèíÂÖ•
            const fragment = document.createDocumentFragment();

            people.forEach((person, index) => {
                const won = !!person.prize;
                const packet = document.createElement('div');
                packet.className = `red-packet ${won ? 'won' : ''}`;
                packet.title = person.name;
                packet.dataset.index = index;

                if (won) {
                    packet.innerHTML = `
                        <div class="face front">
                            <span class="won-prize">${person.prize}</span>
                            <span class="won-name">${person.name}</span>
                        </div>
                        <div class="face back"><span class="name">${person.name}</span></div>
                    `;
                } else {
                    packet.innerHTML = `
                        <div class="face front">
                            <span class="front-name" style="visibility:hidden"></span>
                        </div>
                        <div class="face back"><span class="name">${person.name}</span></div>
                    `;
                }

                fragment.appendChild(packet);
            });

            container.appendChild(fragment);

            // ÈáçÊñ∞ËÆ°ÁÆóÂ∞∫ÂØ∏/Â∏ÉÂ±Ä
            setTimeout(() => adjustPacketSize(), 0);
        }

        function adjustPacketSize() {
            // ÁõÆÊ†áÔºöÊ†πÊçÆÊÄªÊï∞ÈáèÂä®ÊÄÅÂàÜÈÖçÁ∫¢ÂåÖÂ§ßÂ∞èÔºåÁ°Æ‰øùÈì∫Êª°Â¢ôÈù¢‰∏îÁõ∏ÈÇª‰∏çÈáçÂè†
            const container = document.getElementById('people-grid');
            if (!container || people.length === 0) return;

            const W = container.clientWidth;
            const H = container.clientHeight;
            const N = people.length;
            const gap = 15; // Á∫¢ÂåÖ‰πãÈó¥ÁöÑÈó¥Ë∑ù

            // Á©∑‰∏æÊâÄÊúâÂèØËÉΩÁöÑÂàóÊï∞ÔºåÈÄâÊã©ËÉΩËÆ©Âçï‰∏™Á∫¢ÂåÖÊúÄÂ§ß‰∏îËÉΩÊîæ‰∏ãÊâÄÊúâÁ∫¢ÂåÖÁöÑÁªÑÂêà
            let best = { cols: 1, size: 40 };
            for (let c = 1; c <= Math.min(N, 100); c++) {
                const r = Math.ceil(N / c);
                const sX = (W - (c + 1) * gap) / c;
                const sY = (H - (r + 1) * gap) / r;
                const s = Math.min(sX, sY);
                if (s > best.size) best = { cols: c, size: s };
            }
            const cols = best.cols;
            const cellSize = Math.max(20, best.size); // Èò≤Ê≠¢ËøáÂ∞è

            container.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;
            container.style.gridColumnGap = `${gap}px`;
            container.style.gridRowGap = `${gap}px`;

            const packets = container.querySelectorAll('.red-packet');
            packets.forEach(p => {
                p.style.width = cellSize + 'px';
                p.style.height = cellSize + 'px';
                p.style.borderRadius = Math.max(4, cellSize * 0.12) + 'px';
                p.style.margin = '0';
            });

            // Ë∞ÉÊï¥ÂÜÖÈÉ®ÊñáÂ≠óÂíåÂõæÂΩ¢Â∞∫ÂØ∏
            const nameSize = Math.max(8, cellSize * 0.18);
            const circleSize = cellSize * 0.42;
            const fontSize = Math.max(10, cellSize * 0.32);
            const wonPrizeSize = Math.max(6, cellSize * 0.14);
            const wonNameSize = Math.max(7, cellSize * 0.16);

            const existing = document.getElementById('packet-dynamic-styles');
            if (existing) existing.remove();
            const styleEl = document.createElement('style');
            styleEl.id = 'packet-dynamic-styles';
            styleEl.textContent = `
                .red-packet::before { width: ${circleSize}px !important; height: ${circleSize}px !important; }
                .red-packet::after { font-size: ${fontSize}px !important; }
                .red-packet .name { font-size: ${nameSize}px !important; bottom: ${cellSize * 0.06}px !important; }
                .red-packet.won .won-prize { font-size: ${wonPrizeSize}px !important; }
                .red-packet.won .won-name { font-size: ${wonNameSize}px !important; }
            `;
            document.head.appendChild(styleEl);
        }

        window.addEventListener('resize', () => {
            if (people.length > 0) {
                setTimeout(adjustPacketSize, 100);
            }
        });

        // ÈöèÊú∫ÁªôÊú™‰∏≠Â•ñÁöÑÁ∫¢ÂåÖÂä†‰∏Ä‰∏™ÁøªÂä®ÊïàÊûúÔºåÂ¢ûÂä†‰∫íÂä®ÊÑü
        function randomFlipNonWon() {
            if (isLotteryRunning) return;
            const candidates = Array.from(document.querySelectorAll('.red-packet:not(.won):not(.is-flipped)'));
            if (candidates.length === 0) return;
            const flipCount = 3 + Math.floor(Math.random() * 2); // 3 Êàñ 4
            for (let i = 0; i < flipCount; i++) {
                const el = candidates[Math.floor(Math.random() * candidates.length)];
                if (el && !el.classList.contains('is-flipped')) {
                    el.classList.add('is-flipped');
                    setTimeout(() => {
                        if (el && el.classList) {
                            el.classList.remove('is-flipped');
                        }
                    }, 1500);
                }
            }
        }
        // Ë∞ÉÊï¥ÁøªÂä®ËäÇÂ•èÔºöÁ®çÊÖ¢‰∏Ä‰∫õÔºåÊï∞Èáè‰πüÂ¢ûÂ§ö
        // Ê∏ÖÁêÜ‰πãÂâçÁöÑÂÆöÊó∂Âô®ÔºåÈÅøÂÖçÈáçÂ§ç
        if (flipIntervalId) {
            clearInterval(flipIntervalId);
            flipIntervalId = null;
        }
        flipIntervalId = setInterval(randomFlipNonWon, 1800);

        function showPersonInfo(index) {
            const person = people[index];
            alert(person.prize ? `${person.name}\nÂ∑≤‰∏≠Â•ñ: ${person.prize}` : `${person.name}\nÁä∂ÊÄÅ: ÂæÖÊäΩÂ•ñ`);
        }

        function togglePrizePanel() {
            document.getElementById('prize-panel').classList.toggle('active');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function addPrize() {
            const name = document.getElementById('prize-name').value.trim();
            const desc = document.getElementById('prize-desc').value.trim();
            const count = parseInt(document.getElementById('prize-count').value);
            const color = document.getElementById('prize-color').value;

            if (!name) { alert('ËØ∑ËæìÂÖ•Â•ñÈ°πÂêçÁß∞'); return; }

            prizes.push({ id: Date.now(), name, desc, count, color, awarded: false });
            saveData();
            renderPrizes();
            updateLotteryButton();

            document.getElementById('setting-prize-name').value = '';
            document.getElementById('setting-prize-desc').value = '';
            document.getElementById('setting-prize-count').value = '1';
            showToast('Â•ñÈ°πÊ∑ªÂä†ÊàêÂäü', 'success');
        }

        function addPrizeFromSettings() {
            const name = document.getElementById('setting-prize-name').value.trim();
            const desc = document.getElementById('setting-prize-desc').value.trim();
            const count = parseInt(document.getElementById('setting-prize-count').value);
            const color = document.getElementById('setting-prize-color').value;

            if (!name) { alert('ËØ∑ËæìÂÖ•Â•ñÈ°πÂêçÁß∞'); return; }

            const duplicatePrize = prizes.find(p => p.name.toLowerCase() === name.toLowerCase());
            if (duplicatePrize) {
                alert('Â•ñÈ°πÂêçÁß∞Â∑≤Â≠òÂú®ÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñÂêçÁß∞');
                return;
            }

            prizes.push({ id: Date.now(), name, desc, count, color, awarded: false });
            saveData();
            renderPrizes();

            document.getElementById('setting-prize-name').value = '';
            document.getElementById('setting-prize-desc').value = '';
            document.getElementById('setting-prize-count').value = '1';
            alert('Â•ñÈ°πÊ∑ªÂä†ÊàêÂäü');
        }

        function clearPrizes() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂ•ñÈ°πÂêóÔºü‰∏≠Â•ñËÆ∞ÂΩïÂ∞Ü‰∏ÄÂπ∂Ê∏ÖÈô§')) {
                appState.prizes = [];
                appState.people.forEach(p => p.prize = null);
                appState.currentPrizeIndex = null;
                
                // Êõ¥Êñ∞ÂÖºÂÆπÊÄßÂèòÈáè
                prizes = appState.prizes;
                currentPrizeIndex = appState.currentPrizeIndex;
                
                saveData();
                renderAll();
                showToast('Â•ñÈ°πÂ∑≤Ê∏ÖÁ©∫', 'success');
            }
        }

        function startLottery() {
            console.log('ÂºÄÂßãÊäΩÂ•ñÊåâÈíÆË¢´ÁÇπÂáª');
            let prize;
            let prizeIndex;
            if (currentPrizeIndex !== null) {
                prize = prizes[currentPrizeIndex];
                prizeIndex = currentPrizeIndex;
            } else {
                const availablePrizes = prizes.filter(p => !p.awarded);
                console.log('ÂèØÁî®Â•ñÈ°πÊï∞Èáè:', availablePrizes.length);
                if (availablePrizes.length === 0) { 
                    showToast('ÊâÄÊúâÂ•ñÈ°πÈÉΩÂ∑≤ÊäΩÂèñÂÆåÊØïÔºÅ', 'warning');
                    return; 
                }
                prizeIndex = prizes.findIndex(p => !p.awarded);
                prize = prizes[prizeIndex];
            }

            const availablePeople = people.filter(p => !p.prize);
            console.log('ÂèØÁî®‰∫∫ÂëòÊï∞Èáè:', availablePeople.length);
            if (availablePeople.length === 0) { 
                showToast('Ê≤°ÊúâÂèØÊäΩÂ•ñÁöÑ‰∫∫Âëò‰∫ÜÔºÅ', 'warning');
                return; 
            }

            // ÈöêËóè‰∏ªÊäΩÂ•ñÊåâÈíÆÔºåÊòæÁ§∫ÊöÇÂÅúÊåâÈíÆ
            const btn = document.getElementById('lottery-btn');
            btn.style.visibility = 'hidden';
            
            const pauseBtn = document.getElementById('pause-btn');
            pauseBtn.style.display = 'block';
            pauseBtn.textContent = '‚è∏ ÊöÇÂÅú';
            pauseBtn.classList.remove('paused');

            isLotteryRunning = true;
            isPaused = false;

            console.log('ÊäΩÂ•ñÊ®°ÂºèÂàáÊç¢:', settings.lotteryMode);
            if (settings.lotteryMode === 'slide') {
                showSlideAnimation(availablePeople, prize);
            } else {
                showGatherAnimation(availablePeople, prize);
            }
        }

        function showSlideAnimation(availablePeople, prize) {
            // ÊñπÂùóÊªëÂä®ÊäΩÂ•ñÊ®°Âºè
            const wall = document.getElementById('people-grid');
            const wallRect = wall.getBoundingClientRect();
            const cols = Math.max(3, Math.floor(wallRect.width / 60));
            
            // Ëé∑ÂèñÊâÄÊúâÁ∫¢ÂåÖ‰ΩçÁΩÆ
            const packets = wall.querySelectorAll('.red-packet:not(.won)');
            const packetRects = [];
            packets.forEach(p => {
                const rect = p.getBoundingClientRect();
                packetRects.push({
                    element: p,
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2,
                    id: p.querySelector('.name')?.textContent
                });
            });
            
            if (packetRects.length === 0) {
                alert('Ê≤°ÊúâÂèØÊäΩÂ•ñÁöÑ‰∫∫Âëò‰∫ÜÔºÅ');
                return;
            }
            
            // ÂàõÂª∫ÊªëÂä®Â±Ç
            let slideLayer = document.getElementById('slide-layer');
            if (!slideLayer) {
                slideLayer = document.createElement('div');
                slideLayer.id = 'slide-layer';
                slideLayer.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1000;';
                document.body.appendChild(slideLayer);
            }
            slideLayer.innerHTML = '';
            slideLayer.style.pointerEvents = 'auto';
            
            // ÂàõÂª∫ÊåâÈíÆÂÆπÂô®ÔºàÂ±Ö‰∏≠Ôºâ
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:20px;z-index:1001;';
            slideLayer.appendChild(btnContainer);
            
            // ÂàõÂª∫ÂÅúÊ≠¢ÊåâÈíÆ
            const stopBtn = document.createElement('button');
            stopBtn.id = 'slide-stop-btn';
            stopBtn.textContent = '‚èπ ÂÅúÊ≠¢Âπ∂Êè≠Êôì';
            stopBtn.style.cssText = 'padding:15px 35px;font-size:18px;font-weight:bold;background:linear-gradient(135deg, #1dd1a1, #10ac84);color:#fff;border:none;border-radius:50px;cursor:pointer;box-shadow:0 4px 15px rgba(29,209,161,0.4);transition:all 0.3s ease;';
            stopBtn.onmouseover = () => stopBtn.style.transform = 'scale(1.05)';
            stopBtn.onmouseout = () => stopBtn.style.transform = 'scale(1)';
            btnContainer.appendChild(stopBtn);
            
            // ÂàõÂª∫ÂèñÊ∂àÊåâÈíÆ
            const cancelBtn = document.createElement('button');
            cancelBtn.id = 'slide-cancel-btn';
            cancelBtn.textContent = '‚ùå ÂèñÊ∂à';
            cancelBtn.style.cssText = 'padding:15px 35px;font-size:18px;font-weight:bold;background:linear-gradient(135deg, #ff6b6b, #ee5a5a);color:#fff;border:none;border-radius:50px;cursor:pointer;box-shadow:0 4px 15px rgba(255,107,107,0.4);transition:all 0.3s ease;';
            cancelBtn.onmouseover = () => cancelBtn.style.transform = 'scale(1.05)';
            cancelBtn.onmouseout = () => cancelBtn.style.transform = 'scale(1)';
            btnContainer.appendChild(cancelBtn);
            
            // ÂèñÊ∂àÊäΩÂ•ñÂäüËÉΩ
            window.cancelSlide = () => {
                if (!sliding) return;
                sliding = false;
                clearInterval(slideInterval);
                
                // Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫ÆÊïàÊûú
                if (lastHighlightedPacket && lastHighlightedPacket.element) {
                    lastHighlightedPacket.element.classList.remove('slide-highlight');
                }
                packetRects.forEach(packet => {
                    if (packet.element) {
                        packet.element.classList.remove('slide-highlight');
                    }
                });
                
            // Ê∏ÖÁêÜÊªëÂä®Â±Ç
            slideLayer.style.pointerEvents = 'none';
            slideLayer.innerHTML = '';
            
            // Ê∏ÖÁêÜÂÆöÊó∂Âô®
            if (pauseIntervalId) {
                clearInterval(pauseIntervalId);
                pauseIntervalId = null;
            }
            
            // ÊòæÁ§∫‰∏ªÊäΩÂ•ñÊåâÈíÆ
            const lotteryBtn = document.getElementById('lottery-btn');
            lotteryBtn.style.visibility = 'visible';
            isLotteryRunning = false;
            isPaused = false;
            
            // ÈöêËóèÊöÇÂÅúÊåâÈíÆ
            const pauseBtn = document.getElementById('pause-btn');
            pauseBtn.style.display = 'none';
            
            showToast('Â∑≤ÂèñÊ∂àÊäΩÂ•ñ', 'info');
        };
            
            cancelBtn.onclick = window.cancelSlide;
            
            // ÂàõÂª∫ÊªëÂä®ÊñπÂùó
            const tileCount = Math.min(prize.count, availablePeople.length);
            const tiles = [];
            for (let i = 0; i < tileCount; i++) {
                const tile = document.createElement('div');
                tile.className = 'slide-tile';
                tile.style.cssText = 'position:fixed;width:50px;height:50px;background:linear-gradient(145deg, #ffd700, #ff8c00);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#c0392b;font-size:14px;box-shadow:0 4px 15px rgba(255,215,0,0.5);z-index:1000;transform:translate3d(-100px,-100px,0);transition:transform 0.1s ease;';
                tile.innerHTML = 'üéØ';
                slideLayer.appendChild(tile);
                tiles.push({ element: tile, currentTarget: null });
            }
            
            // ÊªëÂä®Âä®Áîª
            let sliding = true;
            let lastHighlightedPacket = null;

            // ‰øùÂ≠òÂä®ÁîªÊï∞ÊçÆÁî®‰∫éÊöÇÂÅú/ÊÅ¢Â§ç
            currentAnimationData = {
                availablePeople,
                prize,
                tiles,
                packetRects,
                slideInterval: null
            };

            const slideInterval = setInterval(() => {
                if (!sliding) return;

                tiles.forEach(tileObj => {
                    // ÈöèÊú∫ÈÄâÊã©ÁõÆÊ†áÁ∫¢ÂåÖ‰ΩçÁΩÆ
                    const randomPacket = packetRects[Math.floor(Math.random() * packetRects.length)];
                    tileObj.currentTarget = randomPacket;

                    // ÁßªÈô§‰∏ä‰∏Ä‰∏™È´ò‰∫Æ
                    if (lastHighlightedPacket && lastHighlightedPacket.element) {
                        lastHighlightedPacket.element.classList.remove('slide-highlight');
                    }

                    // È´ò‰∫ÆÂΩìÂâçÁ∫¢ÂåÖ
                    if (randomPacket.element) {
                        randomPacket.element.classList.add('slide-highlight');
                    }
                    lastHighlightedPacket = randomPacket;

                    tileObj.element.style.transform = `translate3d(${randomPacket.x - 25}px, ${randomPacket.y - 25}px, 0)`;
                });
            }, 80);
            
            currentAnimationData.slideInterval = slideInterval;
            
            // ÂÅúÊ≠¢Âπ∂Êè≠Êôì
            window.stopSlide = () => {
                if (!sliding) return;
                sliding = false;
                clearInterval(slideInterval);
                currentAnimationData.slideInterval = null;
                
                stopBtn.disabled = true;
                stopBtn.textContent = '‚è≥ Êè≠Êôì‰∏≠...';

                // Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫ÆÊïàÊûú
                if (lastHighlightedPacket && lastHighlightedPacket.element) {
                    lastHighlightedPacket.element.classList.remove('slide-highlight');
                }
                packetRects.forEach(packet => {
                    if (packet.element) {
                        packet.element.classList.remove('slide-highlight');
                    }
                });

                // ÈáçÊñ∞Ëé∑ÂèñÊâÄÊúâÁ∫¢ÂåÖÁöÑÂΩìÂâç‰ΩçÁΩÆÔºàÈò≤Ê≠¢È°µÈù¢ÊªöÂä®Á≠âÂΩ±ÂìçÔºâ
                const currentPackets = wall.querySelectorAll('.red-packet:not(.won)');
                const currentPacketRects = [];
                currentPackets.forEach(p => {
                    const rect = p.getBoundingClientRect();
                    currentPacketRects.push({
                        element: p,
                        x: rect.left + rect.width / 2,
                        y: rect.top + rect.height / 2,
                        id: p.querySelector('.name')?.textContent
                    });
                });

                // ÁÆÄÂçïÈÄªËæëÔºöÊªëÂùóÊúÄÂêéÂÅúÊ≠¢Âú®Âì™‰∏™Á∫¢ÂåÖ‰∏äÔºåÂì™‰∏™Á∫¢ÂåÖÈáåÁöÑ‰∫∫Â∞±‰∏≠Â•ñ
                const winners = [];
                const winnerPackets = []; // ËÆ∞ÂΩïÊØè‰∏™ÊªëÂùóÂØπÂ∫îÁöÑÁ∫¢ÂåÖ

                // ‰∏∫ÊØè‰∏™ÊªëÂùóÊâæÂà∞ÊúÄËøëÁöÑÁ∫¢ÂåÖ
                tiles.forEach((tileObj, tileIndex) => {
                    // Ëé∑ÂèñÊªëÂùóÁöÑÂÆûÈôÖ‰ΩçÁΩÆ
                    const tileRect = tileObj.element.getBoundingClientRect();
                    const tileCenterX = tileRect.left + tileRect.width / 2;
                    const tileCenterY = tileRect.top + tileRect.height / 2;

                    // ÊâæÂà∞Ë∑ùÁ¶ªÊúÄËøëÁöÑÁ∫¢ÂåÖ
                    let closestPacket = null;
                    let minDistance = Infinity;

                    currentPacketRects.forEach((packet, packetIndex) => {
                        const distance = Math.sqrt(
                            Math.pow(tileCenterX - packet.x, 2) +
                            Math.pow(tileCenterY - packet.y, 2)
                        );
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestPacket = packet;
                        }
                    });

                    // ËÆ∞ÂΩïËøô‰∏™ÊªëÂùóÂØπÂ∫îÁöÑÁ∫¢ÂåÖ
                    winnerPackets.push(closestPacket);

                    // Ëøô‰∏™Á∫¢ÂåÖÈáåÁöÑ‰∫∫Â∞±ÊòØ‰∏≠Â•ñËÄÖ
                    if (closestPacket && closestPacket.id) {
                        const winner = availablePeople.find(p => p.name === closestPacket.id);
                        if (winner) {
                            winners.push(winner);
                        }
                    }
                });
                
                // Âª∂ËøüÂêéÊè≠ÊôìÁªìÊûú
                setTimeout(() => {
                    // ÈáçÊñ∞Ëé∑ÂèñÊâÄÊúâÁ∫¢ÂåÖÁöÑÂΩìÂâç‰ΩçÁΩÆ
                    const currentPackets = wall.querySelectorAll('.red-packet:not(.won)');
                    const currentPacketRects = [];
                    currentPackets.forEach(p => {
                        const rect = p.getBoundingClientRect();
                        currentPacketRects.push({
                            element: p,
                            x: rect.left + rect.width / 2,
                            y: rect.top + rect.height / 2,
                            id: p.querySelector('.name')?.textContent
                        });
                    });

                    // ‰∏∫ÊØè‰∏™‰∏≠Â•ñËÄÖ‰ΩøÁî®‰πãÂâçËÆ∞ÂΩïÁöÑÁ∫¢ÂåÖÊòæÁ§∫ÁªìÊûú
                    winners.forEach((winner, index) => {
                        const stoppedPacket = winnerPackets[index];

                        // È´ò‰∫ÆÂÅúÊ≠¢‰ΩçÁΩÆÁöÑÁ∫¢ÂåÖ‰∏∫‰∏≠Â•ñÁ∫¢ÂåÖ
                        if (stoppedPacket && stoppedPacket.element) {
                            stoppedPacket.element.classList.add('won');
                            // Êõ¥Êñ∞Ê≠£Èù¢ÊòæÁ§∫ÂßìÂêçÂíåÂ•ñÈ°π
                            const frontFace = stoppedPacket.element.querySelector('.front');
                            if (frontFace) {
                                frontFace.innerHTML = `<span class="won-prize">${prize.name}</span><span class="won-name">${winner.name}</span>`;
                            }
                        }

                        // Êõ¥Êñ∞ÊñπÂùóÊòæÁ§∫
                        const tileObj = tiles[index];
                        if (tileObj && tileObj.element) {
                            tileObj.element.innerHTML = `‚úÖ`;
                            tileObj.element.style.background = 'linear-gradient(145deg, #2ecc71, #27ae60)';
                        }

                        // Êõ¥Êñ∞‰∫∫ÂëòÊï∞ÊçÆ
                        const personIndex = people.findIndex(p => p.id === winner.id);
                        if (personIndex !== -1) {
                            people[personIndex].prize = prize.name;
                        }
                    });
                    
                    // Ê†áËÆ∞Â•ñÈ°πÂ∑≤ÂèëÊîæ
                    prize.awarded = true;
                    currentPrizeIndex = null;
                    
                    // ‰øùÂ≠òÊï∞ÊçÆ
                    saveData();
                    
                    // ÊòæÁ§∫‰∏≠Â•ñÂºπÁ™ó
                    setTimeout(() => {
                        renderAll();
                        showWinners(prize, winners);
                        
                        // Ê∏ÖÁêÜÊªëÂä®Â±Ç
                        setTimeout(() => {
                            slideLayer.style.pointerEvents = 'none';
                            slideLayer.innerHTML = '';
                        }, 500);
                        
                        // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                        const btn = document.getElementById('lottery-btn');
                        btn.disabled = false;
                        btn.textContent = 'üé∞ ÂºÄÂßãÊäΩÂ•ñ';
                        btn.classList.remove('running');
                        btn.style.visibility = 'visible';
                        isLotteryRunning = false;
                        isPaused = false;
                        
                        // ÈöêËóèÊöÇÂÅúÊåâÈíÆ
                        const pauseBtn = document.getElementById('pause-btn');
                        pauseBtn.style.display = 'none';
                        
                         // Ê∏ÖÁêÜÂÆöÊó∂Âô®
                         if (pauseIntervalId) {
                             clearInterval(pauseIntervalId);
                             pauseIntervalId = null;
                         }
                         
                         // Ê∏ÖÁêÜÊªëÂä®Âä®ÁîªÂÆöÊó∂Âô®
                         if (currentAnimationData.slideInterval) {
                             clearInterval(currentAnimationData.slideInterval);
                             currentAnimationData.slideInterval = null;
                         }
                        
                        showToast('ÊäΩÂ•ñÂÆåÊàêÔºÅ', 'success');
                    }, 300);
                }, 500);
            };
        }

        // ÊòæÁ§∫‰∏≠Â•ñÂºπÁ™ó
        function showWinners(prize, winners) {
            const modal = document.getElementById('winner-modal');
            document.getElementById('winner-prize').textContent = `„Äê${prize.name}„Äë${prize.desc}`;
            document.getElementById('winner-names').innerHTML = winners.map(w =>
                `<div class="winner-name">${w.name}</div>`
            ).join('');
            modal.classList.add('active');
        }

        // ÂÖ≥Èó≠‰∏≠Â•ñÂºπÁ™ó
        function closeWinnerModal() {
            const modal = document.getElementById('winner-modal');
            modal.classList.remove('active');
        }

        /**
         * ÂàáÊç¢ÂéÜÂè≤ËÆ∞ÂΩïÈù¢Êùø
         * 
         * ÂäüËÉΩÔºö
         * 1. ÊâìÂºÄ/ÂÖ≥Èó≠ÂéÜÂè≤ËÆ∞ÂΩïÈù¢Êùø
         * 2. Èù¢ÊùøÊâìÂºÄÊó∂Ëá™Âä®Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩï
         * 3. Èù¢ÊùøÂÖ≥Èó≠Êó∂Ê∏ÖÁêÜÂÜÖÂÆπ
         * 
         * @returns {void}
         */
        function toggleHistoryPanel() {
            const panel = document.getElementById('history-panel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                renderHistory();
            }
        }

        // ÂÖ≥Èó≠ÂéÜÂè≤ËÆ∞ÂΩïÈù¢Êùø
        function closeHistoryPanel() {
            const panel = document.getElementById('history-panel');
            panel.classList.remove('active');
        }

        /**
         * Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®
         * 
         * ÂäüËÉΩÔºö
         * 1. ÊòæÁ§∫ÊâÄÊúâÊäΩÂ•ñÂéÜÂè≤ËÆ∞ÂΩï
         * 2. ÊòæÁ§∫‰∏≠Â•ñËÄÖÂßìÂêç
         * 3. ÊòæÁ§∫ÊäΩÂ•ñÊó∂Èó¥
         * 4. ÊòæÁ§∫Êí§ÈîÄÁä∂ÊÄÅ
         * 5. Êèê‰æõÊí§ÈîÄÊåâÈíÆÔºàÊú™Êí§ÈîÄÁöÑËÆ∞ÂΩïÔºâ
         * 
         * Êï∞ÊçÆÊ†ºÂºèÔºö
         * {
         *   prizeName: string,      // Â•ñÈ°πÂêçÁß∞
         *   prizeDesc: string,      // Â•ñÈ°πÊèèËø∞
         *   winners: string[],      // ‰∏≠Â•ñËÄÖÂßìÂêçÊï∞ÁªÑ
         *   time: string,           // ÊäΩÂ•ñÊó∂Èó¥ÔºàISOÊ†ºÂºèÔºâ
         *   revoked: boolean        // ÊòØÂê¶Â∑≤Êí§ÈîÄ
         * }
         * 
         * ÊÄßËÉΩ‰ºòÂåñÔºö
         * - ‰ΩøÁî® DocumentFragment ÂáèÂ∞ë DOM Êìç‰Ωú
         * - ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÊõø‰ª£ÊØè‰∏™ÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
         * 
         * @returns {void}
         */
        function renderHistory() {
            const container = document.getElementById('history-list');
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            if (appState.history.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="icon">üìú</div>
                    <p>ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</p>
                `;
                container.appendChild(emptyState);
                return;
            }

            const fragment = document.createDocumentFragment();

            appState.history.forEach((item, index) => {
                const time = new Date(item.time).toLocaleString('zh-CN');
                const isRevoked = item.revoked;

                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${isRevoked ? 'revoked' : ''}`;

                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <span class="history-item-prize">${item.prizeName}</span>
                        <span class="history-item-time">${time}</span>
                    </div>
                    <div class="history-item-winners">
                        <strong>‰∏≠Â•ñËÄÖÔºö</strong>${item.winners.join('„ÄÅ')}
                        ${isRevoked ? ' <span style="color:#ff6b6b;">(Â∑≤Êí§ÈîÄ)</span>' : ''}
                    </div>
                    ${!isRevoked ? `
                        <div class="history-item-actions">
                            <button class="revoke-btn" data-index="${index}">Êí§ÈîÄ‰∏≠Â•ñ</button>
                        </div>
                    ` : ''}
                `;

                fragment.appendChild(historyItem);
            });

            container.appendChild(fragment);

            // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÊí§ÈîÄÊåâÈíÆÁÇπÂáª
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('revoke-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    revokeWinner(index);
                }
            });
        }

        /**
         * Êí§ÈîÄ‰∏≠Â•ñËÆ∞ÂΩï
         * 
         * ÂäüËÉΩÔºö
         * 1. Êí§ÈîÄÊåáÂÆöÁöÑ‰∏≠Â•ñËÆ∞ÂΩï
         * 2. ÊÅ¢Â§ç‰∏≠Â•ñ‰∫∫ÂëòÁöÑÊäΩÂ•ñËµÑÊ†º
         * 3. ÊÅ¢Â§çÂ•ñÈ°πÁöÑÊäΩÂ•ñËµÑÊ†º
         * 4. Ê†áËÆ∞ËÆ∞ÂΩï‰∏∫Â∑≤Êí§ÈîÄ
         * 5. ‰øùÂ≠òÊï∞ÊçÆÂπ∂Êõ¥Êñ∞UI
         * 
         * Êí§ÈîÄÈÄªËæëÔºö
         * 1. ÊâæÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
         * 2. Ê£ÄÊü•ÊòØÂê¶Â∑≤Êí§ÈîÄ
         * 3. ÈÅçÂéÜ‰∏≠Â•ñËÄÖÔºåÊÅ¢Â§çÊäΩÂ•ñËµÑÊ†º
         * 4. ÊÅ¢Â§çÂ•ñÈ°πÁä∂ÊÄÅ
         * 5. Ê†áËÆ∞ËÆ∞ÂΩï‰∏∫Â∑≤Êí§ÈîÄ
         * 6. ‰øùÂ≠òÊï∞ÊçÆ
         * 7. ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâÂÜÖÂÆπ
         * 
         * @param {number} historyIndex - ÂéÜÂè≤ËÆ∞ÂΩïÁ¥¢Âºï
         * @returns {void}
         */
        function revokeWinner(historyIndex) {
            if (!confirm('Á°ÆÂÆöË¶ÅÊí§ÈîÄËøô‰∏™‰∏≠Â•ñËÆ∞ÂΩïÂêóÔºü')) {
                return;
            }

            const record = history[historyIndex];
            if (record.revoked) {
                showToast('ËØ•ËÆ∞ÂΩïÂ∑≤Êí§ÈîÄ', 'warning');
                return;
            }

            // ÊÅ¢Â§ç‰∏≠Â•ñ‰∫∫ÂëòÁöÑÊäΩÂ•ñËµÑÊ†º
            record.winners.forEach(winnerName => {
                const personIndex = people.findIndex(p => p.name === winnerName);
                if (personIndex !== -1) {
                    people[personIndex].prize = null;
                }
            });

            // ÊÅ¢Â§çÂ•ñÈ°πÁöÑÊäΩÂ•ñËµÑÊ†º
            const prizeIndex = prizes.findIndex(p => p.name === record.prizeName);
            if (prizeIndex !== -1) {
                prizes[prizeIndex].awarded = false;
            }

            // Ê†áËÆ∞ËÆ∞ÂΩï‰∏∫Â∑≤Êí§ÈîÄ
            record.revoked = true;

            // ‰øùÂ≠òÊï∞ÊçÆ
            saveData();

            // ÈáçÊñ∞Ê∏≤Êüì
            renderAll();
            renderHistory();

            showToast('‰∏≠Â•ñËÆ∞ÂΩïÂ∑≤Êí§ÈîÄ', 'success');
        }
        }

        // ÂàáÊç¢ÊöÇÂÅúÁä∂ÊÄÅ
        function togglePause() {
            const pauseBtn = document.getElementById('pause-btn');
            
            if (!isPaused) {
                // ÊöÇÂÅú
                isPaused = true;
                pauseBtn.textContent = '‚ñ∂Ô∏è ÁªßÁª≠';
                pauseBtn.classList.add('paused');
                
                // Ê∏ÖÈô§Âä®Áîª
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                
                // Ê∏ÖÈô§ÂÆöÊó∂Âô®
                if (pauseIntervalId) {
                    clearInterval(pauseIntervalId);
                    pauseIntervalId = null;
                }
                
                 showToast('Â∑≤ÊöÇÂÅú', 'info');
             } else {
                 // ÁªßÁª≠
                 isPaused = false;
                 pauseBtn.textContent = '‚è∏ ÊöÇÂÅú';
                 pauseBtn.classList.remove('paused');
                 
                 // ÊÅ¢Â§çÂä®Áîª
                 if (currentAnimationData) {
                     if (settings.lotteryMode === 'slide') {
                         resumeSlideAnimation();
                     } else {
                         resumeGatherAnimation();
                     }
                 }
                 
                 showToast('Â∑≤ÁªßÁª≠', 'success');
             }
         }
 
         // ÊÅ¢Â§çÊªëÂùóÂä®Áîª
         function resumeSlideAnimation() {
             if (!currentAnimationData) return;
             
             const { availablePeople, prize, tiles, packetRects, slideInterval } = currentAnimationData;
             
             // Ê∏ÖÁêÜÊóßÁöÑÂÆöÊó∂Âô®
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // ÈáçÊñ∞ÂºÄÂßãÊªëÂä®Âä®Áîª
             pauseIntervalId = setInterval(() => {
                 if (isPaused) return;
                 
                 tiles.forEach(tileObj => {
                     // ÈöèÊú∫ÈÄâÊã©ÁõÆÊ†áÁ∫¢ÂåÖ‰ΩçÁΩÆ
                     const randomPacket = packetRects[Math.floor(Math.random() * packetRects.length)];
                     tileObj.currentTarget = randomPacket;
                    
                    tileObj.element.style.transform = `translate3d(${randomPacket.x - 25}px, ${randomPacket.y - 25}px, 0)`;
                });
            }, 80);
        }

        // ÊÅ¢Â§çÁêÉ‰ΩìÂä®Áîª
        function resumeGatherAnimation() {
            if (!currentAnimationData) return;
            
            const { availablePeople, prize } = currentAnimationData;
            
            // ÈáçÊñ∞ÂºÄÂßãÁêÉ‰ΩìÂä®Áîª
            showGatherAnimation(availablePeople, prize);
        }

         // ÊÅ¢Â§çÊªëÂùóÂä®Áîª
         function resumeSlideAnimation() {
             if (!currentAnimationData) return;
             
             const { availablePeople, prize, tiles, packetRects, slideInterval } = currentAnimationData;
             
             // Ê∏ÖÁêÜÊóßÁöÑÂÆöÊó∂Âô®
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // ÈáçÊñ∞ÂºÄÂßãÊªëÂä®Âä®Áîª
             pauseIntervalId = setInterval(() => {
                 if (isPaused) return;
                 
                 tiles.forEach(tileObj => {
                     // ÈöèÊú∫ÈÄâÊã©ÁõÆÊ†áÁ∫¢ÂåÖ‰ΩçÁΩÆ
                     const randomPacket = packetRects[Math.floor(Math.random() * packetRects.length)];
                     tileObj.currentTarget = randomPacket;
                     
                     tileObj.element.style.transform = `translate3d(${randomPacket.x - 25}px, ${randomPacket.y - 25}px, 0)`;
                 });
             }, 80);
         }
 
         // ÊÅ¢Â§çÁêÉ‰ΩìÂä®Áîª
         function resumeGatherAnimation() {
             if (!currentAnimationData) return;
             
             const { availablePeople, prize } = currentAnimationData;
             
             // Ê∏ÖÁêÜÊóßÁöÑÂÆöÊó∂Âô®
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // ÈáçÊñ∞ÂºÄÂßãÁêÉ‰ΩìÂä®Áîª
             showGatherAnimation(availablePeople, prize);
         }

        // Ê£ÄÊü•ÊµèËßàÂô®ÂÖºÂÆπÊÄß
        function checkCompatibility() {
            const warnings = [];

            // Ê£ÄÊü• localStorage
            if (!window.localStorage) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ LocalStorage');
            }

            // Ê£ÄÊü• CSS3 ÊîØÊåÅ
            const testDiv = document.createElement('div');
            if (!('transform' in testDiv.style)) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ CSS3 Transform');
            }

            if (!('backfaceVisibility' in testDiv.style)) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ backface-visibility');
            }

            // Ê£ÄÊü• ES6 ÊîØÊåÅ
            try {
                new Function('const test = () => {}');
            } catch (e) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ ES6 ËØ≠Ê≥ï');
            }

            if (warnings.length > 0) {
                const check = document.getElementById('compatibility-check');
                check.textContent = '‚ö†Ô∏è Ê£ÄÊµãÂà∞ÊµèËßàÂô®ÂÖºÂÆπÊÄßÈóÆÈ¢òÔºö' + warnings.join('„ÄÅ');
                check.classList.add('show');
                setTimeout(() => check.classList.remove('show'), 5000);
            }
        }

        // ÊòæÁ§∫Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí
        function showBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.add('show');
        }

        // ÂÖ≥Èó≠Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí
        function closeBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.remove('show');
        }

        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂ§á‰ªΩ
        function checkBackupNeeded() {
            // Â¶ÇÊûúÊúâÊï∞ÊçÆ‰∏îË∂ÖËøá7Â§©Êú™Â§á‰ªΩÔºåÊòæÁ§∫ÊèêÈÜí
            const lastBackup = localStorage.getItem('lastBackupTime');
            const now = Date.now();
            
            if (people.length > 0 || prizes.length > 0) {
                if (!lastBackup || (now - parseInt(lastBackup)) > 7 * 24 * 60 * 60 * 1000) {
                    setTimeout(() => showBackupReminder(), 2000);
                }
            }
        }

        // Ê∏≤ÊüìÂéÜÂè≤ËÆ∞ÂΩï
        function renderHistory() {
            const container = document.getElementById('history-list');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìú</div>
                        <p>ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.map((item, index) => {
                const time = new Date(item.time).toLocaleString('zh-CN');
                const isRevoked = item.revoked;
                
                return `
                    <div class="history-item ${isRevoked ? 'revoked' : ''}">
                        <div class="history-item-header">
                            <span class="history-item-prize">${item.prizeName}</span>
                            <span class="history-item-time">${time}</span>
                        </div>
                        <div class="history-item-winners">
                            <strong>‰∏≠Â•ñËÄÖÔºö</strong>${item.winners.join('„ÄÅ')}
                            ${isRevoked ? ' <span style="color:#ff6b6b;">(Â∑≤Êí§ÈîÄ)</span>' : ''}
                        </div>
                        ${!isRevoked ? `
                            <div class="history-item-actions">
                                <button class="revoke-btn" onclick="revokeWinner(${index})">Êí§ÈîÄ‰∏≠Â•ñ</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Êí§ÈîÄ‰∏≠Â•ñ
        function revokeWinner(historyIndex) {
            if (!confirm('Á°ÆÂÆöË¶ÅÊí§ÈîÄËøô‰∏™‰∏≠Â•ñËÆ∞ÂΩïÂêóÔºü')) {
                return;
            }

            const record = history[historyIndex];
            if (record.revoked) {
                showToast('ËØ•ËÆ∞ÂΩïÂ∑≤Êí§ÈîÄ', 'warning');
                return;
            }

            // ÊÅ¢Â§ç‰∏≠Â•ñ‰∫∫ÂëòÁöÑÊäΩÂ•ñËµÑÊ†º
            record.winners.forEach(winnerName => {
                const personIndex = people.findIndex(p => p.name === winnerName);
                if (personIndex !== -1) {
                    people[personIndex].prize = null;
                }
            });

            // ÊÅ¢Â§çÂ•ñÈ°πÁöÑÊäΩÂ•ñËµÑÊ†º
            const prizeIndex = prizes.findIndex(p => p.name === record.prizeName);
            if (prizeIndex !== -1) {
                prizes[prizeIndex].awarded = false;
            }

            // Ê†áËÆ∞ËÆ∞ÂΩï‰∏∫Â∑≤Êí§ÈîÄ
            record.revoked = true;

            // ‰øùÂ≠òÊï∞ÊçÆ
            saveData();

            // ÈáçÊñ∞Ê∏≤Êüì
            renderAll();
            renderHistory();

            showToast('‰∏≠Â•ñËÆ∞ÂΩïÂ∑≤Êí§ÈîÄ', 'success');
        }

        // Ê£ÄÊü•ÊµèËßàÂô®ÂÖºÂÆπÊÄß
        function checkCompatibility() {
            const warnings = [];

            // Ê£ÄÊü• localStorage
            if (!window.localStorage) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ LocalStorage');
            }

            // Ê£ÄÊü• CSS3 ÊîØÊåÅ
            const testDiv = document.createElement('div');
            if (!('transform' in testDiv.style)) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ CSS3 Transform');
            }

            if (!('backfaceVisibility' in testDiv.style)) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ backface-visibility');
            }

            // Ê£ÄÊü• ES6 ÊîØÊåÅ
            try {
                new Function('const test = () => {}');
            } catch (e) {
                warnings.push('ÊµèËßàÂô®‰∏çÊîØÊåÅ ES6 ËØ≠Ê≥ï');
            }

            if (warnings.length > 0) {
                const check = document.getElementById('compatibility-check');
                check.textContent = '‚ö†Ô∏è Ê£ÄÊµãÂà∞ÊµèËßàÂô®ÂÖºÂÆπÊÄßÈóÆÈ¢òÔºö' + warnings.join('„ÄÅ');
                check.classList.add('show');
                setTimeout(() => check.classList.remove('show'), 5000);
            }
        }

        // ÊòæÁ§∫Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí
        function showBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.add('show');
        }

        // ÂÖ≥Èó≠Êï∞ÊçÆÂ§á‰ªΩÊèêÈÜí
        function closeBackupReminder() {
            const reminder = document.getElementById('backup-reminder');
            reminder.classList.remove('show');
        }

        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂ§á‰ªΩ
        function checkBackupNeeded() {
            // Â¶ÇÊûúÊúâÊï∞ÊçÆ‰∏îË∂ÖËøá7Â§©Êú™Â§á‰ªΩÔºåÊòæÁ§∫ÊèêÈÜí
            const lastBackup = localStorage.getItem('lastBackupTime');
            const now = Date.now();
            
            if (appState.people.length > 0 || appState.prizes.length > 0) {
                if (!lastBackup || (now - parseInt(lastBackup)) > 7 * 24 * 60 * 60 * 1000) {
                    setTimeout(() => showBackupReminder(), 2000);
                }
            }
        }

        function showGatherAnimation(availablePeople, prize) {
            const container = document.getElementById('ball-container');
            const ball = document.getElementById('lottery-ball');
            container.classList.add('active');
            ball.innerHTML = '';
            ball.style.animation = 'none';
            ball.style.transform = 'rotateY(0deg)';

            // Ê∏ÖÁêÜ‰πãÂâçÁöÑÂä®Áîª
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            currentAnimationData = { availablePeople, prize };

            const count = availablePeople.length;
            if (count === 0) {
                alert('Ê≤°ÊúâÂèØÊäΩÂ•ñÁöÑ‰∫∫Âëò‰∫ÜÔºÅ');
                container.classList.remove('active');
                document.getElementById('lottery-btn').style.visibility = 'visible';
                return;
            }

            const radius = 380;
            const phi = Math.PI * (3 - Math.sqrt(5));

            for (let i = 0; i < count; i++) {
                const y = 1 - (i / (count - 1)) * 2;
                const radiusAtY = Math.sqrt(1 - y * y);
                const theta = phi * i;

                const x = Math.cos(theta) * radiusAtY * radius;
                const z = Math.sin(theta) * radiusAtY * radius;

                const item = document.createElement('div');
                item.className = 'ball-item gather';
                item.innerHTML = `<span class="name">${availablePeople[i].name}</span>`;
                item.dataset.theta = theta;
                item.dataset.yPos = y * radius;
                ball.appendChild(item);
            }

            setTimeout(() => {
                const items = ball.querySelectorAll('.ball-item');
                items.forEach((item, idx) => {
                    const x = parseFloat(Math.cos(item.dataset.theta) * Math.sqrt(1 - Math.pow(item.dataset.yPos / radius, 2)) * radius);
                    const y = parseFloat(item.dataset.yPos);
                    const z = parseFloat(Math.sin(item.dataset.theta) * Math.sqrt(1 - Math.pow(item.dataset.yPos / radius, 2)) * radius);
                    const theta = parseFloat(item.dataset.theta);

                    const angleX = 90;
                    const angleY = theta * (180 / Math.PI);

                    item.style.transform = `translate3d(${x}px, ${y}px, ${z}px) rotateX(${angleX}deg) rotateY(${angleY}deg)`;
                });
            }, 50);

            setTimeout(() => {
                ball.style.animation = 'rotateY 2s linear infinite';
            }, 1000);
        }

        function stopLottery() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            const ball = document.getElementById('lottery-ball');
            ball.style.animation = 'none';

            const { availablePeople, prize } = currentAnimationData;
            const winnerCount = Math.min(prize.count, availablePeople.length);
            const shuffled = [...availablePeople].sort(() => Math.random() - 0.5);
            const winners = shuffled.slice(0, winnerCount);

            winners.forEach(winner => {
                const index = people.findIndex(p => p.id === winner.id);
                if (index !== -1) people[index].prize = prize.name;
            });

            prize.awarded = true;
            history.unshift({
                prizeName: prize.name,
                prizeDesc: prize.desc,
                winners: winners.map(w => w.name),
                time: new Date().toISOString()
            });

            saveData();
            currentPrizeIndex = null;
            renderAll();

            document.getElementById('ball-container').classList.remove('active');

            setTimeout(() => {
                showWinners(prize, winners);
                launchFireworks();
            }, 300);

            const btn = document.getElementById('lottery-btn');
            btn.disabled = false;
            btn.textContent = 'üé∞ ÂºÄÂßãÊäΩÂ•ñ';
            btn.classList.remove('running');
            btn.style.visibility = 'visible';
            isLotteryRunning = false;
            isPaused = false;
            
             // ÈöêËóèÊöÇÂÅúÊåâÈíÆ
             const pauseBtn = document.getElementById('pause-btn');
             pauseBtn.style.display = 'none';
             
             // Ê∏ÖÁêÜÂÆöÊó∂Âô®
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // Ê∏ÖÁêÜÊªëÂä®Âä®ÁîªÂÆöÊó∂Âô®
             if (currentAnimationData && currentAnimationData.slideInterval) {
                 clearInterval(currentAnimationData.slideInterval);
                 currentAnimationData.slideInterval = null;
             }
             
             showToast('ÊäΩÂ•ñÂÆåÊàêÔºÅ', 'success');
        }

        function cancelLottery() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            const ball = document.getElementById('lottery-ball');
            ball.style.animation = 'none';

            document.getElementById('ball-container').classList.remove('active');

            const btn = document.getElementById('lottery-btn');
            btn.disabled = false;
            btn.textContent = 'üé∞ ÂºÄÂßãÊäΩÂ•ñ';
            btn.classList.remove('running');
            btn.style.visibility = 'visible';
            isLotteryRunning = false;
            isPaused = false;
            
             // ÈöêËóèÊöÇÂÅúÊåâÈíÆ
             const pauseBtn = document.getElementById('pause-btn');
             pauseBtn.style.display = 'none';
             
             // Ê∏ÖÁêÜÂÆöÊó∂Âô®
             if (pauseIntervalId) {
                 clearInterval(pauseIntervalId);
                 pauseIntervalId = null;
             }
             
             // Ê∏ÖÁêÜÊªëÂä®Âä®ÁîªÂÆöÊó∂Âô®
             if (currentAnimationData && currentAnimationData.slideInterval) {
                 clearInterval(currentAnimationData.slideInterval);
                 currentAnimationData.slideInterval = null;
             }
             
             showToast('Â∑≤ÂèñÊ∂àÊäΩÂ•ñ', 'info');
        }

        function showWinners(prize, winners) {
            const modal = document.getElementById('winner-modal');
            document.getElementById('winner-prize').textContent = `„Äê${prize.name}„Äë${prize.desc}`;
            document.getElementById('winner-names').innerHTML = winners.map(w =>
                `<div class="winner-name">${w.name}</div>`
            ).join('');
            modal.classList.add('active');
        }

        document.getElementById('winner-modal').addEventListener('click', (e) => {
            // Âè™ÊúâÁÇπÂáªÂºπÁ™óËÉåÊôØÔºàÈùûÂÜÖÂÆπÂå∫ÂüüÔºâÊâçÂÖ≥Èó≠
            if (e.target.id === 'winner-modal') {
                closeWinnerModal();
            }
        });

        function launchFireworks() {
            const container = document.getElementById('fireworks-container');
            const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#1dd1a1', '#ff6ff3'];

            for (let i = 0; i < 50; i++) {
                setTimeout(() => createFirework(container, colors), i * 100);
            }
        }

        function createFirework(container, colors) {
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight * 0.6;
            const color = colors[Math.floor(Math.random() * colors.length)];

            const center = document.createElement('div');
            center.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:8px;height:8px;background:${color};border-radius:50%;`;
            container.appendChild(center);

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                const angle = (Math.PI * 2 / 30) * i;
                const velocity = 80 + Math.random() * 120;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                particle.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:6px;height:6px;background:${color};border-radius:50%;animation:fireworkParticle 1s ease-out forwards;--tx:${tx}px;--ty:${ty}px;`;
                container.appendChild(particle);
            }

            setTimeout(() => {
                center.remove();
                container.querySelectorAll('[style*="fireworkParticle"]').forEach(p => p.remove());
            }, 1000);
        }

        const style = document.createElement('style');
        style.textContent = '@keyframes fireworkParticle {0%{transform:translate(0,0);opacity:1}100%{transform:translate(var(--tx),var(--ty));opacity:0}}';
        document.head.appendChild(style);

        function showSettings() { document.getElementById('settings-panel').classList.add('active'); }
        function closeSettings() { document.getElementById('settings-panel').classList.remove('active'); }

        function saveTitle() {
            const title = document.getElementById('setting-title').value.trim();
            settings.title = `üéâ ${title} üéä`;
            saveData();
            renderTitle();
            alert('Ê†áÈ¢òÂ∑≤‰øùÂ≠ò');
        }

        function addPeople() {
            const text = document.getElementById('add-people-text').value.trim();
            if (!text) { alert('ËØ∑ËæìÂÖ•ÂßìÂêç'); return; }
            const names = text.split('\n').map(n => n.trim()).filter(n => n);
            
            const existingNames = new Set(people.map(p => p.name.toLowerCase()));
            const uniqueNames = names.filter(n => !existingNames.has(n.toLowerCase()));
            const duplicateNames = names.filter(n => existingNames.has(n.toLowerCase()));
            
            if (uniqueNames.length === 0) {
                alert('ÊâÄÊúâÂßìÂêçÈÉΩÂ∑≤Â≠òÂú®');
                return;
            }
            
            const newPeople = uniqueNames.map(name => ({ id: Date.now() + Math.random(), name, prize: null }));
            people = [...people, ...newPeople];
            saveData();
            renderAll();
            document.getElementById('add-people-text').value = '';
            
            let msg = `ÊàêÂäüÊ∑ªÂä† ${newPeople.length} Âêç‰∫∫Âëò`;
            if (duplicateNames.length > 0) {
                msg += `\nË∑≥ËøáÈáçÂ§çÂßìÂêç: ${duplicateNames.join('„ÄÅ')}`;
            }
            showToast(msg, 'success');
        }

        function clearPeople() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâ‰∫∫ÂëòÂêóÔºü')) {
                appState.people = [];
                people = appState.people;
                saveData();
                renderAll();
                showToast('‰∫∫ÂëòÂ∑≤Ê∏ÖÁ©∫', 'success');
            }
        }

        function exportPeople() {
            downloadFile(people.map(p => p.name).join('\n'), '‰∫∫ÂëòÂêçÂçï.txt', 'text/plain');
        }

        function showImportModal() { document.getElementById('import-modal').classList.add('active'); }
        function closeImportModal() { document.getElementById('import-modal').classList.remove('active'); }
        function showImportAllModal() { document.getElementById('import-all-modal').classList.add('active'); }
        function closeImportAllModal() { document.getElementById('import-all-modal').classList.remove('active'); }

        document.getElementById('import-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const content = ev.target.result;
                    let names = [];
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(content);
                        names = Array.isArray(data) ? data.map(item => typeof item === 'string' ? item : item.name) : [];
                    } else {
                        names = content.split('\n').map(l => l.trim()).filter(l => l);
                    }
                    const newPeople = names.map(name => ({ id: Date.now() + Math.random(), name, prize: null }));
                    people = [...people, ...newPeople];
                    saveData();
                    renderAll();
                    showToast(`ÊàêÂäüÂØºÂÖ• ${newPeople.length} Âêç‰∫∫Âëò`, 'success');
                } catch (err) {
                    showToast('Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºö' + err.message, 'error', 5000);
                }
                closeImportModal();
            };
            reader.readAsText(file);
        });

        document.getElementById('import-all-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    people = data.people || [];
                    prizes = data.prizes || [];
                    history = data.history || [];
                    settings = data.settings || settings;
                    saveData();
                    renderAll();
                    showToast('ÈÖçÁΩÆÂØºÂÖ•ÊàêÂäü', 'success');
                } catch (err) {
                    showToast('ÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºèÈîôËØØÔºö' + err.message, 'error', 5000);
                }
                closeImportAllModal();
            };
            reader.readAsText(file);
        });

        function exportData() {
            exportAll();
        }

        function exportAll() {
            try {
                const data = {
                    people,
                    prizes,
                    history,
                    settings: {
                        title: settings.title,
                        background: settings.background,
                        lotteryMode: settings.lotteryMode
                    },
                    exportTime: new Date().toISOString()
                };
                downloadFile(JSON.stringify(data, null, 2), 'ÊäΩÂ•ñÁ≥ªÁªüÈÖçÁΩÆ.json', 'application/json');
                
                // Êõ¥Êñ∞Â§á‰ªΩÊó∂Èó¥
                localStorage.setItem('lastBackupTime', Date.now().toString());
                closeBackupReminder();
                showToast('ÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
            } catch (e) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', e);
                showToast('ÂØºÂá∫Â§±Ë¥•Ôºö' + e.message, 'error');
            }
        }

        function clearAll() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                appState.people = [];
                appState.prizes = [];
                appState.history = [];
                appState.settings = { title: 'üéâ Âπ¥‰ºöÊäΩÂ•ñÁ≥ªÁªü üéä', background: 'gradient1' };
                appState.currentPrizeIndex = null;
                
                // Êõ¥Êñ∞ÂÖºÂÆπÊÄßÂèòÈáè
                people = appState.people;
                prizes = appState.prizes;
                history = appState.history;
                settings = appState.settings;
                currentPrizeIndex = appState.currentPrizeIndex;
                
                saveData();
                renderAll();
                closeSettings();
                showToast('ÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫', 'success');
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Ëß¶Êë∏‰∫ã‰ª∂Â§ÑÁêÜ
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;

        function handleTouchStart(e) {
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            touchStartTime = Date.now();
        }

        function handleTouchMove(e) {
            // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÊªëÂä®ÈÄªËæë
        }

        function handleTouchEnd(e) {
            const touch = e.changedTouches[0];
            const touchEndX = touch.clientX;
            const touchEndY = touch.clientY;
            const touchEndTime = Date.now();
            const touchDuration = touchEndTime - touchStartTime;

            // ËÆ°ÁÆóÊªëÂä®Ë∑ùÁ¶ª
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

            // Â¶ÇÊûúÊªëÂä®Ë∑ùÁ¶ªÂ∞è‰∫é10pxÔºåËßÜ‰∏∫ÁÇπÂáª
            if (distance < 10) {
                return;
            }

            // Ê∞¥Âπ≥ÊªëÂä® - ÊâìÂºÄ/ÂÖ≥Èó≠Â•ñÈ°πÈù¢Êùø
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                const prizePanel = document.getElementById('prize-panel');
                if (deltaX > 0) {
                    // ÂêëÂè≥ÊªëÂä® - ÊâìÂºÄÈù¢Êùø
                    prizePanel.classList.add('active');
                } else {
                    // ÂêëÂ∑¶ÊªëÂä® - ÂÖ≥Èó≠Èù¢Êùø
                    prizePanel.classList.remove('active');
                }
            }

            // ÂûÇÁõ¥ÊªëÂä® - ÂàáÊç¢ËÉåÊôØ
            if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 50) {
                if (deltaY < 0) {
                    // Âêë‰∏äÊªëÂä® - ‰∏ã‰∏Ä‰∏™ËÉåÊôØ
                    cycleBackground(1);
                } else {
                    // Âêë‰∏ãÊªëÂä® - ‰∏ä‰∏Ä‰∏™ËÉåÊôØ
                    cycleBackground(-1);
                }
            }
        }

        function cycleBackground(direction) {
            const backgrounds = ['gradient1', 'gradient2', 'gradient3', 'gradient4', 'gradient5'];
            const currentIndex = backgrounds.indexOf(settings.background);
            let newIndex = currentIndex + direction;
            
            if (newIndex < 0) newIndex = backgrounds.length - 1;
            if (newIndex >= backgrounds.length) newIndex = 0;
            
            settings.background = backgrounds[newIndex];
            document.body.className = settings.background;
            saveData();
            showToast(`Â∑≤ÂàáÊç¢ËÉåÊôØ: ${newIndex + 1}/${backgrounds.length}`, 'info');
        }

        // ÈîÆÁõòÂø´Êç∑ÈîÆÂ§ÑÁêÜ
        function handleKeyDown(e) {
            // Â¶ÇÊûúÂú®ËæìÂÖ•Ê°Ü‰∏≠Ôºå‰∏çÂ§ÑÁêÜÂø´Êç∑ÈîÆ
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            e.preventDefault();

            switch (e.key) {
                case ' ':
                case 'Enter':
                    // Á©∫Ê†ºÊàñÂõûËΩ¶ - ÂºÄÂßã/ÂÅúÊ≠¢ÊäΩÂ•ñ
                    if (isLotteryRunning) {
                        stopLottery();
                    } else {
                        startLottery();
                    }
                    break;

                case 'Escape':
                    // ESC - ÂèñÊ∂àÊäΩÂ•ñ / ÂÖ≥Èó≠ÂºπÁ™ó / ÂÖ≥Èó≠Èù¢Êùø
                    if (isLotteryRunning) {
                        cancelLottery();
                    } else {
                        // ÂÖ≥Èó≠ÊâÄÊúâÈù¢ÊùøÂíåÂºπÁ™ó
                        closeWinnerModal();
                        closeSettings();
                        closeHistoryPanel();
                        closeBackupReminder();
                        document.getElementById('prize-panel').classList.remove('active');
                    }
                    break;

                case 'p':
                case 'P':
                    // P - ÊöÇÂÅú/ÁªßÁª≠
                    if (isLotteryRunning) {
                        togglePause();
                    }
                    break;

                case 'h':
                case 'H':
                    // H - ÊâìÂºÄ/ÂÖ≥Èó≠ÂéÜÂè≤ËÆ∞ÂΩï
                    toggleHistoryPanel();
                    break;

                case 'r':
                case 'R':
                    // R - Âà∑Êñ∞È°µÈù¢
                    if (confirm('Á°ÆÂÆöË¶ÅÂà∑Êñ∞È°µÈù¢ÂêóÔºüÊú™‰øùÂ≠òÁöÑÊï∞ÊçÆÂèØËÉΩ‰ºö‰∏¢Â§±„ÄÇ')) {
                        location.reload();
                    }
                    break;

                case 's':
                case 'S':
                    // S - ÊâìÂºÄËÆæÁΩÆÈù¢Êùø
                    showSettings();
                    break;

                case 'f':
                case 'F':
                    // F - ÂàáÊç¢ÂÖ®Â±è
                    toggleFullscreen();
                    break;

                case 'ArrowUp':
                    // ‰∏äÁÆ≠Â§¥ - ÂàáÊç¢‰∏ä‰∏Ä‰∏™ËÉåÊôØ
                    cycleBackground(-1);
                    break;

                case 'ArrowDown':
                    // ‰∏ãÁÆ≠Â§¥ - ÂàáÊç¢‰∏ã‰∏Ä‰∏™ËÉåÊôØ
                    cycleBackground(1);
                    break;

                case 'ArrowLeft':
                    // Â∑¶ÁÆ≠Â§¥ - ÂÖ≥Èó≠Â•ñÈ°πÈù¢Êùø
                    document.getElementById('prize-panel').classList.remove('active');
                    break;

                case 'ArrowRight':
                    // Âè≥ÁÆ≠Â§¥ - ÊâìÂºÄÂ•ñÈ°πÈù¢Êùø
                    document.getElementById('prize-panel').classList.add('active');
                    break;

                case '1':
                case '2':
                case '3':
                case '4':
                case '5':
                case '6':
                case '7':
                case '8':
                case '9':
                    // Êï∞Â≠óÈîÆ 1-9 - Âø´ÈÄüÈÄâÊã©Â•ñÈ°π
                    const index = parseInt(e.key) - 1;
                    if (prizes[index] && !prizes[index].awarded) {
                        currentPrizeIndex = index;
                        appState.currentPrizeIndex = index;
                        saveData();
                        renderPrizes();
                        showToast(`Â∑≤ÈÄâÊã©: ${prizes[index].name}`, 'info');
                    }
                    break;

                case 'd':
                case 'D':
                    // D - ÂØºÂá∫Êï∞ÊçÆ
                    exportData();
                    break;

                case 'i':
                case 'I':
                    // I - ÂØºÂÖ•Êï∞ÊçÆ
                    document.getElementById('import-file').click();
                    break;

                case 'e':
                case 'E':
                    // E - ÂØºÂá∫ÂÖ®ÈÉ®Êï∞ÊçÆ
                    exportAllData();
                    break;

                case 'c':
                case 'C':
                    // C - Ê∏ÖÁ©∫Êï∞ÊçÆ
                    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                        clearAll();
                    }
                    break;

                case 'm':
                case 'M':
                    // M - ÂàáÊç¢ÊäΩÂ•ñÊ®°Âºè
                    if (!isLotteryRunning) {
                        settings.lotteryMode = settings.lotteryMode === 'slide' ? 'ball' : 'slide';
                        appState.settings.lotteryMode = settings.lotteryMode;
                        saveData();
                        showToast(`Â∑≤ÂàáÊç¢Âà∞${settings.lotteryMode === 'slide' ? 'ÊñπÂùóÊªëÂä®' : '3DÁêÉ‰Ωì'}Ê®°Âºè`, 'info');
                    }
                    break;

                case '?':
                    // ? - ÊòæÁ§∫Âø´Êç∑ÈîÆÂ∏ÆÂä©
                    showKeyboardShortcuts();
                    break;
            }
        }

        // ÊòæÁ§∫ÈîÆÁõòÂø´Êç∑ÈîÆÂ∏ÆÂä©
        function showKeyboardShortcuts() {
            const shortcuts = `
ÈîÆÁõòÂø´Êç∑ÈîÆÂ∏ÆÂä©Ôºö

ÊäΩÂ•ñÊìç‰ΩúÔºö
  Á©∫Ê†º/Enter - ÂºÄÂßã/ÂÅúÊ≠¢ÊäΩÂ•ñ
  P - ÊöÇÂÅú/ÁªßÁª≠ÊäΩÂ•ñ
  ESC - ÂèñÊ∂àÊäΩÂ•ñ / ÂÖ≥Èó≠ÂºπÁ™ó
  M - ÂàáÊç¢ÊäΩÂ•ñÊ®°ÂºèÔºàÁêÉ‰Ωì/ÊªëÂä®Ôºâ

ÁïåÈù¢Êìç‰ΩúÔºö
  H - ÊâìÂºÄ/ÂÖ≥Èó≠ÂéÜÂè≤ËÆ∞ÂΩï
  S - ÊâìÂºÄËÆæÁΩÆÈù¢Êùø
  F - ÂàáÊç¢ÂÖ®Â±èÊ®°Âºè
  R - Âà∑Êñ∞È°µÈù¢
  ? - ÊòæÁ§∫Âø´Êç∑ÈîÆÂ∏ÆÂä©

ÂØºËà™Êìç‰ΩúÔºö
  ‚Üë - ÂàáÊç¢‰∏ä‰∏Ä‰∏™ËÉåÊôØ
  ‚Üì - ÂàáÊç¢‰∏ã‰∏Ä‰∏™ËÉåÊôØ
  ‚Üê - ÂÖ≥Èó≠Â•ñÈ°πÈù¢Êùø
  ‚Üí - ÊâìÂºÄÂ•ñÈ°πÈù¢Êùø

Êï∞ÊçÆÊìç‰ΩúÔºö
  1-9 - Âø´ÈÄüÈÄâÊã©Â•ñÈ°π
  D - ÂØºÂá∫ÈÖçÁΩÆÊï∞ÊçÆ
  E - ÂØºÂá∫ÂÖ®ÈÉ®Êï∞ÊçÆ
  I - ÂØºÂÖ•Êï∞ÊçÆ
  C - Ê∏ÖÁ©∫Êï∞ÊçÆ
            `;
            showToast(shortcuts, 'info', 8000);
        }

        document.querySelectorAll('.settings-panel').forEach(panel => {
            panel.addEventListener('click', (e) => {
                if (e.target === panel) panel.classList.remove('active');
            });
        });
    // showWinnersModal moved inside script
    function showWinnersModal(prize, winners) {
        const modal = document.getElementById('winner-modal');
        if (!modal) {
            alert('‰∏≠Â•ñ: ' + winners.map(w => w.name).join(', '));
            return;
        }
        modal.classList.add('active');
        const content = modal.querySelector('.winner-content');
        if (content) {
            const prizeNameEl = content.querySelector('.prize-name');
            if (prizeNameEl) prizeNameEl.textContent = prize.name;
            const namesEl = content.querySelector('.winner-names');
            if (namesEl) namesEl.innerHTML = winners.map(w => `<div class="winner-name">${w.name}</div>`).join('');
        }
    }
    </script>
    </body>
    </html>
